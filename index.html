<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Navigation Pro - Full Path</title>
    
    <!-- LIBRERÃAS A-FRAME y AR.JS -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js'></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
    <!-- LibrerÃ­a Look-at -->
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>

    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; font-family: sans-serif; }
        
        /* UI SUPERIOR */
        #top-ui {
            position: absolute;
            top: 0; left: 0; width: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            padding: 15px 0 25px 0;
            z-index: 999;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .row { display: flex; gap: 10px; justify-content: center; width: 95%; }
        
        input {
            padding: 12px;
            border-radius: 8px;
            border: none;
            width: 65%;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            outline: none;
        }

        select {
            padding: 10px;
            border-radius: 8px;
            border: none;
            background: white;
            font-weight: bold;
        }

        /* HUD DE INSTRUCCIONES */
        #instruction-panel {
            position: absolute;
            top: 90px;
            left: 5%;
            width: 90%;
            background: rgba(20, 20, 20, 0.9);
            color: #fff;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            display: none;
            z-index: 998;
            border-left: 6px solid #ffee00; /* Amarillo Taxi */
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        #instruction-text { font-size: 1.3rem; font-weight: 800; text-transform: uppercase; }
        #distance-text { font-size: 1rem; color: #ffee00; margin-top: 5px; font-weight: bold; }

        /* UI INFERIOR */
        #bottom-ui {
            position: absolute;
            bottom: 30px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
            z-index: 999;
        }

        .btn {
            border: none;
            border-radius: 50px;
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            cursor: pointer;
            transition: transform 0.1s;
            font-weight: bold;
        }
        .btn:active { transform: scale(0.90); }
        
        .btn-start { 
            padding: 15px 40px; 
            font-size: 18px; 
            background: linear-gradient(45deg, #28a745, #218838);
        }
        
        .btn-voice { 
            width: 60px; height: 60px; 
            font-size: 24px; 
            background: #333;
            display: flex; align-items: center; justify-content: center;
        }

        #gps-status {
            font-size: 11px;
            color: #00ff00;
            text-shadow: 1px 1px 2px black;
        }

        a-scene { display: block; width: 100%; height: 100%; }
    </style>
</head>

<body>

    <!-- INTERFAZ -->
    <div id="top-ui">
        <div class="row" style="justify-content: space-between; align-items: center;">
            <div id="gps-status">GPS: Esperando seÃ±al...</div>
            <select id="lang-select">
                <option value="es">ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
                <option value="en">ðŸ‡ºðŸ‡¸ English</option>
            </select>
        </div>
        <div class="row">
            <input type="text" id="destination-input" placeholder="Buscar destino...">
        </div>
    </div>

    <!-- Panel HUD -->
    <div id="instruction-panel">
        <div id="instruction-text">--</div>
        <div id="distance-text">-- m</div>
    </div>

    <div id="bottom-ui">
        <button id="btn-action" class="btn btn-start">IR / GO</button>
        <button id="btn-voice" class="btn btn-voice">ðŸ”Š</button>
    </div>

    <!-- ESCENA AR -->
    <a-scene
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; alpha: true;" 
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;">
        
        <!-- CÃ¡mara GPS -->
        <a-camera gps-camera="minDistance: 3; gpsMinDistance: 3;" rotation-reader></a-camera>

        <!-- Contenedor de ruta -->
        <a-entity id="route-container"></a-entity>
    </a-scene>

    <script>
        // --- CONFIGURACIÃ“N ---
        const MAPBOX_TOKEN = 'pk.eyJ1IjoiYW5keWc5NyIsImEiOiJjbWpwN20zcGoyYjFzM2ZveTIzZ2s5Mm56In0.FsNncSP8DrD6zTXpw0MaEg';
        
        let state = {
            lang: 'es',
            voice: true,
            loc: null, 
            navigating: false,
            steps: [] 
        };

        const texts = {
            es: {
                wait: "Esperando GPS (Sal afuera)...",
                calc: "Calculando ruta...",
                error: "Lugar no encontrado.",
                start: "INICIAR",
                arrived: "Â¡Has llegado!",
                voiceOn: "ðŸ”Š", voiceOff: "ðŸ”‡",
                placeholder: "Buscar destino (ej: Oxxo)"
            },
            en: {
                wait: "Waiting for GPS...",
                calc: "Calculating route...",
                error: "Location not found.",
                start: "START",
                arrived: "You arrived!",
                voiceOn: "ðŸ”Š", voiceOff: "ðŸ”‡",
                placeholder: "Search destination..."
            }
        };

        const ui = {
            status: document.getElementById('gps-status'),
            btnAction: document.getElementById('btn-action'),
            btnVoice: document.getElementById('btn-voice'),
            input: document.getElementById('destination-input'),
            lang: document.getElementById('lang-select'),
            panel: document.getElementById('instruction-panel'),
            instr: document.getElementById('instruction-text'),
            dist: document.getElementById('distance-text'),
            container: document.getElementById('route-container')
        };

        // --- IDIOMA ---
        ui.lang.addEventListener('change', (e) => {
            state.lang = e.target.value;
            ui.input.placeholder = texts[state.lang].placeholder;
            ui.btnAction.innerText = texts[state.lang].start;
        });

        // --- GPS ---
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(pos => {
                state.loc = [pos.coords.longitude, pos.coords.latitude];
                ui.status.innerText = `GPS: ${state.loc[1].toFixed(5)}, ${state.loc[0].toFixed(5)}`;
            }, err => {
                ui.status.innerText = "Error GPS: " + err.message;
            }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
        } else {
            alert("Navegador no compatible.");
        }

        // --- LÃ“GICA PRINCIPAL ---
        ui.btnAction.addEventListener('click', async () => {
            if (!state.loc) { alert(texts[state.lang].wait); return; }
            const query = ui.input.value;
            if (!query) return;

            speak(texts[state.lang].calc);
            ui.btnAction.innerText = "âŒ›";

            // 1. GEOCODING
            const geoUrl = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?proximity=${state.loc[0]},${state.loc[1]}&access_token=${MAPBOX_TOKEN}`;
            
            try {
                const res = await fetch(geoUrl);
                const data = await res.json();
                if (!data.features || !data.features.length) {
                    alert(texts[state.lang].error);
                    ui.btnAction.innerText = texts[state.lang].start;
                    return;
                }
                const destCoords = data.features[0].center;

                // 2. OBTENER RUTA
                getRoute(state.loc, destCoords);

            } catch (e) {
                console.error(e);
                alert("Error de conexiÃ³n.");
            }
        });

        async function getRoute(start, end) {
            // Pedimos geometria completa (full) para tener todos los puntos del camino
            const url = `https://api.mapbox.com/directions/v5/mapbox/walking/${start[0]},${start[1]};${end[0]},${end[1]}?steps=true&geometries=geojson&overview=full&access_token=${MAPBOX_TOKEN}`;
            const res = await fetch(url);
            const data = await res.json();
            
            if (data.routes && data.routes[0]) {
                const route = data.routes[0];
                state.steps = route.legs[0].steps;
                
                ui.container.innerHTML = '';
                
                // --- DIBUJAR TODO EL CAMINO CON FLECHAS ---
                drawContinuousPath(route.geometry.coordinates);
                
                // --- DIBUJAR PANELES DE GIRO ---
                drawTurnSignals(state.steps);

                ui.panel.style.display = 'block';
                ui.btnAction.innerText = "ðŸ”„";
                state.navigating = true;
                
                monitorProgress();
                speak(`${texts[state.lang].start}. ${Math.round(route.distance)} meters.`);
            }
        }

        // --- DIBUJO DE FLECHAS CONTINUAS ---
        function drawContinuousPath(coords) {
            // Recorremos las coordenadas. coords[i] es el punto actual, coords[i+1] es el siguiente
            for (let i = 0; i < coords.length - 1; i++) {
                
                // Solo dibujamos una flecha cada 2 o 3 puntos para no saturar la RAM del celular
                if (i % 2 !== 0) continue; 

                const curr = coords[i];
                const next = coords[i+1];

                // Calculamos el Ã¡ngulo hacia el siguiente punto
                const angle = calculateBearing(curr[1], curr[0], next[1], next[0]);

                // Entidad contenedora (Maneja la posiciÃ³n GPS)
                const entity = document.createElement('a-entity');
                entity.setAttribute('gps-new-entity-place', `latitude: ${curr[1]}; longitude: ${curr[0]}`);

                // Flecha visual (Cono aplastado y rotado)
                const arrow = document.createElement('a-cone');
                arrow.setAttribute('radius-bottom', '0.2');  // Parte trasera ancha
                arrow.setAttribute('radius-top', '0.01');    // Punta fina
                arrow.setAttribute('height', '0.8');         // Largo de la flecha
                arrow.setAttribute('material', 'color: #ffee00; opacity: 0.9;'); // Amarillo brillante
                
                // ROTACIÃ“N CLAVE:
                // 1. "rotation" en el eje Y (vertical) usa el Ã¡ngulo calculado (bearing)
                // 2. "rotation" en eje X (90) es para acostar el cono en el suelo
                // Pero en A-Frame anidado es mejor rotar el hijo.
                
                // Ajuste de rotaciÃ³n manual para alinear con el Norte geogrÃ¡fico
                // Nota: A veces AR.js requiere ajuste, pero matemÃ¡ticamente:
                entity.setAttribute('rotation', `0 ${angle} 0`); // Rota hacia el destino
                arrow.setAttribute('rotation', '-90 0 0'); // Acuesta el cono en el suelo
                arrow.setAttribute('position', '0 -1.5 0'); // A nivel del suelo (aprox)

                entity.appendChild(arrow);
                ui.container.appendChild(entity);
            }
        }

        // --- MATEMÃTICAS: CALCULAR RUMBO (BEARING) ---
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const toRad = (deg) => deg * Math.PI / 180;
            const toDeg = (rad) => rad * 180 / Math.PI;

            const Ï†1 = toRad(lat1);
            const Ï†2 = toRad(lat2);
            const Î”Î» = toRad(lon2 - lon1);

            const y = Math.sin(Î”Î») * Math.cos(Ï†2);
            const x = Math.cos(Ï†1) * Math.sin(Ï†2) -
                      Math.sin(Ï†1) * Math.cos(Ï†2) * Math.cos(Î”Î»);
            
            let Î¸ = Math.atan2(y, x);
            let bearing = (toDeg(Î¸) + 360) % 360;
            
            // Ajuste para A-Frame (El norte en 3D a veces varÃ­a segÃºn la librerÃ­a)
            // Generalmente AR.js alinea -Z con el Norte.
            return -bearing; 
        }

        // --- DIBUJO DE SEÃ‘ALES DE GIRO (HUD FLOTANTE) ---
        function drawTurnSignals(steps) {
            steps.forEach(step => {
                const lat = step.maneuver.location[1];
                const lon = step.maneuver.location[0];
                const instr = step.maneuver.instruction;

                // Solo dibujamos seÃ±al si es un giro importante
                if (step.maneuver.type === 'turn' || step.maneuver.type === 'arrive') {
                    const entity = document.createElement('a-entity');
                    entity.setAttribute('gps-new-entity-place', `latitude: ${lat}; longitude: ${lon}`);

                    // Texto Flotante Grande
                    const text = document.createElement('a-text');
                    text.setAttribute('value', instr);
                    text.setAttribute('color', '#fff');
                    text.setAttribute('align', 'center');
                    text.setAttribute('scale', '4 4 4');
                    text.setAttribute('position', '0 3 0'); // Muy alto para ver de lejos
                    text.setAttribute('look-at', '[gps-camera]'); // Siempre mira al usuario
                    text.setAttribute('background', 'color: black; opacity: 0.6');

                    // Poste Indicador (Cilindro vertical)
                    const post = document.createElement('a-cylinder');
                    post.setAttribute('height', '3');
                    post.setAttribute('radius', '0.1');
                    post.setAttribute('color', 'white');
                    post.setAttribute('position', '0 1.5 0');

                    entity.appendChild(post);
                    entity.appendChild(text);
                    ui.container.appendChild(entity);
                }
            });
        }

        // --- MONITORIZAR PROGRESO ---
        function monitorProgress() {
            if (!state.navigating) return;
            const check = setInterval(() => {
                if (!state.steps.length) { clearInterval(check); return; }
                
                const nextStep = state.steps[0];
                const stepLoc = nextStep.maneuver.location;
                const dist = getDistance(state.loc[1], state.loc[0], stepLoc[1], stepLoc[0]);
                
                ui.instr.innerText = nextStep.maneuver.instruction;
                ui.dist.innerText = Math.round(dist) + " m";

                if (dist < 10) {
                    speak(nextStep.maneuver.instruction);
                    state.steps.shift();
                    if (state.steps.length === 0) {
                        ui.instr.innerText = texts[state.lang].arrived;
                        speak(texts[state.lang].arrived);
                        state.navigating = false;
                    }
                }
            }, 2500);
        }

        // Haversine
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const dLat = (lat2-lat1) * Math.PI/180;
            const dLon = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        ui.btnVoice.addEventListener('click', () => {
            state.voice = !state.voice;
            ui.btnVoice.innerText = state.voice ? texts[state.lang].voiceOn : texts[state.lang].voiceOff;
            if(!state.voice) window.speechSynthesis.cancel();
        });

        function speak(txt) {
            if (!state.voice) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(txt);
            u.lang = state.lang === 'es' ? 'es-MX' : 'en-US';
            window.speechSynthesis.speak(u);
        }
    </script>
</body>
</html>
