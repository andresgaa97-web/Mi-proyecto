<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>AR Sistema de Gu√≠a - La Paz</title>

    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600&display=swap"
        rel="stylesheet">

    <!-- LIBRARIES -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script type='text/javascript'
        src='https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js'></script>
    <script type='text/javascript'
        src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

    <style>
        :root {
            --bg-dark: #0a0a12;
            --glass-panel: rgba(10, 10, 18, 0.85);
            --accent-cyan: #00f3ff;
            --accent-red: #ff2a2a;
            --text-main: #ffffff;
            --text-dim: #a0a0b0;
            --font-display: 'Orbitron', sans-serif;
            --font-body: 'Inter', sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            font-family: var(--font-body);
            overflow: hidden;
            color: var(--text-main);
        }

        /* === MAP VIEW UI === */
        #map-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 200;
            display: flex;
            flex-direction: column;
            background: var(--bg-dark);
            transition: opacity 0.5s ease;
        }

        #map {
            flex-grow: 1;
            width: 100%;
        }

        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0) 100%);
            z-index: 20;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .header-title {
            font-family: var(--font-display);
            font-size: 18px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--accent-cyan);
            text-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .route-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .mode-btn {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            text-align: center;
            text-transform: uppercase;
        }

        .mode-btn.active {
            background: var(--accent-cyan);
            color: black;
            box-shadow: 0 0 15px var(--accent-cyan);
            border-color: var(--accent-cyan);
        }

        .mode-btn.special {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .mode-btn.special.active {
            background: var(--accent-red);
            color: white;
            box-shadow: 0 0 15px var(--accent-red);
        }

        .info-pill {
            background: var(--glass-panel);
            color: var(--accent-cyan);
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-family: var(--font-display);
            border: 1px solid rgba(0, 243, 255, 0.3);
        }

        /* Floating Address Cards */
        .waypoint-list {
            margin-top: 5px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            max-height: 120px;
            overflow-y: auto;
        }

        .wp-tag {
            background: rgba(0, 0, 0, 0.6);
            border-left: 3px solid var(--accent-cyan);
            padding: 8px;
            font-size: 12px;
            border-radius: 0 4px 4px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .wp-tag.dest {
            border-color: var(--accent-red);
        }

        .wp-tag span {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            max-width: 85%;
        }

        .del-wp {
            color: #ff5555;
            background: none;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }

        /* Bottom Action Bar */
        .bottom-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            background: linear-gradient(0deg, rgba(0, 0, 0, 0.95) 0%, rgba(0, 0, 0, 0) 100%);
            z-index: 20;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .btn-main {
            width: 100%;
            background: var(--accent-cyan);
            color: black;
            border: none;
            padding: 18px;
            border-radius: 12px;
            font-family: var(--font-display);
            font-size: 16px;
            font-weight: 900;
            letter-spacing: 1px;
            text-transform: uppercase;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 20px rgba(0, 243, 255, 0.3);
            cursor: pointer;
        }

        .btn-main:active {
            transform: scale(0.98);
        }

        .btn-main:disabled {
            background: #333;
            color: #666;
            box-shadow: none;
            cursor: not-allowed;
        }

        .btn-share {
            background: transparent;
            color: var(--text-dim);
            border: 1px solid var(--text-dim);
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 12px;
            margin-top: -5px;
            cursor: pointer;
        }

        /* Center Pin */
        #center-pin {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -100%);
            z-index: 5;
            pointer-events: none;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #center-pin img {
            width: 40px;
            filter: drop-shadow(0 5px 10px rgba(0, 0, 0, 0.5));
        }

        .pin-lift {
            transform: translate(-50%, -140%) scale(1.1) !important;
        }

        /* === AR HUD === */
        #ar-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 300;
            display: none;
        }

        .hud-header {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
        }

        .nav-card {
            background: rgba(10, 10, 18, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 0 20px 0 20px;
            /* Cyber corner */
            border-left: 4px solid var(--accent-cyan);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            min-width: 150px;
        }

        .nav-dist {
            font-family: var(--font-display);
            font-size: 42px;
            color: var(--accent-cyan);
            line-height: 0.9;
        }

        .nav-unit {
            font-size: 14px;
            color: var(--text-dim);
            margin-left: 2px;
        }

        .nav-instr {
            font-size: 14px;
            margin-top: 5px;
            color: white;
            max-width: 200px;
        }

        .compass-ring {
            width: 60px;
            height: 60px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.4);
        }

        .compass-arrow {
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 20px solid var(--accent-red);
            transform-origin: center 50%;
        }

        .btn-exit {
            pointer-events: auto;
            background: var(--accent-red);
            color: white;
            border: none;
            padding: 10px 30px;
            border-radius: 30px;
            font-weight: bold;
            box-shadow: 0 5px 20px rgba(255, 42, 42, 0.4);
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
        }

        /* 3D Scene */
        a-scene {
            width: 100%;
            height: 100%;
            background: transparent !important;
        }

        /* Loading Overlay */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 0.5s;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--accent-cyan);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <!-- LOADING SCREEN -->
    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top:20px; font-family: var(--font-display); color: var(--accent-cyan);">SISTEMA INICIANDO...
        </p>
    </div>

    <!-- 1. MAP SELECTION / ADMIN MODE -->
    <div id="map-view">
        <div class="top-bar">
            <div class="header-title">
                <span>VIRTUAL PATH <span style="font-size:10px; opacity:0.7">AR BETA</span></span>
                <span class="info-pill" id="status-pill">MODO RUTA</span>
            </div>

            <div class="route-controls">
                <div class="control-row">
                    <button class="mode-btn active" id="btn-add-wp" onclick="setMode('waypoint')">+ PARADA</button>
                    <button class="mode-btn special" id="btn-set-dest" onclick="setMode('dest')">DESTINO üèÅ</button>
                </div>
                <!-- Quick Locations -->
                <div class="control-row">
                    <button class="mode-btn" onclick="setStartToAirport()" style="font-size:10px; opacity:0.8;">‚úàÔ∏è LAP
                        AIRPORT</button>
                    <button class="mode-btn" onclick="clearRoute()"
                        style="font-size:10px; opacity:0.8; background:#333;">üóëÔ∏è BORRAR</button>
                </div>
            </div>

            <div class="waypoint-list" id="wp-list">
                <!-- Dynamic Waypoints will go here -->
            </div>
        </div>

        <div id="map"></div>

        <!-- Center Pin for Selection -->
        <div id="center-pin">
            <img id="pin-icon" src="https://cdn-icons-png.flaticon.com/512/684/684908.png">
        </div>

        <div class="bottom-bar">
            <button class="btn-main" id="btn-go" onclick="startNavigation()" disabled>INICIAR RUTA AR</button>
            <button class="btn-share" onclick="shareRoute()">üîó COPIAR ENLACE DE RUTA (CLIENTE)</button>
        </div>
    </div>

    <!-- 2. AR HUD INTERFACE -->
    <div id="ar-ui">
        <div class="hud-header">
            <div class="nav-card">
                <div style="font-size:10px; color:var(--text-dim); text-transform:uppercase;">Distancia</div>
                <div class="nav-dist" id="ar-dist">0<span class="nav-unit">m</span></div>
                <div class="nav-instr" id="ar-instr">Sigue la flecha</div>
            </div>

            <!-- Mini Compass Visualization -->
            <div class="compass-ring">
                <div class="compass-arrow" id="hud-compass"></div>
            </div>
        </div>

        <button class="btn-exit" onclick="stopNavigation()">SALIR / FIN</button>
    </div>

    <!-- 3. A-FRAME SCENE -->
    <a-scene vr-mode-ui="enabled: false" embedded renderer="logarithmicDepthBuffer: true; alpha: true;"
        arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true; displayWidth: 1280; displayHeight: 720;">

        <!-- CAMERA -->
        <a-camera gps-camera="minDistance: 1; gpsMinDistance: 1;" rotation-reader>
            <!-- 3D ARROW -->
            <a-entity id="arrow-rig" position="0 -0.5 -2.5">
                <!-- Glowing Core -->
                <a-cone color="#ff2a2a" height="1.0" radius-bottom="0.3" radius-top="0.0" rotation="-90 0 0"
                    material="opacity: 0.9; transparent: true; emissive: #ff0000; emissiveIntensity: 0.8">
                </a-cone>
                <!-- Outer Ring -->
                <a-ring color="#00f3ff" radius-inner="0.35" radius-outer="0.4" rotation="-90 0 0" position="0 0 0.5"
                    material="opacity: 0.6; transparent: true; emissive: #00f3ff; emissiveIntensity: 0.5">
                </a-ring>
            </a-entity>
        </a-camera>

        <!-- World Points (Blue Dots) -->
        <a-entity id="world-points"></a-entity>
    </a-scene>

    <script>
        // CONFIG
        const MAPBOX_TOKEN = 'pk.eyJ1IjoiYW5keWc5NyIsImEiOiJjbWpwN20zcGoyYjFzM2ZveTIzZ2s5Mm56In0.FsNncSP8DrD6zTXpw0MaEg';
        mapboxgl.accessToken = MAPBOX_TOKEN;

        // STATE
        let app = {
            mode: 'waypoint', // 'waypoint' or 'dest'
            start: null, // [lng, lat]
            waypoints: [], // Array of [lng, lat]
            dest: null, // [lng, lat]
            routeGeoJSON: null,
            navigating: false,
            currentStep: 0
        };

        // SETUP MAP
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v11', // Dark cleaner style
            center: [-110.3626, 24.0726], // La Paz Airport default
            zoom: 13,
            attributionControl: false
        });

        // UI ELEMENTS
        const els = {
            mapView: document.getElementById('map-view'),
            arUI: document.getElementById('ar-ui'),
            wpList: document.getElementById('wp-list'),
            btnGo: document.getElementById('btn-go'),
            statusPill: document.getElementById('status-pill'),
            pinIcon: document.getElementById('pin-icon'),
            arDist: document.getElementById('ar-dist'),
            arInstr: document.getElementById('ar-instr'),
            arrowRig: document.getElementById('arrow-rig'),
            worldPoints: document.getElementById('world-points'),
            hudCompass: document.getElementById('hud-compass'),
            loader: document.getElementById('loader')
        };

        // --- MAP EVENTS & LOGIC ---

        // On Load
        map.on('load', () => {
            // Init User Location
            navigator.geolocation.getCurrentPosition(pos => {
                const userLoc = [pos.coords.longitude, pos.coords.latitude];
                app.start = userLoc;

                // If URL has route, load it
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('route')) {
                    loadRouteFromURL(urlParams.get('route'));
                } else {
                    // Default behavior
                    new mapboxgl.Marker({ color: '#00f3ff' }).setLngLat(userLoc).addTo(map);
                    map.flyTo({ center: userLoc, zoom: 15 });
                    els.loader.style.opacity = 0;
                    setTimeout(() => els.loader.style.display = 'none', 500);
                }
            }, err => {
                alert("Se requiere GPS. Act√≠valo.");
                els.loader.style.display = 'none';
            }, { enableHighAccuracy: true });
        });

        // Pin Movement Interactivity
        map.on('movestart', () => { els.pinIcon.parentNode.classList.add('pin-lift'); });
        map.on('moveend', () => { els.pinIcon.parentNode.classList.remove('pin-lift'); });

        // Add Point Helper
        map.on('click', (e) => {
            // We use the center pin logic usually, but click also works for desktop testing
            // logic below is for the Button Actions using Center Pin
        });

        // --- CORE FUNCTIONS ---

        function setMode(m) {
            app.mode = m;
            document.getElementById('btn-add-wp').classList.toggle('active', m === 'waypoint');
            document.getElementById('btn-set-dest').classList.toggle('active', m === 'dest');
            els.statusPill.innerText = m === 'waypoint' ? "AGREGAR PARADAS" : "FIJAR DESTINO FINAL";
            els.pinIcon.style.filter = m === 'dest' ? 'hue-rotate(140deg) brightness(1.2)' : 'none';
        }

        async function addCurrentCenterAsPoint() {
            const c = map.getCenter();
            const coords = [c.lng, c.lat];
            const name = await getAddrName(coords);

            if (app.mode === 'waypoint') {
                app.waypoints.push({ coords, name });
                renderList();
            } else if (app.mode === 'dest') {
                app.dest = { coords, name };
                renderList();
                // Dest usually ends the flow, try calc route
                calculateRoute();
            }
        }

        // We bind the "Map Click" logic effectively to the buttons or specific interaction
        // For this mobile-first vibe, let's make the Map Pin the cursor.
        // User pans map, then clicks the Active Button to "Confirm Position"
        // Let's modify the buttons to trigger the add:

        document.getElementById('btn-add-wp').addEventListener('click', () => {
            if (app.mode === 'waypoint') addCurrentCenterAsPoint(); // If already active, click adds
            else setMode('waypoint');
        });

        document.getElementById('btn-set-dest').addEventListener('click', () => {
            if (app.mode === 'dest') addCurrentCenterAsPoint();
            else setMode('dest');
        });

        function setStartToAirport() {
            // La Paz Airport
            const lap = [-110.3626, 24.0726];
            app.start = lap;
            map.flyTo({ center: lap, zoom: 14 });
            // Add marker
            new mapboxgl.Marker({ color: '#aaaaaa' }).setLngLat(lap).addTo(map);
            alert("Inicio fijado en Aeropuerto La Paz. Ahora define la ruta.");
        }

        function clearRoute() {
            app.waypoints = [];
            app.dest = null;
            app.routeGeoJSON = null;
            if (map.getSource('route')) map.removeLayer('route') && map.removeSource('route');
            renderList();
            els.btnGo.disabled = true;
        }

        function renderList() {
            els.wpList.innerHTML = '';

            // Render Waypoints
            app.waypoints.forEach((wp, i) => {
                const div = document.createElement('div');
                div.className = 'wp-tag center';
                div.innerHTML = `<span>${i + 1}. ${wp.name}</span> <button class="del-wp" onclick="removeWp(${i})">x</button>`;
                els.wpList.appendChild(div);
            });

            // Render Dest
            if (app.dest) {
                const div = document.createElement('div');
                div.className = 'wp-tag dest';
                div.innerHTML = `<span>üèÅ ${app.dest.name}</span> <button class="del-wp" onclick="removeDest()">x</button>`;
                els.wpList.appendChild(div);
            }
        }

        window.removeWp = (i) => { app.waypoints.splice(i, 1); renderList(); calculateRoute(); };
        window.removeDest = () => { app.dest = null; renderList(); els.btnGo.disabled = true; };

        // --- ROUTING ENGINE ---

        async function calculateRoute() {
            if (!app.start || !app.dest) return;

            // Construct Coordinate String: start;wp1;wp2;dest
            let coords = [app.start];
            app.waypoints.forEach(wp => coords.push(wp.coords));
            coords.push(app.dest.coords);

            const coordString = coords.map(c => c.join(',')).join(';');
            const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${coordString}?steps=true&geometries=geojson&access_token=${MAPBOX_TOKEN}`;

            try {
                const req = await fetch(url);
                const json = await req.json();
                if (!json.routes || json.routes.length === 0) return alert("No se encontr√≥ ruta.");

                const route = json.routes[0];
                app.routeGeoJSON = route.geometry;
                app.fullSteps = route.legs.flatMap(l => l.steps); // All steps flattened

                // Draw on Map
                if (map.getSource('route')) {
                    map.getSource('route').setData(app.routeGeoJSON);
                } else {
                    map.addLayer({
                        id: 'route',
                        type: 'line',
                        source: { type: 'geojson', data: app.routeGeoJSON },
                        layout: { 'line-join': 'round', 'line-cap': 'round' },
                        paint: { 'line-color': '#00f3ff', 'line-width': 5, 'line-opacity': 0.8 }
                    });
                }

                // Enable Go
                els.btnGo.disabled = false;
                els.btnGo.innerText = `INICIAR (${Math.round(route.distance / 1000)}km)`;

            } catch (e) { console.error(e); }
        }

        async function getAddrName(c) {
            const u = `https://api.mapbox.com/geocoding/v5/mapbox.places/${c[0]},${c[1]}.json?types=poi,address&access_token=${MAPBOX_TOKEN}`;
            const r = await fetch(u);
            const d = await r.json();
            return d.features[0]?.text || "Punto";
        }

        // --- SHARING ---
        window.shareRoute = () => {
            if (!app.start || !app.dest) return alert("Define una ruta completa primero.");

            // Encode: start|wp1|wp2|dest
            // We only really need WPs and Dest. Start is usually client's GPS?
            // User request: "Client follows MY route". So assume Start is Airport (fixed) or Client GPS.
            // Let's encode all points. 
            const data = {
                s: app.start,
                w: app.waypoints.map(w => w.coords),
                d: app.dest.coords
            };
            const str = btoa(JSON.stringify(data)); // Simple base64 encoding
            const url = `${window.location.origin}${window.location.pathname}?route=${str}`;

            navigator.clipboard.writeText(url).then(() => alert("Enlace copiado al portapapeles. Env√≠alo a tu cliente."));
        };

        function loadRouteFromURL(str) {
            try {
                const data = JSON.parse(atob(str));
                app.start = data.s;
                app.dest = { coords: data.d, name: "Destino Compartido" };
                app.waypoints = data.w.map(c => ({ coords: c, name: "Punto V√≠a" }));

                // Set text
                els.loader.innerHTML = '<div class="spinner"></div><p style="color:white; margin-top:10px;">CARGANDO RUTA DEL ANFITRI√ìN...</p>';

                // Render
                renderList();
                calculateRoute().then(() => {
                    els.loader.style.display = 'none';
                    // Auto start? Maybe wait for user to click Go
                    map.flyTo({ center: app.start, zoom: 14 });
                });
            } catch (e) {
                console.error(e);
                alert("Error cargando ruta compartida.");
                els.loader.style.display = 'none';
            }
        }


        // --- AR NAVIGATION MODE ---

        window.startNavigation = () => {
            if (!app.routeGeoJSON) return;
            app.navigating = true;

            // Switch UI
            els.mapView.style.opacity = 0;
            setTimeout(() => { els.mapView.style.display = 'none'; els.arUI.style.display = 'block'; }, 500);

            // Setup AR Scene Points
            setupARPoints();
            startARLoop();
        };

        window.stopNavigation = () => {
            app.navigating = false;
            els.arUI.style.display = 'none';
            els.mapView.style.display = 'flex';
            els.mapView.style.opacity = 1;
            // Clean AR
            els.worldPoints.innerHTML = '';
        };

        function setupARPoints() {
            els.worldPoints.innerHTML = '';
            // Place blue dots every ~20 meters along the line
            // Simplified: just iterate coords
            const path = app.routeGeoJSON.coordinates;
            path.forEach((c, i) => {
                if (i % 2 !== 0) return; // Skip some for perf
                const el = document.createElement('a-entity');
                el.setAttribute('gps-new-entity-place', `latitude: ${c[1]}; longitude: ${c[0]}`);
                // Blue glowing orb
                el.innerHTML = `<a-sphere color="#00f3ff" radius="0.5" opacity="0.6" position="0 0 0"></a-sphere>`;
                els.worldPoints.appendChild(el);
            });
        }

        // --- AR LOOP & COMPASS LOGIC ---

        let lastDeviceHeading = 0;

        function startARLoop() {
            // Setup Compass Listener
            window.addEventListener('deviceorientation', (e) => {
                let heading = 0;
                if (e.webkitCompassHeading) heading = e.webkitCompassHeading;
                else if (e.alpha) heading = 360 - e.alpha;

                // Simple Low Pass Filter to smooth jitter
                // y += alpha * (x - y)
                const alpha = 0.1;
                // Handle 359->0 wrap
                let diff = heading - lastDeviceHeading;
                if (diff < -180) diff += 360;
                if (diff > 180) diff -= 360;

                lastDeviceHeading += diff * alpha;
                // Normalize
                lastDeviceHeading = (lastDeviceHeading + 360) % 360;
            });

            // Watch Position
            navigator.geolocation.watchPosition(pos => {
                if (!app.navigating) return;

                const userLat = pos.coords.latitude;
                const userLng = pos.coords.longitude;
                const path = app.routeGeoJSON.coordinates;

                // Find closest point on path (Basic approach: Distance to next target step)
                // We assume sequential movement.
                // Target is app.currentStep index in path
                let target = path[app.currentStep];

                // Calc dist
                const d = distInMeters(userLat, userLng, target[1], target[0]);

                els.arDist.innerHTML = Math.round(d) + '<span class="nav-unit">m</span>';

                // If close, advance
                if (d < 15) {
                    if (app.currentStep < path.length - 1) {
                        app.currentStep++;
                        playSound('ping'); // Optional Feedback
                    } else {
                        els.arInstr.innerText = "¬°Has llegado!";
                    }
                }

                // ARROW ROTATION
                // Bearing to target
                const bearing = calcBearing(userLat, userLng, target[1], target[0]);

                // HUD Arrow Rotation: relative angle
                // If I embrace North (0), and target is East (90), bearing is 90.
                // If I face North (0), arrow should point Right (90).
                // If I face East (90), Device=90. relative = 90 - 90 = 0 (Center, aka Straight).

                let relative = bearing - lastDeviceHeading;

                // Update 3D Arrow (Rotation Y in radians)
                // A-Frame rotation is counter-clockwise positive in some contexts, but usually Y is standard left-hand rule?
                // Actually in A-Frame/ThreeJS:
                // Rotation Y+ is turning Left? No, Y axis is vertical.
                // We convert degrees to radians.
                // Visual adjustment: The model usually points -Z (forward).
                // We rotate it around Y.
                // -relative * (Math.PI / 180) usually works for HUD.

                els.arrowRig.object3D.rotation.y = -relative * (Math.PI / 180);

                // HUD Compass
                els.hudCompass.style.transform = `rotate(${-relative}deg)`;

                // Text Instruction
                if (Math.abs(relative) < 20) els.arInstr.innerText = "Contin√∫a recto";
                else if (relative < 0) els.arInstr.innerText = "Gira izquierda";
                else els.arInstr.innerText = "Gira derecha";

            }, err => console.error(err), { enableHighAccuracy: true, maximumAge: 0 });
        }

        // UTILS
        function distInMeters(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function calcBearing(startLat, startLng, destLat, destLng) {
            const startLatRad = startLat * (Math.PI / 180);
            const startLngRad = startLng * (Math.PI / 180);
            const destLatRad = destLat * (Math.PI / 180);
            const destLngRad = destLng * (Math.PI / 180);
            const y = Math.sin(destLngRad - startLngRad) * Math.cos(destLatRad);
            const x = Math.cos(startLatRad) * Math.sin(destLatRad) - Math.sin(startLatRad) * Math.cos(destLatRad) * Math.cos(destLngRad - startLngRad);
            let brng = Math.atan2(y, x);
            brng = brng * (180 / Math.PI);
            return (brng + 360) % 360;
        }

        function playSound(type) {
            // Simple beep placeholder 
        }

    </script>
</body>

</html>
