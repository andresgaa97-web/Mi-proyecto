<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>AR Sistema de Gu√≠a - Lag Paz</title>

    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600&display=swap"
        rel="stylesheet">

    <!-- LIBRARIES -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script type='text/javascript'
        src='https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js'></script>
    <script type='text/javascript'
        src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

    <style>
        :root {
            --bg-dark: #0a0a12;
            --glass-panel: rgba(10, 10, 18, 0.85);
            --accent-cyan: #00f3ff;
            --accent-red: #ff2a2a;
            --accent-green: #00ff66;
            --text-main: #ffffff;
            --text-dim: #a0a0b0;
            --font-display: 'Orbitron', sans-serif;
            --font-body: 'Inter', sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            font-family: var(--font-body);
            overflow: hidden;
            color: var(--text-main);
        }

        /* === MAP VIEW UI === */
        #map-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 200;
            display: flex;
            flex-direction: column;
            background: var(--bg-dark);
            transition: opacity 0.5s ease;
        }

        #map {
            flex-grow: 1;
            width: 100%;
        }

        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0) 100%);
            z-index: 20;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .header-title {
            font-family: var(--font-display);
            font-size: 16px;
            /* Ajustado para el logo */
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent-cyan);
            text-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-logo {
            height: 40px;
            width: 40px;
            /* Fixed width to ensure visibility */
            object-fit: contain;
            background: white;
            /* Ensure white background if transparent */
            border-radius: 50%;
            border: 2px solid var(--accent-cyan);
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
        }

        /* Config / Audio Toolbar */
        .config-toolbar {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-bottom: 5px;
        }

        .icon-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            transition: 0.3s;
        }

        .icon-btn.active {
            background: var(--accent-green);
            color: black;
            border-color: var(--accent-green);
        }

        .route-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .mode-btn {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            text-align: center;
            text-transform: uppercase;
        }

        .mode-btn.active {
            background: var(--accent-cyan);
            color: black;
            box-shadow: 0 0 15px var(--accent-cyan);
            border-color: var(--accent-cyan);
        }

        .mode-btn.special {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .mode-btn.special.active {
            background: var(--accent-red);
            color: white;
            box-shadow: 0 0 15px var(--accent-red);
        }

        .info-pill {
            background: var(--glass-panel);
            color: var(--accent-cyan);
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-family: var(--font-display);
            border: 1px solid rgba(0, 243, 255, 0.3);
        }

        .waypoint-list {
            margin-top: 5px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            max-height: 120px;
            overflow-y: auto;
        }

        .wp-tag {
            background: rgba(0, 0, 0, 0.6);
            border-left: 3px solid var(--accent-cyan);
            padding: 8px;
            font-size: 12px;
            border-radius: 0 4px 4px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .wp-tag.dest {
            border-color: var(--accent-red);
        }

        .wp-tag span {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            max-width: 85%;
        }

        .del-wp {
            color: #ff5555;
            background: none;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }

        .bottom-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            background: linear-gradient(0deg, rgba(0, 0, 0, 0.95) 0%, rgba(0, 0, 0, 0) 100%);
            z-index: 20;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .btn-main {
            width: 100%;
            background: var(--accent-cyan);
            color: black;
            border: none;
            padding: 18px;
            border-radius: 12px;
            font-family: var(--font-display);
            font-size: 16px;
            font-weight: 900;
            letter-spacing: 1px;
            text-transform: uppercase;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 20px rgba(0, 243, 255, 0.3);
            cursor: pointer;
        }

        .btn-main:active {
            transform: scale(0.98);
        }

        .btn-main:disabled {
            background: #333;
            color: #666;
            box-shadow: none;
            cursor: not-allowed;
        }

        .btn-share {
            background: transparent;
            color: var(--text-dim);
            border: 1px solid var(--text-dim);
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 12px;
            margin-top: -5px;
            cursor: pointer;
        }

        #center-pin {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -100%);
            z-index: 5;
            pointer-events: none;
            transition: transform 0.2s;
        }

        #center-pin img {
            width: 40px;
            filter: drop-shadow(0 5px 10px rgba(0, 0, 0, 0.5));
        }

        .pin-lift {
            transform: translate(-50%, -140%) scale(1.1) !important;
        }

        /* === AR HUD === */
        #ar-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 300;
            display: none;
        }

        .hud-header {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
        }

        .nav-card {
            background: rgba(10, 10, 18, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 0 20px 0 20px;
            border-left: 4px solid var(--accent-cyan);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            min-width: 150px;
        }

        .nav-dist {
            font-family: var(--font-display);
            font-size: 42px;
            color: var(--accent-cyan);
            line-height: 0.9;
        }

        .nav-unit {
            font-size: 14px;
            color: var(--text-dim);
            margin-left: 2px;
        }

        .nav-instr {
            font-size: 14px;
            margin-top: 5px;
            color: white;
            max-width: 200px;
        }

        .btn-exit {
            pointer-events: auto;
            background: var(--accent-red);
            color: white;
            border: none;
            padding: 10px 30px;
            border-radius: 30px;
            font-weight: bold;
            box-shadow: 0 5px 20px rgba(255, 42, 42, 0.4);
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
        }

        .ar-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: auto;
        }

        /* 2D HUD INDICATOR */
        #hud-direction {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200px;
            height: 200px;
            /* Center nicely */
            transform-origin: center center;
            transform: translate(-50%, -50%) rotate(0deg);
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: center;
            filter: drop-shadow(0 0 15px var(--accent-cyan));
            transition: transform 0.1s linear;
            /* Smooth rotation */
        }

        /* The SVG Arrow shape */
        #hud-direction svg {
            width: 100%;
            height: 100%;
            fill: rgba(0, 243, 255, 0.8);
        }

        a-scene {
            width: 100%;
            height: 100%;
            background: transparent !important;
        }

        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 0.5s;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--accent-cyan);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top:20px; font-family: var(--font-display); color: var(--accent-cyan);">SISTEMA INICIANDO...
        </p>
    </div>

    <!-- 1. MAP SELECTION -->
    <div id="map-view">
        <div class="top-bar">
            <!-- HEADER WITH LOGO -->
            <div class="header-title">
                <div style="display:flex; align-items:center; gap:10px;">
                    <img src="logo.png" class="app-logo" alt="BajaStay Logo" id="main-logo"
                        onerror="this.style.display='none'; document.getElementById('logo-fallback').style.display='flex';">
                    <div id="logo-fallback"
                        style="display:none; width:40px; height:40px; background:white; border-radius:50%; align-items:center; justify-content:center; font-size:12px; font-weight:900; color:#ff6b35; border:2px solid var(--accent-cyan); box-shadow: 0 0 10px rgba(0, 243, 255, 0.5);">
                        BS
                    </div>
                    <div>
                        <div style="line-height:1; font-weight:900;">BAJASTAY</div>
                        <div style="font-size:8px; opacity:0.7; letter-spacing:3px;">NAVEGACI√ìN AR</div>
                    </div>
                </div>
                <!-- Status Pill moved down or right -->
            </div>

            <div class="config-toolbar">
                <span class="info-pill" id="status-pill" style="margin-right:auto;">MODO RUTA</span>
                <button class="icon-btn active" id="btn-lang" onclick="toggleLang()">ES</button>
            </div>

            <div class="route-controls">
                <div class="control-row">
                    <button class="mode-btn active" id="btn-add-wp" onclick="setMode('waypoint')">+ PARADA</button>
                    <button class="mode-btn special" id="btn-set-dest" onclick="setMode('dest')">DESTINO üèÅ</button>
                </div>
                <!-- Action Buttons: Reset Default is Key -->
                <div class="control-row">
                    <button class="mode-btn" onclick="loadDefaultRoute()"
                        style="font-size:10px; opacity:0.9; background:#004444; border-color:#008888;">üîÑ RUTA
                        DEFAULT</button>
                    <button class="mode-btn" onclick="clearRoute()"
                        style="font-size:10px; opacity:0.6; background:#333;">üóëÔ∏è LIMPIAR</button>
                </div>
            </div>

            <div class="waypoint-list" id="wp-list"></div>
        </div>

        <div id="map"></div>

        <div id="center-pin">
            <img id="pin-icon" src="https://cdn-icons-png.flaticon.com/512/684/684908.png">
        </div>

        <div class="bottom-bar">
            <button class="btn-main" id="btn-go" onclick="startNavigation()" disabled>INICIAR RUTA AR</button>
            <div style="display:flex; gap:10px; width:100%;">
                <button class="btn-share" onclick="shareRoute()" style="flex:1;">üîó URL CLIENTE</button>
                <button class="btn-share" onclick="exportRouteConfig()"
                    style="flex:1; border-color:var(--accent-green); color:var(--accent-green);">üíæ C√ìDIGO</button>
            </div>
        </div>
    </div>

    <!-- 2. AR HUD INTERFACE -->
    <div id="ar-ui">
        <div class="hud-header">
            <div class="nav-card">
                <div style="font-size:10px; color:var(--text-dim); text-transform:uppercase;">Distancia</div>
                <div class="nav-dist" id="ar-dist">0<span class="nav-unit">m</span></div>
                <div class="nav-instr" id="ar-instr">Sigue la flecha</div>
            </div>
        </div>

        <div class="ar-controls">
            <button class="icon-btn active" id="btn-voice-ar" onclick="toggleVoice()">üîä</button>
        </div>

        <!-- 2D HUD INDICATOR -->
        <div id="hud-direction">
            <!-- Simple Arrow SVG pointing UP -->
            <svg viewBox="0 0 100 100">
                <path d="M50 10 L10 90 L50 70 L90 90 Z" />
            </svg>
        </div>

        <button class="btn-exit" onclick="stopNavigation()">SALIR / FIN</button>
    </div>

    <!-- 3. A-FRAME SCENE -->
    <a-scene vr-mode-ui="enabled: false" embedded renderer="logarithmicDepthBuffer: true; alpha: true;"
        arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true; displayWidth: 1280; displayHeight: 720;">

        <a-camera gps-camera="minDistance: 1; gpsMinDistance: 1;" rotation-reader></a-camera>
        <!-- World Points (Blue Dots) -->
        <a-entity id="world-points"></a-entity>
    </a-scene>

    <script>
        const MAPBOX_TOKEN = 'pk.eyJ1IjoiYW5keWc5NyIsImEiOiJjbWpwN20zcGoyYjFzM2ZveTIzZ2s5Mm56In0.FsNncSP8DrD6zTXpw0MaEg';
        mapboxgl.accessToken = MAPBOX_TOKEN;

        // --- DEFAULT ROUTE CONFIG (Optimized to Match User's Red Line) ---
        // Based on satellite image with 3 red circles marking critical waypoints:
        // Circle 1: Airport exit to highway (Northwest)
        // Circle 2: Critical LEFT turn intersection (North-center) 
        // Circle 3: Entry into Chunique/El Centenario (West)
        const DEFAULT_ROUTE = {
            s: [-110.3626, 24.0726],  // Start: La Paz International Airport (LAP)
            w: [
                [-110.3610, 24.0800],  // Circle 1: Airport exit, heading north
                [-110.3570, 24.0920],  // Northbound on Transpeninsular Highway
                [-110.3533, 24.1011],  // Circle 2: CRITICAL LEFT TURN (West toward Chametla)
                [-110.3620, 24.1015],  // West on Chametla access road
                [-110.3720, 24.0995],  // Circle 3: Approaching Chunique turn
                [-110.3790, 24.0970]   // Final approach to destination
            ],
            d: [-110.3815, 24.0955],  // Destination: Chunique, El Centenario, B.C.S.
            dn: "Casa Chunique"
        };

        let app = {
            mode: 'waypoint', start: null, waypoints: [], dest: null,
            routeGeoJSON: null, navigating: false, currentStep: 0,
            lang: 'es', voice: true
        };

        const txt = {
            es: {
                add: "+ PARADA", dest: "DESTINO üèÅ", pillW: "AGREGAR PARADAS", pillD: "FIJAR DESTINO FINAL",
                start: "INICIAR RUTA AR", go: "Continuar", left: "Gira izquierda", right: "Gira derecha",
                arrive: "¬°Has llegado!", straight: "Sigue recto"
            },
            en: {
                add: "+ WAYPOINT", dest: "DESTINATION üèÅ", pillW: "ADD WAYPOINTS", pillD: "SET DESTINATION",
                start: "START AR ROUTE", go: "Continue", left: "Turn left", right: "Turn right",
                arrive: "You have arrived!", straight: "Go straight"
            }
        };

        const map = new mapboxgl.Map({
            container: 'map', style: 'mapbox://styles/mapbox/dark-v11',
            center: [-110.3626, 24.0726], zoom: 13, attributionControl: false
        });

        const els = {
            mapView: document.getElementById('map-view'),
            arUI: document.getElementById('ar-ui'),
            wpList: document.getElementById('wp-list'),
            btnGo: document.getElementById('btn-go'),
            statusPill: document.getElementById('status-pill'),
            pinIcon: document.getElementById('pin-icon'),
            arDist: document.getElementById('ar-dist'),
            arInstr: document.getElementById('ar-instr'),
            hudArrow: document.getElementById('hud-direction'),
            worldPoints: document.getElementById('world-points'),
            loader: document.getElementById('loader'),
            btnLang: document.getElementById('btn-lang'),
            btnVoice: document.getElementById('btn-voice-ar'),
            btnAdd: document.getElementById('btn-add-wp'),
            btnDest: document.getElementById('btn-set-dest')
        };

        map.on('load', () => {
            // 1. Try to load Route from URL
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('route')) {
                loadRouteFromURL(urlParams.get('route'));
            } else {
                // 2. No URL? Load DEFAULT ROUTE Automatically
                loadDefaultRoute();
            }

            // 3. User GPS (optional background update, don't override start unless requested)
            navigator.geolocation.getCurrentPosition(pos => {
                // Just center map initially if user is far away? No, keep it on the route.
            }, err => console.log("GPS Peding"), { enableHighAccuracy: true });
        });

        map.on('movestart', () => { els.pinIcon.parentNode.classList.add('pin-lift'); });
        map.on('moveend', () => { els.pinIcon.parentNode.classList.remove('pin-lift'); });

        function setMode(m) {
            app.mode = m;
            els.btnAdd.classList.toggle('active', m === 'waypoint');
            els.btnDest.classList.toggle('active', m === 'dest');
            els.statusPill.innerText = app.lang === 'es' ? (m === 'waypoint' ? txt.es.pillW : txt.es.pillD) : (m === 'waypoint' ? txt.en.pillW : txt.en.pillD);
            els.pinIcon.style.filter = m === 'dest' ? 'hue-rotate(140deg) brightness(1.2)' : 'none';
        }

        function toggleLang() {
            app.lang = app.lang === 'es' ? 'en' : 'es';
            els.btnLang.innerText = app.lang.toUpperCase();
            els.btnAdd.innerText = txt[app.lang].add;
            els.btnDest.innerText = txt[app.lang].dest;
            if (!els.btnGo.disabled) els.btnGo.innerText = txt[app.lang].start;
            setMode(app.mode);
        }

        function toggleVoice() {
            app.voice = !app.voice;
            els.btnVoice.innerText = app.voice ? "üîä" : "üîá";
            els.btnVoice.classList.toggle('active', app.voice);
            if (app.voice) speak("Audio");
        }

        // --- ROUTE BUILDER LOGIC ---
        map.on('click', (e) => {
            const coords = [e.lngLat.lng, e.lngLat.lat];
            // Visual feedback immediately
            new mapboxgl.Marker({ color: app.mode === 'dest' ? '#ff2a2a' : '#00f3ff', scale: 0.8 })
                .setLngLat(coords).addTo(map);

            if (app.mode === 'waypoint') {
                getAddrName(coords).then(name => {
                    app.waypoints.push({ coords, name });
                    renderList();
                });
            } else if (app.mode === 'dest') {
                getAddrName(coords).then(name => {
                    app.dest = { coords, name };
                    renderList();
                    calculateRoute();
                });
            }
        });

        async function addCurrentCenterAsPoint() {
            // Legacy button support: still add center if clicked
            const c = map.getCenter();
            const coords = [c.lng, c.lat];
            const name = await getAddrName(coords);
            if (app.mode === 'waypoint') { app.waypoints.push({ coords, name }); renderList(); }
            else if (app.mode === 'dest') { app.dest = { coords, name }; renderList(); calculateRoute(); }
        }

        document.getElementById('btn-add-wp').addEventListener('click', () => { if (app.mode === 'waypoint') addCurrentCenterAsPoint(); else setMode('waypoint'); });
        document.getElementById('btn-set-dest').addEventListener('click', () => { if (app.mode === 'dest') addCurrentCenterAsPoint(); else setMode('dest'); });

        window.exportRouteConfig = () => {
            if (!app.start || !app.dest) return alert("Ruta incompleta. Define inicio y fin.");

            // Construct the JSON object strictly matching DEFAULT_ROUTE format
            const config = {
                s: app.start,
                w: app.waypoints.map(wp => wp.coords),
                d: app.dest.coords,
                dn: app.dest.name
            };

            const jsonStr = JSON.stringify(config, null, 4);
            console.log("--- COPIAR ESTE CODIGO ---");
            console.log(jsonStr);
            console.log("--------------------------");

            // Prompt to copy
            prompt("COPIA ESTE C√ìDIGO Y ENVIALO PARA FIJARLO COMO DEFAULT:", jsonStr);
        };

        function setStartToAirport() {
            const lap = [-110.3626, 24.0726]; app.start = lap; map.flyTo({ center: lap, zoom: 14 });
            new mapboxgl.Marker({ color: '#aaaaaa' }).setLngLat(lap).addTo(map);
        }

        // --- DEFAULT ROUTE LOADER ---
        window.loadDefaultRoute = () => {
            app.start = DEFAULT_ROUTE.s;
            app.waypoints = DEFAULT_ROUTE.w.map(c => ({ coords: c, name: "Punto V√≠a" }));
            app.dest = { coords: DEFAULT_ROUTE.d, name: DEFAULT_ROUTE.dn };

            els.loader.style.display = 'block';
            els.loader.style.opacity = 1;
            els.loader.innerHTML = '<div class="spinner"></div><p style="color:white; margin-top:10px;">CARGANDO RUTA PREDEFINIDA...</p>';

            renderList();
            calculateRoute().then(() => {
                map.flyTo({ center: app.start, zoom: 13 });
                setTimeout(() => { els.loader.style.opacity = 0; setTimeout(() => els.loader.style.display = 'none', 500); }, 500);
            });
        };

        function clearRoute() {
            app.waypoints = []; app.dest = null; app.routeGeoJSON = null;
            if (map.getSource('route')) map.removeLayer('route') && map.removeSource('route');
            renderList(); els.btnGo.disabled = true;
        }

        function renderList() {
            els.wpList.innerHTML = '';
            app.waypoints.forEach((wp, i) => {
                const div = document.createElement('div');
                div.className = 'wp-tag center';
                div.innerHTML = `<span>${i + 1}. ${wp.name}</span> <button class="del-wp" onclick="removeWp(${i})">x</button>`;
                els.wpList.appendChild(div);
            });
            if (app.dest) {
                const div = document.createElement('div');
                div.className = 'wp-tag dest';
                div.innerHTML = `<span>üèÅ ${app.dest.name}</span> <button class="del-wp" onclick="removeDest()">x</button>`;
                els.wpList.appendChild(div);
            }
        }

        window.removeWp = (i) => { app.waypoints.splice(i, 1); renderList(); calculateRoute(); };
        window.removeDest = () => { app.dest = null; renderList(); els.btnGo.disabled = true; };

        async function calculateRoute() {
            if (!app.start || !app.dest) return;
            let coords = [app.start];
            app.waypoints.forEach(wp => coords.push(wp.coords));
            coords.push(app.dest.coords);
            const coordString = coords.map(c => c.join(',')).join(';');
            const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${coordString}?steps=true&geometries=geojson&access_token=${MAPBOX_TOKEN}`;
            try {
                const req = await fetch(url); const json = await req.json();
                if (!json.routes || json.routes.length === 0) return alert("Error de ruta");
                const route = json.routes[0]; app.routeGeoJSON = route.geometry;
                if (map.getSource('route')) map.getSource('route').setData(app.routeGeoJSON);
                else map.addLayer({
                    id: 'route', type: 'line', source: { type: 'geojson', data: app.routeGeoJSON },
                    layout: { 'line-join': 'round', 'line-cap': 'round' },
                    paint: { 'line-color': '#00f3ff', 'line-width': 5, 'line-opacity': 0.8 }
                });
                els.btnGo.disabled = false; els.btnGo.innerText = `${txt[app.lang].start} - ${Math.round(route.distance / 1000)}km`;
            } catch (e) { console.error(e); }
        }

        async function getAddrName(c) {
            try {
                const u = `https://api.mapbox.com/geocoding/v5/mapbox.places/${c[0]},${c[1]}.json?types=poi,address&access_token=${MAPBOX_TOKEN}`;
                const r = await fetch(u); const d = await r.json(); return d.features[0]?.text || "Punto";
            } catch { return "Punto"; }
        }

        window.shareRoute = () => {
            if (!app.start || !app.dest) return alert("Ruta incompleta");
            const data = { s: app.start, w: app.waypoints.map(w => w.coords), d: app.dest.coords };
            const str = btoa(JSON.stringify(data));
            const url = `${window.location.origin}${window.location.pathname}?route=${str}`;
            navigator.clipboard.writeText(url).then(() => alert("URL Copiada!"));
        };

        function loadRouteFromURL(str) {
            try {
                const data = JSON.parse(atob(str)); app.start = data.s;
                app.dest = { coords: data.d, name: "Destino" };
                app.waypoints = data.w.map(c => ({ coords: c, name: "Punto" }));
                els.loader.innerHTML = '<div class="spinner"></div><p style="color:white; margin-top:10px;">CARGANDO RUTA...</p>';
                renderList(); calculateRoute().then(() => { els.loader.style.display = 'none'; });
            } catch (e) { els.loader.style.display = 'none'; alert("Error URL"); }
        }

        window.startNavigation = () => {
            if (!app.routeGeoJSON) return; app.navigating = true; els.mapView.style.opacity = 0;
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(r => { if (r != 'granted') alert("Permiso denegado"); }).catch(console.error);
            }
            speak(app.lang === 'es' ? "Iniciando. Sigue la flecha." : "Starting. Follow the arrow.");
            setTimeout(() => { els.mapView.style.display = 'none'; els.arUI.style.display = 'block'; }, 500);
            startARLoop();
        };

        window.stopNavigation = () => { app.navigating = false; els.arUI.style.display = 'none'; els.mapView.style.display = 'flex'; els.mapView.style.opacity = 1; };

        let lastDeviceHeading = 0; let lastSpeakTime = 0; let lastInstruction = "";

        function startARLoop() {
            window.addEventListener('deviceorientation', (e) => {
                let heading = 0;
                if (e.webkitCompassHeading) heading = e.webkitCompassHeading; else if (e.alpha) heading = 360 - e.alpha;
                const alpha = 0.1; let diff = heading - lastDeviceHeading;
                if (diff < -180) diff += 360; if (diff > 180) diff -= 360;
                lastDeviceHeading += diff * alpha; lastDeviceHeading = (lastDeviceHeading + 360) % 360;
            });

            navigator.geolocation.watchPosition(pos => {
                if (!app.navigating) return;
                const userLat = pos.coords.latitude; const userLng = pos.coords.longitude;
                const path = app.routeGeoJSON.coordinates;
                let target = path[app.currentStep];

                const d = distInMeters(userLat, userLng, target[1], target[0]);
                els.arDist.innerHTML = Math.round(d) + '<span class="nav-unit">m</span>';

                if (d < 15) {
                    if (app.currentStep < path.length - 1) { app.currentStep++; }
                    else { const msg = txt[app.lang].arrive; els.arInstr.innerText = msg; speak(msg); }
                }

                // ARROW LOGIC
                const bearing = calcBearing(userLat, userLng, target[1], target[0]);
                let relative = bearing - lastDeviceHeading;

                // ROTATE HUD ARROW (2D)
                // If relative is +90 (Right), rotate CSS 90deg (Right)
                // translate must be kept (-50%, -50%) to stay centered
                els.hudArrow.style.transform = `translate(-50%, -50%) rotate(${relative}deg)`;

                let msg = ""; let threshold = 30;
                if (Math.abs(relative) < threshold) msg = txt[app.lang].straight;
                else if (relative < 0) msg = txt[app.lang].left;
                else msg = txt[app.lang].right;
                els.arInstr.innerText = msg;

                const now = Date.now();
                if (msg !== lastInstruction && (now - lastSpeakTime > 5000)) {
                    speak(msg); lastInstruction = msg; lastSpeakTime = now;
                    // Flash Arrow Green if Straight
                    if (msg === txt[app.lang].straight) els.hudArrow.style.filter = "drop-shadow(0 0 20px #00ff66)";
                    else els.hudArrow.style.filter = "drop-shadow(0 0 15px #00f3ff)";
                }

            }, err => console.error(err), { enableHighAccuracy: true, maximumAge: 0 });
        }

        function speak(text) {
            if (!app.voice) return; window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = app.lang === 'es' ? 'es-MX' : 'en-US';
            u.rate = 1.0; window.speechSynthesis.speak(u);
        }

        function distInMeters(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const œÜ1 = lat1 * Math.PI / 180; const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180; const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function calcBearing(startLat, startLng, destLat, destLng) {
            const startLatRad = startLat * (Math.PI / 180); const startLngRad = startLng * (Math.PI / 180);
            const destLatRad = destLat * (Math.PI / 180); const destLngRad = destLng * (Math.PI / 180);
            const y = Math.sin(destLngRad - startLngRad) * Math.cos(destLatRad);
            const x = Math.cos(startLatRad) * Math.sin(destLatRad) - Math.sin(startLatRad) * Math.cos(destLatRad) * Math.cos(destLngRad - startLngRad);
            let brng = Math.atan2(y, x); brng = brng * (180 / Math.PI);
            return (brng + 360) % 360;
        }
    </script>
</body>

</html>
