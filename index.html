<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Navigation Pro</title>
    
    <!-- A-FRAME y AR.JS -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js'></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>

    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; background-color: transparent !important; }
        
        /* Controles UI Superiores */
        #top-ui {
            position: absolute;
            top: 10px;
            left: 0;
            width: 100%;
            z-index: 999;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            pointer-events: auto;
        }

        .row { display: flex; gap: 10px; justify-content: center; width: 90%; }
        
        input {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 70%;
            font-size: 16px;
        }

        select {
            padding: 10px;
            border-radius: 5px;
        }

        /* Controles UI Inferiores */
        #bottom-ui {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
            z-index: 999;
        }

        button {
            padding: 12px 24px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            cursor: pointer;
        }

        button:active { transform: scale(0.95); }

        #status-bar {
            background: rgba(0, 0, 0, 0.7);
            color: #00ff00;
            padding: 5px 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            margin-bottom: 5px;
            display: inline-block;
        }

        /* CorrecciÃ³n pantalla blanca: forzar transparencia */
        a-scene { display: block; width: 100%; height: 100%; }
        video { z-index: -1 !important; } /* Video al fondo */
    </style>
</head>

<body>

    <!-- INTERFAZ DE USUARIO -->
    <div id="top-ui">
        <!-- Fila 1: Idioma y Estado -->
        <div class="row" style="justify-content: space-between;">
            <div id="status-bar">GPS: Waiting...</div>
            <select id="lang-select">
                <option value="es">ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
                <option value="en">ðŸ‡ºðŸ‡¸ English</option>
            </select>
        </div>

        <!-- Fila 2: Buscador -->
        <div class="row">
            <input type="text" id="destination-input" placeholder="Ej: Starbucks, Parque...">
        </div>
    </div>

    <div id="bottom-ui">
        <button id="btn-action">â–¶ Iniciar / Start</button>
        <button id="btn-voice" style="background: #444;">ðŸ”Š</button>
    </div>

    <!-- ESCENA AR (Con correcciÃ³n de transparencia) -->
    <a-scene
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; alpha: true;" 
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;">
        
        <a-camera gps-camera rotation-reader></a-camera>

        <!-- Contenedor de las flechas -->
        <a-entity id="route-container"></a-entity>
    </a-scene>

    <script>
        /**
         * CONFIGURACIÃ“N
         */
        const MAPBOX_TOKEN = 'pk.eyJ1IjoiYW5keWc5NyIsImEiOiJjbWpwN20zcGoyYjFzM2ZveTIzZ2s5Mm56In0.FsNncSP8DrD6zTXpw0MaEg';
        
        // Estado de la App
        let state = {
            lang: 'es',
            voiceEnabled: true,
            currentLoc: null, // [lon, lat]
            isNavigating: false
        };

        // Textos / Traducciones
        const texts = {
            es: {
                waitGps: "Esperando GPS...",
                calculating: "Calculando ruta...",
                notFound: "No se encontrÃ³ el lugar. Intenta otro nombre.",
                start: "Iniciar Ruta",
                arrived: "Has llegado a tu destino.",
                errorGps: "Error GPS: ",
                voiceOn: "ðŸ”Š",
                voiceOff: "ðŸ”‡",
                placeholder: "Buscar destino (ej: Oxxo)"
            },
            en: {
                waitGps: "Waiting for GPS...",
                calculating: "Calculating route...",
                notFound: "Location not found. Try another name.",
                start: "Start Route",
                arrived: "You have arrived.",
                errorGps: "GPS Error: ",
                voiceOn: "ðŸ”Š",
                voiceOff: "ðŸ”‡",
                placeholder: "Search destination (e.g., Starbucks)"
            }
        };

        // DOM Elements
        const ui = {
            status: document.getElementById('status-bar'),
            btnAction: document.getElementById('btn-action'),
            btnVoice: document.getElementById('btn-voice'),
            input: document.getElementById('destination-input'),
            langSelect: document.getElementById('lang-select'),
            scene: document.querySelector('a-scene')
        };

        /**
         * 1. SISTEMA DE IDIOMA
         */
        ui.langSelect.addEventListener('change', (e) => {
            state.lang = e.target.value;
            updateTexts();
        });

        function updateTexts() {
            const t = texts[state.lang];
            ui.input.placeholder = t.placeholder;
            ui.btnAction.innerText = t.start;
            if(!state.currentLoc) ui.status.innerText = t.waitGps;
        }

        /**
         * 2. SISTEMA GPS
         */
        if (navigator.geolocation) {
            const options = { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 };
            
            navigator.geolocation.watchPosition(
                (pos) => {
                    state.currentLoc = [pos.coords.longitude, pos.coords.latitude];
                    ui.status.innerText = `GPS: ${state.currentLoc[1].toFixed(5)}, ${state.currentLoc[0].toFixed(5)}`;
                    ui.status.style.color = '#00ff00'; // Verde = OK
                },
                (err) => {
                    console.error(err);
                    ui.status.innerText = texts[state.lang].errorGps + err.code;
                    ui.status.style.color = 'red';
                },
                options
            );
        } else {
            alert("Geolocation not supported / GPS no soportado");
        }

        /**
         * 3. LÃ“GICA DE BÃšSQUEDA Y RUTA
         */
        ui.btnAction.addEventListener('click', async () => {
            if (!state.currentLoc) {
                alert(texts[state.lang].waitGps);
                return;
            }

            const query = ui.input.value;
            if (!query) return;

            speak(texts[state.lang].calculating);
            
            // Paso A: Buscar Coordenadas del destino (Geocoding)
            // Usamos 'proximity' para buscar lugares CERCA de tu ubicaciÃ³n GPS actual
            const searchUrl = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?proximity=${state.currentLoc[0]},${state.currentLoc[1]}&access_token=${MAPBOX_TOKEN}`;

            try {
                const resGeo = await fetch(searchUrl);
                const dataGeo = await resGeo.json();

                if (!dataGeo.features || dataGeo.features.length === 0) {
                    alert(texts[state.lang].notFound);
                    speak(texts[state.lang].notFound);
                    return;
                }

                // Tomamos el primer resultado
                const destinoCoords = dataGeo.features[0].center; // [lon, lat]
                console.log("Destino encontrado:", dataGeo.features[0].place_name, destinoCoords);

                // Paso B: Calcular Ruta caminando
                obtenerRuta(state.currentLoc, destinoCoords);

            } catch (e) {
                console.error(e);
                alert("Error de conexiÃ³n API");
            }
        });

        async function obtenerRuta(start, end) {
            const url = `https://api.mapbox.com/directions/v5/mapbox/walking/${start[0]},${start[1]};${end[0]},${end[1]}?steps=true&geometries=geojson&access_token=${MAPBOX_TOKEN}`;
            
            const res = await fetch(url);
            const data = await res.json();

            if (data.routes && data.routes[0]) {
                const route = data.routes[0];
                renderRoute(route.geometry.coordinates);
                
                // Mensaje inicial con distancia
                const msg = state.lang === 'es' 
                    ? `Destino a ${Math.round(route.distance)} metros.` 
                    : `Destination is ${Math.round(route.distance)} meters away.`;
                speak(msg);

                // Iniciar monitor de pasos (simplificado)
                monitorSteps(route.legs[0].steps);
            }
        }

        function renderRoute(coords) {
            const container = document.getElementById('route-container');
            container.innerHTML = ''; 

            // Dibujar flechas
            coords.forEach((coord, i) => {
                if (i % 2 !== 0) return; // OptimizaciÃ³n: dibujar 1 de cada 2 puntos

                const el = document.createElement('a-entity');
                el.setAttribute('gps-new-entity-place', `latitude: ${coord[1]}; longitude: ${coord[0]}`);
                el.setAttribute('geometry', 'primitive: cone; radiusBottom: 0.2; height: 1'); // Cono mÃ¡s pequeÃ±o
                el.setAttribute('material', 'color: yellow'); // Color amarillo mÃ¡s visible en calle
                el.setAttribute('position', '0 0 0');
                container.appendChild(el);
            });
        }

        function monitorSteps(steps) {
            // LÃ³gica simple para leer la primera instrucciÃ³n
            if(steps.length > 0) {
                speak(steps[0].maneuver.instruction);
            }
        }

        /**
         * 4. SISTEMA DE VOZ
         */
        ui.btnVoice.addEventListener('click', () => {
            state.voiceEnabled = !state.voiceEnabled;
            ui.btnVoice.innerText = state.voiceEnabled ? texts[state.lang].voiceOn : texts[state.lang].voiceOff;
            if(!state.voiceEnabled) window.speechSynthesis.cancel();
        });

        function speak(text) {
            if (!state.voiceEnabled) return;
            window.speechSynthesis.cancel(); // Detener voz anterior
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = state.lang === 'es' ? 'es-MX' : 'en-US'; // EspaÃ±ol Latam o Ingles US
            window.speechSynthesis.speak(utterance);
        }

        // Inicializar textos
        updateTexts();

    </script>
</body>
</html>
