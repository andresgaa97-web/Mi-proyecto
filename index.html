<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Nav Pro - Modern UI</title>
    
    <!-- A-FRAME & AR.JS -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js'></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
    
    <!-- MAPBOX GL JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

    <!-- ESTILOS (CSS) -->
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; }
        
        /* --- VISTA DE MAPA (Estilo Uber/Google) --- */
        #map-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20;
            background: white; display: flex; flex-direction: column;
        }

        #map { flex-grow: 1; width: 100%; position: relative; }

        /* Pin central fijo (Crosshair) */
        #center-pin {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -100%); /* La punta del pin en el centro */
            z-index: 10; pointer-events: none;
            transition: transform 0.2s;
        }
        #center-pin img { width: 40px; drop-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .pin-lifted { transform: translate(-50%, -120%) scale(1.1) !important; }

        /* Panel de Inputs Superior */
        .search-panel {
            position: absolute; top: 0; left: 0; width: 100%;
            background: white; padding: 15px 15px 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 30; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;
        }
        
        .input-group {
            display: flex; align-items: center; margin-bottom: 10px;
            background: #f0f2f5; border-radius: 10px; padding: 5px 10px;
        }
        .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; }
        .dot.blue { background: #3b82f6; }
        .dot.red { background: #ef4444; }
        
        input {
            border: none; background: transparent; padding: 10px; width: 100%;
            font-size: 16px; outline: none;
        }
        
        /* Botones Flotantes Mapa */
        .map-buttons {
            position: absolute; bottom: 30px; left: 0; width: 100%;
            display: flex; flex-direction: column; align-items: center; gap: 15px;
            z-index: 30; pointer-events: none; /* Para dejar pasar clicks a los lados */
        }
        
        .btn {
            pointer-events: auto;
            border: none; border-radius: 50px;
            font-weight: bold; font-size: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: transform 0.1s; cursor: pointer;
        }
        .btn:active { transform: scale(0.95); }

        .btn-gps {
            background: white; color: #333;
            width: 50px; height: 50px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; align-self: flex-end; margin-right: 20px;
        }

        .btn-confirm {
            background: #111; color: white;
            padding: 15px 60px; font-size: 18px;
        }
        .btn-confirm:disabled { background: #ccc; }

        /* Selecci√≥n de modo (Inicio vs Destino) */
        .mode-selector {
            display: flex; gap: 10px; justify-content: center; margin-bottom: 10px;
        }
        .pill {
            padding: 5px 15px; border-radius: 20px; border: 1px solid #ddd;
            font-size: 14px; color: #666; cursor: pointer;
        }
        .pill.active { background: #111; color: white; border-color: #111; }

        /* --- VISTA AR --- */
        #ar-view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; display: none; /* Oculto al inicio */
        }

        #ar-hud {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 50;
        }

        /* Panel de instrucciones AR */
        .nav-card {
            position: absolute; top: 20px; left: 5%; width: 90%;
            background: rgba(20,20,20,0.9); color: white;
            padding: 20px; border-radius: 15px;
            backdrop-filter: blur(5px);
            border-left: 5px solid #00ff88;
        }
        .nav-big-text { font-size: 24px; font-weight: 800; margin-bottom: 5px;}
        .nav-sub-text { font-size: 16px; color: #ccc; }

        .btn-exit {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #ef4444; color: white; padding: 10px 30px;
            pointer-events: auto;
        }
    </style>
</head>

<body>

    <!-- === 1. VISTA DE MAPA === -->
    <div id="map-container">
        <!-- Panel de b√∫squeda -->
        <div class="search-panel">
            <div class="mode-selector">
                <div id="mode-start" class="pill active">Fijar Inicio</div>
                <div id="mode-dest" class="pill">Fijar Destino</div>
            </div>

            <div class="input-group" onclick="setMode('start')">
                <div class="dot blue"></div>
                <input id="input-start" placeholder="Selecciona punto de inicio..." readonly>
            </div>
            <div class="input-group" onclick="setMode('dest')">
                <div class="dot red"></div>
                <input id="input-dest" placeholder="Selecciona punto de destino..." readonly>
            </div>
        </div>

        <!-- Mapa -->
        <div id="map">
            <!-- El Pin central que no se mueve -->
            <div id="center-pin">
                <!-- Icono de Pin SVG -->
                <img src="https://cdn-icons-png.flaticon.com/512/854/854878.png" alt="Pin">
            </div>
        </div>

        <!-- Botones inferiores -->
        <div class="map-buttons">
            <button class="btn btn-gps" onclick="centerOnUser()">üìç</button>
            <button id="btn-confirm" class="btn btn-confirm" disabled>Confirmar Ruta</button>
        </div>
    </div>


    <!-- === 2. VISTA AR === -->
    <div id="ar-view">
        <!-- Interfaz HUD (Capa superior) -->
        <div id="ar-hud">
            <div class="nav-card">
                <div id="ar-instruction" class="nav-big-text">Iniciando...</div>
                <div id="ar-distance" class="nav-sub-text">Calculando ruta</div>
            </div>
            <button class="btn btn-exit" onclick="exitAR()">‚ùå Salir</button>
        </div>

        <!-- Escena 3D -->
        <a-scene 
            vr-mode-ui="enabled: false"
            renderer="logarithmicDepthBuffer: true; alpha: true;" 
            embedded
            arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;">
            
            <!-- Simulamos GPS. Reduce minDistance para mayor fluidez -->
            <a-camera gps-camera="minDistance: 2; gpsMinDistance: 2;" rotation-reader>
                <!-- FLECHA HUD FLOTANTE (Pegada a la c√°mara pero rota hacia el destino) -->
                <!-- Se actualizar√° v√≠a JS para apuntar al siguiente punto -->
                <a-entity id="guide-arrow" position="0 -0.5 -2" rotation="0 0 0" visible="false">
                    <a-cone color="#00ff88" radius-bottom="0.1" radius-top="0.01" height="0.5" rotation="-90 0 0" position="0 0 0" opacity="0.8"></a-cone>
                    <a-ring color="#00ff88" radius-inner="0.15" radius-outer="0.18" position="0 0 0.2" rotation="-90 0 0" opacity="0.5"></a-ring>
                </a-entity>
            </a-camera>

            <!-- Contenedor de objetos del mundo real -->
            <a-entity id="world-container"></a-entity>
        </a-scene>
    </div>


    <!-- === L√ìGICA JAVASCRIPT === -->
    <script>
        // --- CONFIGURACI√ìN ---
        const MAPBOX_TOKEN = 'pk.eyJ1IjoiYW5keWc5NyIsImEiOiJjbWpwN20zcGoyYjFzM2ZveTIzZ2s5Mm56In0.FsNncSP8DrD6zTXpw0MaEg';
        mapboxgl.accessToken = MAPBOX_TOKEN;

        // Estado Global
        let state = {
            mode: 'start', // 'start' o 'dest'
            startCoords: null,
            destCoords: null,
            userLoc: null,
            isDragging: false,
            routeSteps: [], // Pasos de la ruta
            nextStepIndex: 0
        };

        // Elementos DOM
        const ui = {
            mapContainer: document.getElementById('map-container'),
            arView: document.getElementById('ar-view'),
            inputStart: document.getElementById('input-start'),
            inputDest: document.getElementById('input-dest'),
            btnConfirm: document.getElementById('btn-confirm'),
            pillStart: document.getElementById('mode-start'),
            pillDest: document.getElementById('mode-dest'),
            centerPin: document.getElementById('center-pin'),
            arInstr: document.getElementById('ar-instruction'),
            arDist: document.getElementById('ar-distance'),
            world: document.getElementById('world-container'),
            guideArrow: document.getElementById('guide-arrow')
        };

        // --- 1. INICIALIZAR MAPA ---
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v11', // Mapa oscuro (m√°s moderno)
            center: [-109.72148, 23.10468], // Centro por defecto
            zoom: 14,
            pitch: 0
        });

        // Marcadores visuales para Inicio y Fin (una vez fijados)
        const markers = {
            start: new mapboxgl.Marker({ color: '#3b82f6', scale: 0.8 }).setLngLat([0,0]).addTo(map),
            dest: new mapboxgl.Marker({ color: '#ef4444', scale: 0.8 }).setLngLat([0,0]).addTo(map)
        };
        // Ocultar marcadores inicialmente
        markers.start.getElement().style.display = 'none';
        markers.dest.getElement().style.display = 'none';

        // --- 2. INTERACCI√ìN MAPA (Estilo Uber) ---
        
        // Al mover el mapa, el pin "se levanta"
        map.on('movestart', () => {
            state.isDragging = true;
            ui.centerPin.classList.add('pin-lifted');
        });

        // Al soltar el mapa, capturamos la coordenada central
        map.on('moveend', async () => {
            state.isDragging = false;
            ui.centerPin.classList.remove('pin-lifted');
            
            const center = map.getCenter();
            const coords = [center.lng, center.lat];

            // Geocoding inverso para obtener nombre de la calle
            const address = await getAddress(coords);

            if (state.mode === 'start') {
                state.startCoords = coords;
                ui.inputStart.value = address;
                markers.start.setLngLat(coords).getElement().style.display = 'block';
            } else {
                state.destCoords = coords;
                ui.inputDest.value = address;
                markers.dest.setLngLat(coords).getElement().style.display = 'block';
            }
            
            checkReady();
        });

        // Cambio de modo (click en pills o inputs)
        window.setMode = (mode) => {
            state.mode = mode;
            // Actualizar UI visual
            if(mode === 'start') {
                ui.pillStart.classList.add('active');
                ui.pillDest.classList.remove('active');
                ui.centerPin.querySelector('img').src = "https://cdn-icons-png.flaticon.com/512/854/854878.png"; // Icono Azul (puedes cambiarlo)
                if(state.startCoords) map.flyTo({ center: state.startCoords });
            } else {
                ui.pillStart.classList.remove('active');
                ui.pillDest.classList.add('active');
                ui.centerPin.querySelector('img').src = "https://cdn-icons-png.flaticon.com/512/684/684908.png"; // Icono Rojo
                if(state.destCoords) map.flyTo({ center: state.destCoords });
            }
        };

        // Bot√≥n "Mi Ubicaci√≥n"
        window.centerOnUser = () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const coords = [pos.coords.longitude, pos.coords.latitude];
                    state.userLoc = coords;
                    map.flyTo({ center: coords, zoom: 16 });
                    // Si estamos en modo start, fijamos esto autom√°ticamente
                    if (state.mode === 'start') {
                        state.startCoords = coords;
                        ui.inputStart.value = "Mi ubicaci√≥n actual";
                    }
                }, () => alert("Activa el GPS"));
            }
        };

        // Geocoding Helper
        async function getAddress(coords) {
            ui.btnConfirm.innerText = "Buscando calle...";
            const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${coords[0]},${coords[1]}.json?access_token=${MAPBOX_TOKEN}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                checkReady();
                return data.features[0]?.place_name?.split(',')[0] || "Ubicaci√≥n marcada";
            } catch(e) { return "Coordenadas fijas"; }
        }

        function checkReady() {
            if (state.startCoords && state.destCoords) {
                ui.btnConfirm.disabled = false;
                ui.btnConfirm.innerText = "Confirmar Ruta e Iniciar AR";
                ui.btnConfirm.style.background = "#00c853";
            } else {
                ui.btnConfirm.innerText = state.mode === 'start' ? "Mueve el mapa para fijar Inicio" : "Mueve el mapa para fijar Destino";
                ui.btnConfirm.disabled = true;
                ui.btnConfirm.style.background = "#111";
            }
        }

        // --- 3. INICIO DE RUTA AR ---
        ui.btnConfirm.addEventListener('click', async () => {
            // Obtener ruta de Mapbox
            const url = `https://api.mapbox.com/directions/v5/mapbox/walking/${state.startCoords[0]},${state.startCoords[1]};${state.destCoords[0]},${state.destCoords[1]}?steps=true&geometries=geojson&access_token=${MAPBOX_TOKEN}`;
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                
                if (!data.routes || data.routes.length === 0) {
                    alert("No se encontr√≥ ruta entre estos puntos.");
                    return;
                }

                const route = data.routes[0];
                state.routeSteps = route.legs[0].steps; // Guardar pasos para la flecha guia
                const geometry = route.geometry.coordinates;

                // Cambiar vista
                ui.mapContainer.style.display = 'none';
                ui.arView.style.display = 'block';

                // Iniciar AR Rendering
                renderARPath(geometry);
                startNavigationLoop(geometry);

            } catch (e) {
                console.error(e);
                alert("Error al calcular ruta");
            }
        });

        // --- 4. RENDERIZADO AR (NO INVASIVO) ---
        function renderARPath(coords) {
            ui.world.innerHTML = ''; // Limpiar

            // Dibujamos solo "puntos" sutiles en el camino (Esferas flotantes peque√±as)
            // No flechas gigantes, solo gu√≠as.
            coords.forEach((coord, i) => {
                if (i % 3 !== 0) return; // Optimizar: 1 de cada 3 puntos

                const dot = document.createElement('a-entity');
                dot.setAttribute('gps-new-entity-place', `latitude: ${coord[1]}; longitude: ${coord[0]}`);
                
                // Esfera brillante peque√±a color cian
                const sphere = document.createElement('a-sphere');
                sphere.setAttribute('radius', '0.2');
                sphere.setAttribute('color', '#00ff88');
                sphere.setAttribute('opacity', '0.6');
                sphere.setAttribute('position', '0 0 0'); // Altura relativa al GPS device
                
                // Animaci√≥n de pulsaci√≥n
                sphere.setAttribute('animation', 'property: opacity; to: 0.2; dir: alternate; dur: 1000; loop: true');

                dot.appendChild(sphere);
                ui.world.appendChild(dot);
            });
        }

        // --- 5. L√ìGICA DE NAVEGACI√ìN Y FLECHA GU√çA ---
        function startNavigationLoop(fullPathCoords) {
            state.nextStepIndex = 1; // Empezamos apuntando al segundo punto (el primero es donde estamos)
            ui.guideArrow.setAttribute('visible', 'true');

            // Voz
            speak("Iniciando ruta. Sigue la flecha.");

            // Loop de control (cada 1s)
            setInterval(() => {
                // Necesitamos la posici√≥n actual del usuario (GPS real)
                // AR.js mueve la c√°mara, pero para c√°lculos matem√°ticos necesitamos coords raw
                navigator.geolocation.getCurrentPosition(pos => {
                    const userLat = pos.coords.latitude;
                    const userLon = pos.coords.longitude;
                    
                    // Encontrar el punto m√°s cercano de la ruta para saber donde estamos
                    // (Simplificado: solo miramos al siguiente punto objetivo)
                    const target = fullPathCoords[state.nextStepIndex];
                    if (!target) return; // Fin de ruta

                    const dist = getDistance(userLat, userLon, target[1], target[0]);

                    // Actualizar textos HUD
                    ui.arDist.innerText = `Siguiente punto a ${Math.round(dist)}m`;

                    // Calcular hacia donde debe apuntar la flecha HUD
                    // La flecha es hija de la c√°mara. Si rotamos la flecha en Y, girar√° relativa a donde miro.
                    // Pero necesitamos que apunte al Norte Geogr√°fico relativo.
                    
                    // NOTA: Esta parte es compleja en WebAR por la br√∫jula. 
                    // Vamos a simplificar usando "look-at" l√≥gico.
                    
                    // Si estamos cerca (< 10m), pasar al siguiente punto
                    if (dist < 10) {
                        state.nextStepIndex++;
                        if (state.nextStepIndex >= fullPathCoords.length) {
                            ui.arInstr.innerText = "¬°Llegaste!";
                            speak("Has llegado a tu destino");
                            ui.guideArrow.setAttribute('visible', 'false');
                        } else {
                            speak("Contin√∫a recto");
                        }
                    }

                    // Actualizar instrucci√≥n de texto si hay pasos disponibles
                    // (Aqu√≠ podr√≠as cruzar con state.routeSteps para textos como "Gira a la derecha")
                    
                }, err => console.warn(err), { enableHighAccuracy: true });
            }, 1000);
        }

        // --- UTILIDADES ---
        window.exitAR = () => {
            ui.arView.style.display = 'none';
            ui.mapContainer.style.display = 'flex';
            window.location.reload(); // Recargar para limpiar memoria AR
        };

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const dLat = (lat2-lat1) * Math.PI/180;
            const dLon = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function speak(txt) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(txt);
            u.lang = 'es-MX';
            window.speechSynthesis.speak(u);
        }

        // Listener eventos de pil
        ui.pillStart.addEventListener('click', () => setMode('start'));
        ui.pillDest.addEventListener('click', () => setMode('dest'));
        
        // Inicializar ubicaci√≥n usuario al abrir
        centerOnUser();

    </script>
</body>
</html>
