<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>BajaStay Concierge</title>

    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">

    <!-- LIBRARIES -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script type='text/javascript'
        src='https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js'></script>
    <script type='text/javascript'
        src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

    <style>
        :root {
            --primary: #000000;
            --accent: #00F3FF;
            --glass: rgba(15, 15, 15, 0.95);
            --text: #ffffff;
            --font: 'Outfit', sans-serif;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background: var(--primary);
            font-family: var(--font);
            color: var(--text);
            overflow: hidden;
        }

        /* === LOADING === */
        #loading-screen {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s;
        }

        /* === MAIN VIEW === */
        #map-view {
            position: absolute;
            inset: 0;
            z-index: 100;
            display: flex;
            flex-direction: column;
            transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1);
        }

        #map-view.hidden {
            transform: translateY(100%);
        }

        /* === HEADER === */
        .header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.95) 0%, rgba(0, 0, 0, 0) 100%);
            z-index: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
            pointer-events: none;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            pointer-events: auto;
        }

        /* LOGO FIX: Forced dimensions and background */
        .logo-container {
            width: 50px;
            height: 50px;
            min-width: 50px;
            min-height: 50px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.15);
        }

        .logo-img {
            width: 90%;
            height: 90%;
            object-fit: contain;
            display: block;
        }

        .brand-text h1 {
            margin: 0;
            font-size: 20px;
            font-weight: 800;
            line-height: 1;
        }

        .brand-text p {
            margin: 0;
            font-size: 10px;
            font-weight: 600;
            opacity: 0.8;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--accent);
        }

        .header-controls {
            display: flex;
            gap: 10px;
            pointer-events: auto;
        }

        .icon-btn {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: 0.2s;
        }

        .icon-btn:active {
            transform: scale(0.9);
            background: var(--accent);
            color: black;
        }

        .icon-btn.active {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* === MODE SELECTION PANEL === */
        #route-panel {
            position: absolute;
            top: 90px;
            left: 20px;
            right: 20px;
            background: var(--glass);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            z-index: 400;
            display: none;
            /* Hidden by default */
        }

        #route-panel.visible {
            display: block;
        }

        .panel-title {
            font-size: 14px;
            font-weight: 700;
            color: #888;
            margin-bottom: 15px;
            text-transform: uppercase;
        }

        .route-opt {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            border: 1px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .route-opt:hover {
            border-color: var(--accent);
        }

        .route-opt h3 {
            margin: 0 0 5px 0;
            font-size: 16px;
        }

        .route-opt p {
            margin: 0;
            font-size: 12px;
            opacity: 0.6;
        }

        .manual-inputs input {
            width: 100%;
            background: black;
            border: 1px solid #333;
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-family: var(--font);
            font-size: 12px;
        }

        /* === BOTTOM CARD === */
        .bottom-card {
            position: absolute;
            bottom: 30px;
            left: 20px;
            right: 20px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 24px;
            z-index: 200;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
        }

        .trip-data {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 20px;
        }

        .stat-big {
            font-size: 24px;
            font-weight: 800;
            color: var(--accent);
        }

        .stat-label {
            font-size: 11px;
            color: #888;
        }

        .btn-main {
            width: 100%;
            background: white;
            color: black;
            font-weight: 800;
            padding: 16px;
            border-radius: 14px;
            border: none;
            font-size: 16px;
            letter-spacing: 1px;
            cursor: pointer;
        }

        .btn-main:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* === AR VIEW & HUD === */
        #ar-view {
            position: absolute;
            inset: 0;
            z-index: 50;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.5s;
        }

        #ar-view.visible {
            visibility: visible;
            opacity: 1;
        }

        .hud-overlay {
            position: absolute;
            inset: 0;
            padding: 20px;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .hud-top {
            pointer-events: auto;
            display: flex;
            justify-content: space-between;
        }

        .nav-card {
            background: rgba(0, 0, 0, 0.85);
            padding: 15px 20px;
            border-radius: 16px;
            border-left: 4px solid var(--accent);
            color: white;
        }

        /* FAKE 3D ARROW */
        .arrow-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .arrow-svg {
            width: 120px;
            height: 120px;
            overflow: visible;
            transition: transform 0.1s linear;
        }

        .loader {
            width: 30px;
            height: 30px;
            border: 3px solid #333;
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s infinite linear;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <!-- LOADING SCREEN -->
    <div id="loading-screen">
        <div class="logo-container" style="margin-bottom: 20px;">
            <img src="logo.png" class="logo-img" alt="Logo">
        </div>
        <div class="loader"></div>
    </div>

    <!-- MAP VIEW -->
    <div id="map-view">
        <div class="header">
            <div class="header-left">
                <div class="logo-container">
                    <img src="logo.png" class="logo-img" alt="Logo" onerror="this.src='logo.jpeg'">
                </div>
                <div class="brand-text">
                    <h1>BAJASTAY</h1>
                    <p>CONCIERGE</p>
                </div>
            </div>
            <div class="header-controls">
                <button class="icon-btn" onclick="toggleLang()" id="btn-lang">ES</button>
                <button class="icon-btn" onclick="togglePanel()">‚öôÔ∏è</button>
            </div>
        </div>

        <!-- ROUTE SELECTION PANEL -->
        <div id="route-panel">
            <div class="panel-title" id="txt-panel-title">CONFIGURACI√ìN DE RUTA</div>

            <!-- DEFAULT ROUTE BTN -->
            <div class="route-opt" onclick="loadDefaultRoute()">
                <div>
                    <h3 style="color:var(--accent);">‚òÖ DEFAULT</h3>
                    <p id="txt-default-desc">Aeropuerto ‚ûú Chametla ‚ûú BajaStay</p>
                </div>
                <div>‚ûú</div>
            </div>

            <!-- MANUAL TOOLS -->
            <div style="margin-top:20px;">
                <div class="panel-title" id="txt-manual-title">MODO MANUAL</div>
                <p style="font-size:11px; opacity:0.6; margin-bottom:10px;" id="txt-manual-instr">Haz clic en el mapa
                    para: 1. Inicio, 2. Waypoint, 3. Destino</p>
                <button class="icon-btn" style="width:100%; border-radius:10px; font-size:14px;"
                    onclick="resetMapClicks()" id="txt-reset">REINICIAR PUNTOS</button>
            </div>
        </div>

        <div id="map" style="flex:1;"></div>

        <div class="bottom-card">
            <div class="trip-data">
                <div>
                    <div class="stat-label" id="txt-dest-label">DESTINO</div>
                    <div style="font-size:20px; font-weight:700;">BajaStay Airbnb</div>
                </div>
                <div style="text-align:right;">
                    <div class="stat-big" id="trip-time">-- min</div>
                    <div class="stat-label" id="trip-dist">-- km</div>
                </div>
            </div>
            <button class="btn-main" id="btn-start" onclick="startAR()" disabled>INICIAR RUTA</button>
        </div>
    </div>

    <!-- AR VIEW -->
    <div id="ar-view">
        <a-scene vr-mode-ui="enabled: false" embedded renderer="logarithmicDepthBuffer: true; alpha: true;"
            arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true; displayWidth: 1280; displayHeight: 720;">
            <a-camera gps-camera="minDistance: 1; gpsMinDistance: 1;" rotation-reader></a-camera>
        </a-scene>

        <div class="hud-overlay">
            <div class="hud-top">
                <div class="nav-card">
                    <div style="font-size:18px; font-weight:700;" id="nav-instr">...</div>
                    <div style="font-size:12px; opacity:0.7; margin-top:4px;" id="nav-dist">-- m</div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="icon-btn" onclick="toggleVoice()" id="btn-voice">üîä</button>
                    <button class="icon-btn" style="background:#ff3b30; border:none;" onclick="stopAR()">‚úï</button>
                </div>
            </div>

            <!-- 3D ARROW -->
            <div class="arrow-container">
                <svg class="arrow-svg" id="arrow-icon" viewBox="0 0 100 100">
                    <filter id="f1" x="-20%" y="-20%" width="140%" height="140%">
                        <feDropShadow dx="0" dy="5" stdDeviation="5" flood-color="#000" flood-opacity="0.5" />
                    </filter>
                    <path d="M50 10 L90 80 L50 65 L10 80 Z" fill="#00F3FF" stroke="white" stroke-width="2"
                        filter="url(#f1)" />
                    <path d="M50 65 L90 80 L50 90 L10 80 Z" fill="#008c94" opacity="0.6" />
                    <!-- Under side for 3D feel -->
                </svg>
            </div>
        </div>
    </div>

    <script>
        // === CONFIG ===
        const TOKEN = 'pk.eyJ1IjoiYW5keWc5NyIsImEiOiJjbWpwN20zcGoyYjFzM2ZveTIzZ2s5Mm56In0.FsNncSP8DrD6zTXpw0MaEg';
        mapboxgl.accessToken = TOKEN;

        // COORDENADAS RUTA DEFAULT (Exactas del link)
        const DEFAULT_START = [-110.3626, 24.0726]; // Aeropuerto
        const DEFAULT_WP = [-110.393072, 24.097741]; // Punto Clave
        const DEFAULT_DEST = [-110.392168, 24.095156]; // Airbnb

        // === STATE ===
        let app = {
            lang: 'es', // 'es' | 'en'
            voice: true,
            navigating: false,
            route: null,
            step: 0,
            simulatedStart: DEFAULT_START,
            markers: [] // To store markers user adds
        };

        // === TEXTS (Translations) ===
        const DICT = {
            es: {
                start: "INICIAR RUTA", dest: "DESTINO", loading: "Cargando...",
                pTitle: "CONFIGURACI√ìN", pManual: "MODO MANUAL",
                instr: "Toca el mapa: 1. Inicio, 2. Intermedio, 3. Fin",
                reset: "REINICIAR MAPA", defDesc: "Aeropuerto ‚ûú Airbnb",
                welcome: "Bienvenido. Navegaci√≥n iniciada.",
                nav: {
                    straight: "Sigue recto", left: "Gira a la izquierda", right: "Gira a la derecha", arrive: "Has llegado, destino a la derecha"
                }
            },
            en: {
                start: "START ROUTE", dest: "DESTINATION", loading: "Loading...",
                pTitle: "SETTINGS", pManual: "MANUAL MODE",
                instr: "Tap map: 1. Start, 2. Waypoint, 3. Dest",
                reset: "RESET MAP", defDesc: "Airport ‚ûú Airbnb",
                welcome: "Welcome. Navigation started.",
                nav: {
                    straight: "Go straight", left: "Turn left", right: "Turn right", arrive: "You have arrived, destination on right"
                }
            }
        };

        // === INITIALIZATION ===
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v11',
            center: DEFAULT_START,
            zoom: 12,
            attributionControl: false
        });

        const els = {
            loader: document.getElementById('loading-screen'),
            panel: document.getElementById('route-panel'),
            btnStart: document.getElementById('btn-start'),
            tripTime: document.getElementById('trip-time'),
            tripDist: document.getElementById('trip-dist'),
            arrow: document.getElementById('arrow-icon')
        };

        map.on('load', () => {
            els.loader.style.opacity = '0';
            setTimeout(() => els.loader.style.display = 'none', 500);

            // Auto Select Default Route
            loadDefaultRoute();

            // Map Click Listeners for Manual Mode
            map.on('click', handleMapClick);
        });

        // === ROUTE LOGIC ===
        async function loadDefaultRoute() {
            clearMarkers();
            // Add Start
            addMarker(DEFAULT_START, '#ffffff'); // White for Start
            // Add WP
            addMarker(DEFAULT_WP, '#aaaaaa'); // Gray for WP
            // Add Dest
            addMarker(DEFAULT_DEST, '#00F3FF'); // Cyan for Dest

            // Calc Route
            await getRoute([DEFAULT_START, DEFAULT_WP, DEFAULT_DEST]);

            // Zoom to fit
            const bounds = new mapboxgl.LngLatBounds();
            [DEFAULT_START, DEFAULT_WP, DEFAULT_DEST].forEach(p => bounds.extend(p));
            map.fitBounds(bounds, { padding: 80 });

            // Close panel if open
            els.panel.classList.remove('visible');
        }

        async function getRoute(points) {
            // Join coords
            const str = points.map(p => `${p[0]},${p[1]}`).join(';');
            const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${str}?steps=true&geometries=geojson&access_token=${TOKEN}`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                if (!data.routes.length) return;

                app.route = data.routes[0];
                const geo = app.route.geometry;

                if (map.getSource('route')) map.getSource('route').setData(geo);
                else {
                    map.addLayer({
                        id: 'route', type: 'line', source: { type: 'geojson', data: geo },
                        layout: { 'line-join': 'round', 'line-cap': 'round' },
                        paint: { 'line-color': '#00F3FF', 'line-width': 6, 'line-opacity': 0.8 }
                    });
                }

                // Update UI
                const min = Math.round(app.route.duration / 60);
                const km = (app.route.distance / 1000).toFixed(1);
                els.tripTime.innerText = `${min} min`;
                els.tripDist.innerText = `${km} km`;

                els.btnStart.disabled = false;

                // Set start for AR logic
                app.simulatedStart = points[0];

            } catch (e) { console.error(e); }
        }

        // === MANUAL MAP LOGIC ===
        let clickPoints = [];
        function handleMapClick(e) {
            if (!els.panel.classList.contains('visible')) return; // Only if panel open? OR always? Let's say only if panel open to avoid accidental clicks

            const coord = [e.lngLat.lng, e.lngLat.lat];
            clickPoints.push(coord);

            let color = '#ffffff';
            if (clickPoints.length === 2) color = '#aaaaaa';
            if (clickPoints.length >= 3) color = '#00F3FF';

            addMarker(coord, color);

            // If we have at least 2 points, route
            if (clickPoints.length >= 2) {
                getRoute(clickPoints);
            }
        }

        function resetMapClicks() {
            clearMarkers();
            clickPoints = [];
            if (map.getSource('route')) map.getSource('route').setData({ type: 'Feature', geometry: { type: 'LineString', coordinates: [] } });
            els.btnStart.disabled = true;
            els.tripTime.innerText = "--";
        }

        function addMarker(lngLat, color) {
            const m = new mapboxgl.Marker({ color: color }).setLngLat(lngLat).addTo(map);
            app.markers.push(m);
        }

        function clearMarkers() {
            app.markers.forEach(m => m.remove());
            app.markers = [];
        }

        // === UI CONTROLS ===
        window.togglePanel = () => els.panel.classList.toggle('visible');

        window.toggleLang = () => {
            app.lang = app.lang === 'es' ? 'en' : 'es';
            const t = DICT[app.lang];

            // Update Buttons
            document.getElementById('btn-lang').innerText = app.lang.toUpperCase();
            document.getElementById('txt-panel-title').innerText = t.pTitle;
            document.getElementById('txt-default-desc').innerText = t.defDesc;
            document.getElementById('txt-manual-title').innerText = t.pManual;
            document.getElementById('txt-manual-instr').innerText = t.instr;
            document.getElementById('txt-reset').innerText = t.reset;
            document.getElementById('txt-dest-label').innerText = t.dest;
            document.getElementById('btn-start').innerText = t.start;
        };

        window.toggleVoice = () => {
            app.voice = !app.voice;
            document.getElementById('btn-voice').innerText = app.voice ? "üîä" : "üîá";
        }

        // === AR & NAVIGATION ===
        window.startAR = () => {
            // Close map, show AR
            document.getElementById('map-view').classList.add('hidden');
            document.getElementById('ar-view').classList.add('visible');
            app.navigating = true;

            speak(DICT[app.lang].welcome);
            startARLoop();
        };

        window.stopAR = () => {
            document.getElementById('map-view').classList.remove('hidden');
            document.getElementById('ar-view').classList.remove('visible');
            app.navigating = false;
            window.speechSynthesis.cancel();
        };

        function startARLoop() {
            let lastHead = 0;
            let lastSpeak = 0;
            let currentInstrKey = ""; // Store key like 'straight', 'left'

            window.addEventListener('deviceorientation', e => {
                let h = e.webkitCompassHeading || (360 - e.alpha);
                if (!h) return;
                // Smooth
                const d = h - lastHead;
                const adj = (d > 180) ? d - 360 : (d < -180 ? d + 360 : d);
                lastHead = (lastHead + (adj * 0.1) + 360) % 360;
            });

            const AR_START = app.simulatedStart; // Simulating we are at route start

            navigator.geolocation.watchPosition(pos => {
                if (!app.navigating) return;

                // For demo: Use GPS. In real life, user might be far from route start.
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                // TODO: Project position to route line for production. 
                // For MVP: Simple step tracking.

                const steps = app.route.geometry.coordinates;
                let target = steps[app.step];
                const d = dist(lat, lng, target[1], target[0]);

                if (d < 25 && app.step < steps.length - 1) app.step++;

                // Bearing
                const b = bearing(lat, lng, target[1], target[0]);
                const rel = b - lastHead;
                els.arrow.style.transform = `rotate(${rel}deg)`;

                // Instrucci√≥n
                const txt = DICT[app.lang].nav;
                let key = "straight";
                if (rel < -25) key = "left";
                if (rel > 25) key = "right";
                if (d < 20 && app.step >= steps.length - 5) key = "arrive";

                document.getElementById('nav-instr').innerText = txt[key];
                document.getElementById('nav-dist').innerText = Math.round(d) + " m";

                // Voice (English Accent Fix: passing correct text from dictionary)
                const now = Date.now();
                if (app.voice && (now - lastSpeak > 10000 || key !== currentInstrKey)) {
                    speak(txt[key]);
                    lastSpeak = now;
                    currentInstrKey = key;
                }

            }, null, { enableHighAccuracy: true });
        }

        function speak(text) {
            if (!app.voice) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            // Force accent based on lang
            u.lang = app.lang === 'es' ? 'es-MX' : 'en-US';
            window.speechSynthesis.speak(u);
        }

        function dist(la1, lo1, la2, lo2) {
            const R = 6371e3, p1 = la1 * Math.PI / 180, p2 = la2 * Math.PI / 180;
            const a = 0.5 - Math.cos((la2 - la1) * Math.PI / 180) / 2 + Math.cos(p1) * Math.cos(p2) * (1 - Math.cos((lo2 - lo1) * Math.PI / 180)) / 2;
            return R * 2 * Math.asin(Math.sqrt(a));
        }

        function bearing(la1, lo1, la2, lo2) {
            const y = Math.sin((lo2 - lo1) * Math.PI / 180) * Math.cos(la2 * Math.PI / 180);
            const x = Math.cos(la1 * Math.PI / 180) * Math.sin(la2 * Math.PI / 180) - Math.sin(la1 * Math.PI / 180) * Math.cos(la2 * Math.PI / 180) * Math.cos((lo2 - lo1) * Math.PI / 180);
            return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
        }

    </script>
</body>

</html>
