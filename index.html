<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>AR Nav - Ultimate</title>
    
    <!-- A-FRAME & AR.JS -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js'></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
    <!-- Look-at component para que los objetos miren al usuario -->
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    
    <!-- MAPBOX -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

    <style>
        /* --- ESTILOS GENERALES (RESPONSIVE) --- */
        :root {
            --primary: #222;
            --accent: #00e676; /* Verde Ne√≥n */
            --danger: #ff3d00;
            --bg-glass: rgba(255, 255, 255, 0.95);
        }
        
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; font-family: 'Segoe UI', Roboto, Helvetica, sans-serif; }
        
        /* === VISTA MAPA === */
        #map-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; display: flex; flex-direction: column; background: #fff; }
        #map { flex-grow: 1; width: 100%; position: relative; }

        /* Pin Central Fijo */
        #center-pin {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -100%);
            z-index: 10; pointer-events: none; transition: transform 0.2s;
        }
        #center-pin img { width: 40px; height: 40px; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.4)); }
        .pin-lift { transform: translate(-50%, -130%) scale(1.1) !important; }

        /* Panel Superior (Inputs) */
        .top-panel {
            position: absolute; top: 0; left: 0; width: 100%;
            background: var(--bg-glass);
            border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            z-index: 30; padding: 10px 15px 20px;
            box-sizing: border-box;
        }

        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .app-title { font-weight: 800; font-size: 1.2rem; color: var(--primary); }
        
        /* Selector de Idioma */
        .lang-switch {
            background: #f0f0f0; border-radius: 20px; padding: 5px; display: flex; gap: 5px;
        }
        .lang-opt {
            padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; cursor: pointer; border: 1px solid transparent;
        }
        .lang-opt.active { background: #fff; border-color: #ddd; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* Inputs de Direcci√≥n */
        .input-box {
            background: #f5f7fa; border-radius: 12px; padding: 12px; margin-bottom: 10px;
            display: flex; align-items: center; border: 1px solid transparent; transition: 0.3s;
        }
        .input-box.active-mode { border-color: var(--primary); background: #fff; }
        
        .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 12px; flex-shrink: 0; }
        .dot.blue { background: #2979ff; }
        .dot.red { background: #ff1744; }
        
        input { border: none; background: transparent; width: 100%; font-size: 0.95rem; outline: none; text-overflow: ellipsis; }

        /* Botones Mapa Inferior */
        .bottom-controls {
            position: absolute; bottom: 0; left: 0; width: 100%;
            padding: 20px; padding-bottom: 30px; box-sizing: border-box;
            background: linear-gradient(to top, rgba(255,255,255,1) 50%, transparent);
            z-index: 30; display: flex; flex-direction: column; gap: 15px; pointer-events: none;
        }
        .bottom-controls > * { pointer-events: auto; }

        .btn-gps {
            width: 45px; height: 45px; border-radius: 50%; background: #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); border: none; font-size: 1.2rem;
            align-self: flex-end; display: flex; align-items: center; justify-content: center;
        }

        .btn-main {
            width: 100%; padding: 16px; border-radius: 16px; border: none;
            font-size: 1.1rem; font-weight: 700; color: #fff;
            background: var(--primary); box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            opacity: 0.5; transition: 0.3s;
        }
        .btn-main.ready { opacity: 1; background: var(--accent); color: #000; }

        /* === VISTA AR (HUD) === */
        #ar-view { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; background: black;}
        
        /* Flecha Gu√≠a 2D (Br√∫jula UI) */
        #nav-arrow-container {
            position: absolute; top: 100px; left: 50%; transform: translateX(-50%);
            width: 80px; height: 80px; z-index: 50;
            background: rgba(0,0,0,0.6); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid rgba(255,255,255,0.2);
        }
        #nav-arrow {
            font-size: 50px; color: var(--accent);
            transform-origin: center; transition: transform 0.5s ease-out;
        }

        /* Tarjeta de Instrucciones */
        .ar-card {
            position: absolute; top: 20px; left: 20px; right: 20px;
            background: rgba(20, 20, 20, 0.9); backdrop-filter: blur(10px);
            padding: 15px 20px; border-radius: 16px; color: white;
            border-left: 6px solid var(--accent);
            z-index: 50; display: flex; flex-direction: column;
        }
        .ar-dist { font-size: 0.9rem; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }
        .ar-instr { font-size: 1.4rem; font-weight: 800; margin-top: 2px; line-height: 1.2; }

        /* Bot√≥n Salir */
        .btn-exit {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: var(--danger); color: white; padding: 12px 30px;
            border-radius: 30px; border: none; font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 61, 0, 0.4); z-index: 50;
        }

        /* Ajuste de pantalla completa para el Canvas AR */
        .a-canvas { width: 100% !important; height: 100% !important; }
    </style>
</head>
<body>

    <!-- === VISTA MAPA === -->
    <div id="map-container">
        <div class="top-panel">
            <div class="header-row">
                <span class="app-title">AR Navigation</span>
                <!-- Selector de Idioma -->
                <div class="lang-switch">
                    <div class="lang-opt active" onclick="setLang('es')">ES</div>
                    <div class="lang-opt" onclick="setLang('en')">EN</div>
                </div>
            </div>

            <!-- Inputs "Touch" para seleccionar modo -->
            <div class="input-box active-mode" id="box-start" onclick="setMode('start')">
                <div class="dot blue"></div>
                <input id="input-start" placeholder="Punto de partida..." readonly>
            </div>
            <div class="input-box" id="box-dest" onclick="setMode('dest')">
                <div class="dot red"></div>
                <input id="input-dest" placeholder="Punto de destino..." readonly>
            </div>
        </div>

        <div id="map">
            <div id="center-pin">
                <img id="pin-icon" src="https://cdn-icons-png.flaticon.com/512/684/684908.png" alt="Pin">
            </div>
        </div>

        <div class="bottom-controls">
            <button class="btn-gps" onclick="centerMapOnUser()">üìç</button>
            <button id="btn-go" class="btn-main" disabled>CONFIRMAR RUTA</button>
        </div>
    </div>

    <!-- === VISTA AR === -->
    <div id="ar-view">
        <!-- HUD Interface -->
        <div class="ar-card">
            <div class="ar-dist" id="hud-dist">0 m</div>
            <div class="ar-instr" id="hud-instr">Iniciando...</div>
        </div>

        <!-- Flecha Visual de Direcci√≥n (Br√∫jula) -->
        <div id="nav-arrow-container">
            <div id="nav-arrow">‚¨Ü</div> 
        </div>

        <button class="btn-exit" onclick="exitAR()">‚ùå STOP</button>

        <!-- Escena A-Frame -->
        <a-scene
            vr-mode-ui="enabled: false"
            embedded
            renderer="logarithmicDepthBuffer: true; alpha: true; precision: medium;"
            arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;">
            
            <a-light type="ambient" color="#ffffff" intensity="1.5"></a-light>
            
            <!-- C√°mara con GPS simulado para estabilidad -->
            <a-camera gps-camera="minDistance: 3; gpsMinDistance: 3;" rotation-reader></a-camera>

            <!-- Aqu√≠ pondremos los conos gigantes -->
            <a-entity id="world-scene"></a-entity>

        </a-scene>
    </div>

    <script>
        // === CONFIGURACI√ìN ===
        const MAPBOX_TOKEN = 'pk.eyJ1IjoiYW5keWc5NyIsImEiOiJjbWpwN20zcGoyYjFzM2ZveTIzZ2s5Mm56In0.FsNncSP8DrD6zTXpw0MaEg';
        mapboxgl.accessToken = MAPBOX_TOKEN;

        // Textos Multi-idioma
        const i18n = {
            es: {
                startPh: "Punto de partida (Mi ubicaci√≥n)",
                destPh: "Punto de destino (Mueve el mapa)",
                btnWait: "Selecciona ambos puntos",
                btnGo: "INICIAR NAVEGACI√ìN",
                arrived: "¬°Has llegado!",
                calc: "Calculando...",
                instr: "Sigue la flecha",
                exit: "SALIR"
            },
            en: {
                startPh: "Start location (My location)",
                destPh: "Destination (Move map)",
                btnWait: "Select both points",
                btnGo: "START NAVIGATION",
                arrived: "You arrived!",
                calc: "Calculating...",
                instr: "Follow the arrow",
                exit: "EXIT"
            }
        };

        // Estado
        let app = {
            lang: 'es',
            mode: 'start', // 'start' | 'dest'
            startCoords: null,
            destCoords: null,
            route: [],
            stepIndex: 0,
            navigating: false
        };

        // UI Refs
        const ui = {
            startIn: document.getElementById('input-start'),
            destIn: document.getElementById('input-dest'),
            boxStart: document.getElementById('box-start'),
            boxDest: document.getElementById('box-dest'),
            btnGo: document.getElementById('btn-go'),
            pinIcon: document.getElementById('pin-icon'),
            hudDist: document.getElementById('hud-dist'),
            hudInstr: document.getElementById('hud-instr'),
            navArrow: document.getElementById('nav-arrow'),
            world: document.getElementById('world-scene')
        };

        // --- 1. INICIALIZAR MAPA ---
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11', // Mapa claro y limpio
            center: [-109.72148, 23.10468],
            zoom: 14,
            pitch: 0,
            attributionControl: false
        });

        // Marcadores (ocultos inicialmente)
        const markerStart = new mapboxgl.Marker({ color: '#2979ff' }).setLngLat([0,0]).addTo(map);
        const markerDest = new mapboxgl.Marker({ color: '#ff1744' }).setLngLat([0,0]).addTo(map);
        markerStart.getElement().style.display = 'none';
        markerDest.getElement().style.display = 'none';

        // --- 2. INTERACCI√ìN MAPA (Estilo UBER) ---
        map.on('movestart', () => {
            document.getElementById('center-pin').classList.add('pin-lift');
        });

        map.on('moveend', async () => {
            document.getElementById('center-pin').classList.remove('pin-lift');
            const center = map.getCenter();
            const coords = [center.lng, center.lat];
            
            // Geocoding inverso para obtener nombre de calle
            const name = await getPlaceName(coords);

            if (app.mode === 'start') {
                app.startCoords = coords;
                ui.startIn.value = name;
                markerStart.setLngLat(coords).getElement().style.display = 'block';
            } else {
                app.destCoords = coords;
                ui.destIn.value = name;
                markerDest.setLngLat(coords).getElement().style.display = 'block';
            }
            checkReady();
        });

        function setMode(mode) {
            app.mode = mode;
            // Estilos Visuales
            if (mode === 'start') {
                ui.boxStart.classList.add('active-mode');
                ui.boxDest.classList.remove('active-mode');
                ui.pinIcon.src = "https://cdn-icons-png.flaticon.com/512/684/684908.png"; // Pin Azul/Gen√©rico
                ui.pinIcon.style.filter = "hue-rotate(200deg)"; // Truco CSS para hacerlo azul
                if(app.startCoords) map.flyTo({ center: app.startCoords });
            } else {
                ui.boxStart.classList.remove('active-mode');
                ui.boxDest.classList.add('active-mode');
                ui.pinIcon.src = "https://cdn-icons-png.flaticon.com/512/684/684908.png";
                ui.pinIcon.style.filter = "none"; // Rojo original
                if(app.destCoords) map.flyTo({ center: app.destCoords });
            }
        }

        async function getPlaceName(coords) {
            const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${coords[0]},${coords[1]}.json?types=address,poi&access_token=${MAPBOX_TOKEN}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                return data.features[0]?.text || "Ubicaci√≥n seleccionada";
            } catch (e) { return `${coords[1].toFixed(4)}, ${coords[0].toFixed(4)}`; }
        }

        function checkReady() {
            const txt = i18n[app.lang];
            if (app.startCoords && app.destCoords) {
                ui.btnGo.disabled = false;
                ui.btnGo.classList.add('ready');
                ui.btnGo.innerText = txt.btnGo;
            } else {
                ui.btnGo.disabled = true;
                ui.btnGo.classList.remove('ready');
                ui.btnGo.innerText = txt.btnWait;
            }
        }

        function centerMapOnUser() {
            if(!navigator.geolocation) return alert("GPS no activo");
            navigator.geolocation.getCurrentPosition(pos => {
                const userLoc = [pos.coords.longitude, pos.coords.latitude];
                map.flyTo({ center: userLoc, zoom: 16 });
                // Si estamos en modo Start, fijar auto
                if(app.mode === 'start') {
                    app.startCoords = userLoc;
                    ui.startIn.value = "üìç Mi ubicaci√≥n actual";
                }
            });
        }

        // --- 3. IDIOMA ---
        window.setLang = (lang) => {
            app.lang = lang;
            document.querySelectorAll('.lang-opt').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            
            // Actualizar placeholders
            ui.startIn.placeholder = i18n[lang].startPh;
            ui.destIn.placeholder = i18n[lang].destPh;
            checkReady();
        };
        // Inicializar textos
        setLang('es');


        // --- 4. L√ìGICA RUTA Y AR ---
        ui.btnGo.addEventListener('click', async () => {
            ui.btnGo.innerText = i18n[app.lang].calc;
            
            // Pedir Ruta a Mapbox
            const url = `https://api.mapbox.com/directions/v5/mapbox/walking/${app.startCoords[0]},${app.startCoords[1]};${app.destCoords[0]},${app.destCoords[1]}?steps=true&geometries=geojson&access_token=${MAPBOX_TOKEN}`;
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                if(!data.routes.length) return alert("No se encontr√≥ ruta");

                const route = data.routes[0];
                app.route = route.geometry.coordinates; // Array de [lon, lat]
                app.stepIndex = 1; // Empezamos yendo al 2do punto

                startAR(app.route);

            } catch(e) { console.error(e); alert("Error de conexi√≥n"); }
        });

        function startAR(pathCoords) {
            document.getElementById('map-container').style.display = 'none';
            document.getElementById('ar-view').style.display = 'block';
            
            // Limpiar escena anterior
            ui.world.innerHTML = '';

            // 1. CREAR OBJETOS EN EL MUNDO REAL (Checkpoints)
            pathCoords.forEach((coord, i) => {
                // Solo dibujar checkpoints cada 5 puntos para rendimiento
                if (i % 5 !== 0 && i !== pathCoords.length - 1) return; 

                const el = document.createElement('a-entity');
                el.setAttribute('gps-new-entity-place', `latitude: ${coord[1]}; longitude: ${coord[0]}`);
                
                // Cono Gigante Flotante
                const cone = document.createElement('a-cone');
                cone.setAttribute('color', '#00e676'); // Verde Ne√≥n
                cone.setAttribute('radius-bottom', '0.5');
                cone.setAttribute('radius-top', '0.01');
                cone.setAttribute('height', '2');
                cone.setAttribute('position', '0 2 0'); // Flotar 2m sobre el suelo (para que se vea)
                cone.setAttribute('animation', 'property: position; to: 0 2.5 0; dir: alternate; dur: 1000; loop: true');
                cone.setAttribute('opacity', '0.9');

                // Si es el final, color Rojo
                if (i === pathCoords.length - 1) cone.setAttribute('color', '#ff3d00');

                el.appendChild(cone);
                ui.world.appendChild(el);
            });

            app.navigating = true;
            navigationLoop();
        }

        // --- 5. BUCLE DE NAVEGACI√ìN (FLECHA GUIADA) ---
        function navigationLoop() {
            if(!app.navigating) return;

            // Loop cada 500ms
            setInterval(() => {
                navigator.geolocation.getCurrentPosition(pos => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    
                    // Objetivo actual
                    if (app.stepIndex >= app.route.length) {
                        ui.hudInstr.innerText = i18n[app.lang].arrived;
                        ui.navArrow.innerText = "üèÅ";
                        return;
                    }

                    const target = app.route[app.stepIndex]; // [lon, lat]
                    
                    // Distancia
                    const dist = getDistance(lat, lon, target[1], target[0]);
                    ui.hudDist.innerText = Math.round(dist) + " m";
                    ui.hudInstr.innerText = i18n[app.lang].instr;

                    // Si estamos cerca (< 15m), pasar al siguiente punto
                    if (dist < 15) {
                        app.stepIndex++;
                        speak(i18n[app.lang].instr); // Feedback de voz simple
                    }

                    // --- C√ÅLCULO DE LA FLECHA 2D ---
                    // Calculamos el √°ngulo hacia el destino (Bearing)
                    const bearing = calculateBearing(lat, lon, target[1], target[0]);
                    
                    // Intentamos obtener hacia d√≥nde mira el celular (DeviceOrientation)
                    // NOTA: Esto var√≠a por navegador. Usamos una aproximaci√≥n visual.
                    // Si no hay br√∫jula, la flecha indica el Norte relativo al mapa.
                    ui.navArrow.style.transform = `rotate(${bearing}deg)`;

                }, err => {}, { enableHighAccuracy: true });
            }, 500);
        }

        // --- √öTILES ---
        function exitAR() {
            location.reload(); // La forma m√°s segura de limpiar memoria AR
        }

        function calculateBearing(lat1, lon1, lat2, lon2) {
            const toRad = deg => deg * Math.PI / 180;
            const toDeg = rad => rad * 180 / Math.PI;
            const y = Math.sin(toRad(lon2 - lon1)) * Math.cos(toRad(lat2));
            const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
                      Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(toRad(lon2 - lon1));
            const brng = (toDeg(Math.atan2(y, x)) + 360) % 360;
            return brng;
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Radio tierra metros
            const dLat = (lat2-lat1) * Math.PI/180;
            const dLon = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function speak(text) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = app.lang === 'es' ? 'es-MX' : 'en-US';
            window.speechSynthesis.speak(u);
        }

        // Auto-fix layout inicial
        setMode('start');

    </script>
</body>
</html>
