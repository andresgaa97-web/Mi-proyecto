<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>AR Navigation Master</title>
    
    <!-- LIBRER√çAS AR (A-Frame + AR.js) -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js'></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
    <!-- Librer√≠a Look-at (Para que los textos te miren) -->
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    
    <!-- MAPBOX GL JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

    <style>
        /* --- ESTILOS GENERALES --- */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: sans-serif; }
        
        /* Contenedores Principales */
        #map-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: white; }
        #ar-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; display: none; background: black; }

        /* === MAPA (Estilo Uber) === */
        #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* Panel Superior (Inputs) */
        .top-ui {
            position: absolute; top: 0; left: 0; width: 100%;
            background: white; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); z-index: 10;
            padding: 15px; box-sizing: border-box;
        }

        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .title { font-weight: bold; font-size: 1.1rem; }
        
        /* Selector Idioma */
        .lang-toggle { background: #eee; border-radius: 20px; display: flex; overflow: hidden; }
        .lang-btn { padding: 5px 12px; font-size: 0.8rem; border: none; background: transparent; cursor: pointer; }
        .lang-btn.active { background: #333; color: white; font-weight: bold; }

        /* Inputs de direcci√≥n */
        .input-row {
            display: flex; align-items: center; background: #f5f5f5;
            border-radius: 10px; padding: 10px; margin-bottom: 8px;
            border: 2px solid transparent; transition: 0.3s;
        }
        .input-row.active { border-color: #000; background: #fff; }
        
        .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; }
        .dot.blue { background: #2196F3; }
        .dot.red { background: #F44336; }
        
        input { border: none; background: transparent; width: 100%; outline: none; font-size: 1rem; }

        /* Pin Central (Crosshair) */
        #center-pin {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -100%);
            z-index: 5; pointer-events: none; transition: transform 0.2s;
        }
        #center-pin img { width: 45px; drop-shadow: 0 5px 5px rgba(0,0,0,0.3); }
        .lifting { transform: translate(-50%, -130%) scale(1.1) !important; }

        /* Botones inferiores Mapa */
        .bottom-ui {
            position: absolute; bottom: 20px; left: 0; width: 100%;
            padding: 0 20px; box-sizing: border-box; z-index: 10;
            display: flex; flex-direction: column; gap: 10px;
        }
        
        .btn-gps {
            align-self: flex-end; width: 50px; height: 50px; border-radius: 50%;
            background: white; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            font-size: 1.5rem; display: flex; align-items: center; justify-content: center;
        }

        .btn-action {
            width: 100%; padding: 15px; border-radius: 12px; border: none;
            background: #222; color: white; font-size: 1.1rem; font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .btn-action:disabled { background: #ccc; color: #888; }
        .btn-action.ready { background: #00E676; color: #000; }

        /* === AR VIEW (HUD) === */
        #ar-hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 200; }
        
        .ar-panel {
            position: absolute; top: 20px; left: 5%; width: 90%;
            background: rgba(0,0,0,0.8); color: white; border-radius: 15px;
            padding: 15px; border-left: 5px solid #00E676;
            backdrop-filter: blur(5px);
        }
        .dist-label { font-size: 3rem; font-weight: 800; line-height: 1; }
        .instr-label { font-size: 1.2rem; color: #ddd; margin-top: 5px; }

        .btn-exit {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #F44336; color: white; padding: 10px 30px; border-radius: 30px;
            border: none; font-weight: bold; pointer-events: auto;
        }

        /* Br√∫jula 2D */
        .compass-ring {
            position: absolute; top: 130px; left: 50%; transform: translateX(-50%);
            width: 60px; height: 60px; border: 2px solid white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.3);
        }
        .compass-arrow { font-size: 40px; color: #00E676; transform-origin: center; }

        /* Fix A-Frame Canvas */
        a-scene { width: 100%; height: 100%; }
    </style>
</head>
<body>

    <!-- === VISTA DE MAPA === -->
    <div id="map-view">
        <div class="top-ui">
            <div class="header-bar">
                <span class="title">Nav AR</span>
                <div class="lang-toggle">
                    <button class="lang-btn active" onclick="setLang('es')">ES</button>
                    <button class="lang-btn" onclick="setLang('en')">EN</button>
                </div>
            </div>

            <!-- Inputs Seleccionables -->
            <div class="input-row active" id="row-start" onclick="setMode('start')">
                <div class="dot blue"></div>
                <input id="in-start" placeholder="Punto de partida..." readonly>
            </div>
            <div class="input-row" id="row-dest" onclick="setMode('dest')">
                <div class="dot red"></div>
                <input id="in-dest" placeholder="Destino..." readonly>
            </div>
        </div>

        <div id="map"></div>

        <div id="center-pin">
            <img id="pin-img" src="https://cdn-icons-png.flaticon.com/512/684/684908.png" alt="Pin">
        </div>

        <div class="bottom-ui">
            <button class="btn-gps" onclick="geoLocate()">üìç</button>
            <button id="btn-start" class="btn-action" disabled>SELECCIONA PUNTOS</button>
        </div>
    </div>

    <!-- === VISTA DE C√ÅMARA (AR) === -->
    <div id="ar-view">
        <div id="ar-hud">
            <div class="ar-panel">
                <div class="dist-label" id="hud-dist">0m</div>
                <div class="instr-label" id="hud-instr">Iniciando...</div>
            </div>
            
            <div class="compass-ring">
                <div class="compass-arrow" id="hud-arrow">‚¨Ü</div>
            </div>

            <button class="btn-exit" onclick="stopAR()">SALIR / EXIT</button>
        </div>

        <a-scene 
            vr-mode-ui="enabled: false"
            embedded
            renderer="logarithmicDepthBuffer: true; alpha: true;"
            arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;">
            
            <!-- C√°mara GPS -->
            <a-camera gps-camera="minDistance: 3; gpsMinDistance: 3;" rotation-reader></a-camera>

            <!-- Contenedor de flechas AR -->
            <a-entity id="ar-world"></a-entity>
        </a-scene>
    </div>

    <script>
        // === CONFIGURACI√ìN ===
        const MAPBOX_TOKEN = 'pk.eyJ1IjoiYW5keWc5NyIsImEiOiJjbWpwN20zcGoyYjFzM2ZveTIzZ2s5Mm56In0.FsNncSP8DrD6zTXpw0MaEg';
        mapboxgl.accessToken = MAPBOX_TOKEN;

        // Estado de la App
        let app = {
            lang: 'es',
            mode: 'start', // 'start' o 'dest'
            startCoords: null,
            destCoords: null,
            route: [],
            stepIndex: 0,
            navigating: false
        };

        const texts = {
            es: { phStart: "Punto de inicio", phDest: "Destino", btnWait: "Selecciona ambos puntos", btnGo: "INICIAR RUTA", loading: "Calculando...", arr: "¬°Llegaste!", follow: "Sigue la flecha" },
            en: { phStart: "Start Point", phDest: "Destination", btnWait: "Select both points", btnGo: "START ROUTE", loading: "Calculating...", arr: "Arrived!", follow: "Follow arrow" }
        };

        // UI References
        const ui = {
            mapView: document.getElementById('map-view'),
            arView: document.getElementById('ar-view'),
            inStart: document.getElementById('in-start'),
            inDest: document.getElementById('in-dest'),
            rowStart: document.getElementById('row-start'),
            rowDest: document.getElementById('row-dest'),
            pinImg: document.getElementById('pin-img'),
            btnStart: document.getElementById('btn-start'),
            arWorld: document.getElementById('ar-world'),
            hudDist: document.getElementById('hud-dist'),
            hudInstr: document.getElementById('hud-instr'),
            hudArrow: document.getElementById('hud-arrow')
        };

        // --- 1. INICIALIZAR MAPA (Corregido) ---
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12', // Estilo est√°ndar, carga r√°pido y se ve bien
            center: [-109.72148, 23.10468],
            zoom: 13,
            attributionControl: false
        });

        // Marcadores
        const mStart = new mapboxgl.Marker({ color: '#2196F3' }).setLngLat([0,0]).addTo(map);
        const mDest = new mapboxgl.Marker({ color: '#F44336' }).setLngLat([0,0]).addTo(map);
        mStart.getElement().style.display = 'none';
        mDest.getElement().style.display = 'none';

        // --- 2. LOGICA "UBER-STYLE" PICKER ---
        map.on('movestart', () => document.getElementById('center-pin').classList.add('lifting'));
        
        map.on('moveend', async () => {
            document.getElementById('center-pin').classList.remove('lifting');
            const center = map.getCenter();
            const coords = [center.lng, center.lat];

            const address = await getAddress(coords);

            if (app.mode === 'start') {
                app.startCoords = coords;
                ui.inStart.value = address;
                mStart.setLngLat(coords).getElement().style.display = 'block';
            } else {
                app.destCoords = coords;
                ui.inDest.value = address;
                mDest.setLngLat(coords).getElement().style.display = 'block';
            }
            checkReady();
        });

        async function getAddress(coords) {
            try {
                const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${coords[0]},${coords[1]}.json?access_token=${MAPBOX_TOKEN}`;
                const res = await fetch(url);
                const data = await res.json();
                return data.features[0]?.text || "Ubicaci√≥n marcada";
            } catch { return "Coordenadas fijas"; }
        }

        // --- 3. CONTROLES UI ---
        window.setMode = (mode) => {
            app.mode = mode;
            if (mode === 'start') {
                ui.rowStart.classList.add('active');
                ui.rowDest.classList.remove('active');
                ui.pinImg.src = "https://cdn-icons-png.flaticon.com/512/684/684908.png";
                ui.pinImg.style.filter = "hue-rotate(200deg)"; // Azul
                if (app.startCoords) map.flyTo({ center: app.startCoords });
            } else {
                ui.rowStart.classList.remove('active');
                ui.rowDest.classList.add('active');
                ui.pinImg.src = "https://cdn-icons-png.flaticon.com/512/684/684908.png";
                ui.pinImg.style.filter = "none"; // Rojo
                if (app.destCoords) map.flyTo({ center: app.destCoords });
            }
        };

        window.setLang = (l) => {
            app.lang = l;
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            ui.inStart.placeholder = texts[l].phStart;
            ui.inDest.placeholder = texts[l].phDest;
            checkReady();
        };

        window.geoLocate = () => {
            if (!navigator.geolocation) return alert("No GPS");
            navigator.geolocation.getCurrentPosition(pos => {
                const coords = [pos.coords.longitude, pos.coords.latitude];
                map.flyTo({ center: coords, zoom: 16 });
                if (app.mode === 'start') {
                    app.startCoords = coords;
                    ui.inStart.value = "üìç GPS Actual";
                }
            });
        };

        function checkReady() {
            const t = texts[app.lang];
            if (app.startCoords && app.destCoords) {
                ui.btnStart.disabled = false;
                ui.btnStart.classList.add('ready');
                ui.btnStart.innerText = t.btnGo;
            } else {
                ui.btnStart.disabled = true;
                ui.btnStart.classList.remove('ready');
                ui.btnStart.innerText = t.btnWait;
            }
        }

        // --- 4. INICIAR RUTA (C√°lculo y transici√≥n AR) ---
        ui.btnStart.addEventListener('click', async () => {
            ui.btnStart.innerText = texts[app.lang].loading;
            
            const url = `https://api.mapbox.com/directions/v5/mapbox/walking/${app.startCoords[0]},${app.startCoords[1]};${app.destCoords[0]},${app.destCoords[1]}?steps=true&geometries=geojson&access_token=${MAPBOX_TOKEN}`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                
                if (!data.routes || data.routes.length === 0) {
                    alert("No se encontr√≥ ruta entre estos puntos.");
                    checkReady(); // Reset bot√≥n
                    return;
                }

                // Guardar ruta
                app.route = data.routes[0].geometry.coordinates;
                app.stepIndex = 0;
                
                // Cambiar vista
                ui.mapView.style.display = 'none';
                ui.arView.style.display = 'block';
                app.navigating = true;

                // Renderizar objetos AR
                renderARObjects(app.route);
                
                // Iniciar loop de navegaci√≥n
                startNavLoop();

            } catch (e) {
                console.error(e);
                alert("Error al conectar con el servidor de rutas.");
                checkReady();
            }
        });

        // --- 5. RENDER AR Y NAVEGACI√ìN ---
        function renderARObjects(path) {
            ui.arWorld.innerHTML = '';
            
            // Dibujar "Checkpoints" (Conos) cada 5 puntos
            path.forEach((c, i) => {
                if (i % 5 !== 0 && i !== path.length - 1) return;

                const entity = document.createElement('a-entity');
                entity.setAttribute('gps-new-entity-place', `latitude: ${c[1]}; longitude: ${c[0]}`);

                const cone = document.createElement('a-cone');
                cone.setAttribute('color', i === path.length - 1 ? 'red' : '#00E676');
                cone.setAttribute('radius-bottom', '0.5');
                cone.setAttribute('height', '2');
                cone.setAttribute('position', '0 2 0'); // Elevado 2m
                cone.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 3000');
                
                entity.appendChild(cone);
                ui.arWorld.appendChild(entity);
            });
        }

        function startNavLoop() {
            setInterval(() => {
                if (!app.navigating) return;

                navigator.geolocation.getCurrentPosition(pos => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    
                    // L√≥gica simple: apuntar al siguiente punto
                    let target = app.route[app.stepIndex];
                    if (!target) return;

                    const dist = getDist(lat, lon, target[1], target[0]);
                    
                    ui.hudDist.innerText = Math.round(dist) + "m";
                    ui.hudInstr.innerText = texts[app.lang].follow;

                    // Flecha 2D (Br√∫jula)
                    const bearing = getBearing(lat, lon, target[1], target[0]);
                    ui.hudArrow.style.transform = `rotate(${bearing}deg)`;

                    // Si estamos cerca (<15m), pasar al siguiente
                    if (dist < 15) {
                        app.stepIndex++;
                        if (app.stepIndex >= app.route.length) {
                            ui.hudInstr.innerText = texts[app.lang].arr;
                            ui.hudArrow.innerText = "üèÅ";
                            app.navigating = false;
                        }
                    }

                }, null, { enableHighAccuracy: true });
            }, 1000);
        }

        // --- √ötiles ---
        window.stopAR = () => location.reload();

        function getDist(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const dLat = (lat2-lat1) * Math.PI/180;
            const dLon = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function getBearing(lat1, lon1, lat2, lon2) {
            const toRad = d => d * Math.PI / 180;
            const toDeg = r => r * 180 / Math.PI;
            const y = Math.sin(toRad(lon2 - lon1)) * Math.cos(toRad(lat2));
            const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) - Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(toRad(lon2 - lon1));
            return (toDeg(Math.atan2(y, x)) + 360) % 360;
        }

        // Inicializar
        setMode('start');
    </script>
</body>
</html>
