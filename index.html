<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>BajaStay Rentals</title>
    <!-- FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <!-- LIBRARIES -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

    <style>
        :root {
            --primary: #000000;
            --accent: #00F3FF;
            --glass: rgba(20, 20, 20, 0.95);
            --text: #ffffff;
            --font: 'Outfit', sans-serif;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            background: var(--primary);
            font-family: var(--font);
            color: var(--text);
            overflow: hidden;
        }

        /* === UI: LANDING / ROUTE SELECTOR === */
        #landing-overlay {
            position: fixed;
            inset: 0;
            z-index: 2000;
            background: black;
            background-image: radial-gradient(circle at 50% 10%, #1a1a1a, black);
            display: flex;
            flex-direction: column;
            padding: 30px;
            transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1);
        }

        #landing-overlay.closed {
            transform: translateY(-100%);
        }

        .landing-header {
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        /* ROBUST LOGO CSS */
        .big-logo {
            width: 80px;
            height: 80px;
            background-color: white;
            border-radius: 20px;
            background-image: url('logo.png');
            background-size: 80%;
            background-position: center;
            background-repeat: no-repeat;
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.2);
            flex-shrink: 0;
        }

        .landing-title h1 {
            margin: 0;
            font-size: 32px;
            font-weight: 800;
            line-height: 1;
        }

        .landing-title p {
            margin: 5px 0 0;
            font-size: 14px;
            opacity: 0.6;
            letter-spacing: 2px;
            color: var(--accent);
        }

        .route-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 25px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: 0.3s;
        }

        .route-card:active {
            transform: scale(0.98);
            background: rgba(255, 255, 255, 0.1);
        }

        .route-card.selected {
            border-color: var(--accent);
            background: rgba(0, 243, 255, 0.05);
        }

        .card-icon {
            font-size: 32px;
            background: rgba(0, 0, 0, 0.3);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .card-info h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
        }

        .card-info p {
            margin: 5px 0 0;
            font-size: 13px;
            opacity: 0.5;
        }

        .card-arrow {
            position: absolute;
            right: 25px;
            font-size: 24px;
            opacity: 0.3;
        }

        /* === MAP VIEW === */
        #map-view {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        /* HEADER (Fixed & Robust) */
        .fixed-header {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            height: 60px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
            /* click thru */
        }

        .mini-logo-wrapper {
            width: 50px;
            height: 50px;
            background-color: white;
            border-radius: 14px;
            background-image: url('logo.png');
            /* CSS BACKGROUND IMAGE IS SAFER */
            background-size: 80%;
            background-position: center;
            background-repeat: no-repeat;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            pointer-events: auto;
            border: 2px solid white;
            /* Force visibility */
        }

        .controls {
            pointer-events: auto;
            display: flex;
            gap: 10px;
        }

        .ctrl-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* BOTTOM CARD */
        .bottom-card {
            position: absolute;
            bottom: 30px;
            left: 20px;
            right: 20px;
            background: var(--glass);
            border-radius: 24px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 500;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .btn-start {
            width: 100%;
            background: white;
            color: black;
            font-weight: 800;
            padding: 16px;
            border-radius: 16px;
            border: none;
            font-size: 16px;
            margin-top: 15px;
            cursor: pointer;
        }

        .btn-start:disabled {
            opacity: 0.5;
            background: #555;
            color: #888;
        }

        /* AR VIEW */
        #ar-view {
            position: absolute;
            inset: 0;
            z-index: 50;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.5s;
            background: black;
        }

        #ar-view.visible {
            visibility: visible;
            opacity: 1;
            background: transparent;
        }

        .ar-hud {
            position: absolute;
            padding: 20px;
            inset: 0;
            pointer-events: none;
            display: flex;
            flex-direction: column;
        }

        .ar-top {
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            pointer-events: auto;
        }

        .instr-box {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 15px;
            border-left: 4px solid var(--accent);
        }

        .big-instr {
            font-size: 20px;
            font-weight: 700;
            color: white;
            margin-bottom: 5px;
        }

        /* FAKE 3D ARROW */
        .arrow-wrap {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body>

    <!-- 1. LANDING / ROUTE SELECTION -->
    <div id="landing-overlay">
        <div class="landing-header">
            <div class="big-logo"></div> <!-- CSS Background Image -->
            <div class="landing-title">
                <h1>BAJASTAY</h1>
                <p>RENTALS</p>
            </div>
        </div>

        <div style="flex:1;">
            <p style="margin-bottom:20px; font-size:12px; font-weight:700; color:#888;">SELECCIONA TU RUTA</p>

            <!-- OPTION A: DEFAULT -->
            <div class="route-card selected" id="opt-default" onclick="selectMode('default')">
                <div class="card-icon">‚úàÔ∏è</div>
                <div class="card-info">
                    <h3>Ruta Rentals</h3>
                    <p>Aeropuerto ‚ûú Chametla ‚ûú BajaStay</p>
                </div>
                <div class="card-arrow">‚ûú</div>
            </div>

            <!-- OPTION B: MANUAL -->
            <div class="route-card" id="opt-manual" onclick="selectMode('manual')">
                <div class="card-icon">üëÜ</div>
                <div class="card-info">
                    <h3>Ruta Manual</h3>
                    <p>Toca el mapa para crear ruta</p>
                </div>
                <div class="card-arrow">‚ûú</div>
            </div>
        </div>

        <button class="btn-start" onclick="confirmSelection()">CONTINUAR</button>
    </div>

    <!-- 2. MAP VIEW -->
    <div id="map-view">
        <div class="fixed-header">
            <div class="mini-logo-wrapper" onclick="showLanding()"></div> <!-- Logo btn returns to menu -->
            <div class="controls">
                <button class="ctrl-btn" id="btn-lang" onclick="toggleLang()">ES</button>
                <button class="ctrl-btn" onclick="showLanding()">‚öôÔ∏è</button>
            </div>
        </div>

        <div id="map" style="flex:1;"></div>

        <div class="bottom-card" id="bottom-card">
            <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                <div>
                    <div style="font-size:11px; color:#888; font-weight:700;">DESTINO</div>
                    <div style="font-size:22px; font-weight:700; margin-top:2px;" id="txt-dest-name">...</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:24px; font-weight:800; color:var(--accent);" id="txt-time">--</div>
                    <div style="font-size:12px; color:#888;" id="txt-dist">--</div>
                </div>
            </div>
            <button class="btn-start" id="btn-go" onclick="startAR()" disabled>INICIAR RUTA</button>
            <p style="font-size:10px; opacity:0.5; text-align:center; margin-top:10px; display:none;" id="manual-tip">
                Toca el mapa para a√±adir puntos</p>
        </div>
    </div>

    <!-- 3. AR VIEW -->
    <div id="ar-view">
        <a-scene vr-mode-ui="enabled: false" embedded renderer="logarithmicDepthBuffer: true; alpha: true;"
            arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true; displayWidth: 1280; displayHeight: 720;">
            <a-camera gps-camera="minDistance: 1; gpsMinDistance: 1;" rotation-reader></a-camera>
        </a-scene>

        <div class="ar-hud">
            <div class="ar-top">
                <div class="instr-box">
                    <div class="big-instr" id="ar-instr">Iniciando...</div>
                    <div style="font-size:14px; opacity:0.8;" id="ar-next">-- m</div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="ctrl-btn" id="btn-voice" onclick="toggleVoice()">üîä</button>
                    <button class="ctrl-btn" style="background:#ff3b30;" onclick="stopAR()">‚úï</button>
                </div>
            </div>
            <div class="arrow-wrap">
                <!-- 3D SVG Arrow -->
                <svg width="140" height="140" viewBox="0 0 100 100" id="ar-arrow" style="overflow:visible;">
                    <filter id="glow">
                        <feDropShadow dx="0" dy="0" stdDeviation="5" flood-color="#00F3FF" />
                    </filter>
                    <path d="M50 10 L85 80 L50 65 L15 80 Z" fill="#00F3FF" stroke="white" stroke-width="2"
                        filter="url(#glow)" />
                    <path d="M50 65 L85 80 L50 90 L15 80 Z" fill="#008c94" opacity="0.6" />
                </svg>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        mapboxgl.accessToken = 'pk.eyJ1IjoiYW5keWc5NyIsImEiOiJjbWpwN20zcGoyYjFzM2ZveTIzZ2s5Mm56In0.FsNncSP8DrD6zTXpw0MaEg';

        // FIXED ROUTE
        const ROUTE_DEF = [
            [-110.3626, 24.0726], // Start: Airport
            [-110.393072, 24.097741], // WP: Chametla
            [-110.392168, 24.095156]  // Dest: Airbnb
        ];

        // STATE
        let app = {
            mode: 'default', // 'default' | 'manual'
            lang: 'es',
            voice: true,
            markers: [],
            points: [],
            route: null,
            step: 0,
            simStart: null
        };

        const TXT = {
            es: { btn: "CONTINUAR", go: "INICIAR RUTA", manualTip: "Toca el mapa: 1. Inicio, 2. WP, ...", dest: "BajaStay Airbnb", welcome: "Bienvenido.", inst: { s: "Sigue recto", l: "Gira izquierda", r: "Gira derecha", a: "Has llegado" } },
            en: { btn: "CONTINUE", go: "START ROUTE", manualTip: "Tap map: 1. Start, 2. WP, ...", dest: "BajaStay Airbnb", welcome: "Welcome.", inst: { s: "Go straight", l: "Turn left", r: "Turn right", a: "Arrived" } }
        };

        // --- UI ---
        function selectMode(m) {
            app.mode = m;
            document.getElementById('opt-default').classList.toggle('selected', m === 'default');
            document.getElementById('opt-manual').classList.toggle('selected', m === 'manual');
        }

        function confirmSelection() {
            document.getElementById('landing-overlay').classList.add('closed');
            initMapLogic();
        }

        function showLanding() {
            document.getElementById('landing-overlay').classList.remove('closed');
        }

        function toggleLang() {
            app.lang = app.lang === 'es' ? 'en' : 'es';
            document.getElementById('btn-lang').innerText = app.lang.toUpperCase();
            // TODO: Update other texts if needed dynamically
        }

        // --- MAP ---
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v11',
            center: ROUTE_DEF[0], zoom: 12, routing: false
        });

        function initMapLogic() {
            // Clean up
            app.markers.forEach(m => m.remove());
            app.markers = [];
            app.points = [];

            if (app.mode === 'default') {
                document.getElementById('manual-tip').style.display = 'none';
                document.getElementById('txt-dest-name').innerText = TXT[app.lang].dest;
                plotRoute(ROUTE_DEF);
            } else {
                document.getElementById('manual-tip').style.display = 'block';
                document.getElementById('manual-tip').innerText = TXT[app.lang].manualTip;
                document.getElementById('txt-dest-name').innerText = "Destino Manual";
                document.getElementById('btn-go').disabled = true;
                document.getElementById('txt-time').innerText = "--";
                document.getElementById('txt-dist').innerText = "--";

                // Clear existing line
                if (map.getSource('route')) map.getSource('route').setData({ type: 'Feature', geometry: { type: 'LineString', coordinates: [] } });
            }
        }

        map.on('click', e => {
            if (app.mode !== 'manual') return;
            const c = [e.lngLat.lng, e.lngLat.lat];
            app.points.push(c);

            // Marker
            const cel = document.createElement('div');
            cel.className = 'ctrl-btn';
            cel.innerText = app.points.length;
            cel.style.fontSize = "12px"; cel.style.background = app.points.length === 1 ? 'white' : 'cyan'; cel.style.color = 'black';
            cel.style.width = '24px'; cel.style.height = '24px';

            const m = new mapboxgl.Marker(cel).setLngLat(c).addTo(map);
            app.markers.push(m);

            if (app.points.length >= 2) plotRoute(app.points);
        });

        async function plotRoute(coords) {
            const str = coords.map(c => c.join(',')).join(';');
            try {
                const res = await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${str}?steps=true&geometries=geojson&access_token=${mapboxgl.accessToken}`);
                const data = await res.json();
                const route = data.routes[0];
                app.route = route;
                app.simStart = coords[0]; // For AR

                // Draw
                const geo = route.geometry;
                if (map.getSource('route')) map.getSource('route').setData(geo);
                else {
                    map.addLayer({
                        id: 'route', type: 'line', source: { type: 'geojson', data: geo },
                        layout: { 'line-join': 'round', 'line-cap': 'round' },
                        paint: { 'line-color': '#00F3FF', 'line-width': 6, 'line-opacity': 0.8 }
                    });
                }

                // Fit
                const b = new mapboxgl.LngLatBounds();
                coords.forEach(p => b.extend(p));
                map.fitBounds(b, { padding: 100 });

                // UI
                const min = Math.round(route.duration / 60);
                const km = (route.distance / 1000).toFixed(1);
                document.getElementById('txt-time').innerText = min + " min";
                document.getElementById('txt-dist').innerText = km + " km";
                document.getElementById('btn-go').disabled = false;

            } catch (e) { console.error(e); }
        }

        // --- AR ---
        window.startAR = () => {
            document.getElementById('map-view').style.opacity = 0; // fade out map
            setTimeout(() => document.getElementById('map-view').classList.add('hidden'), 500); // then hide
            document.getElementById('ar-view').classList.add('visible');
            speak(TXT[app.lang].welcome);
            startLoop();
        };

        window.stopAR = () => {
            document.getElementById('map-view').classList.remove('hidden');
            document.getElementById('map-view').style.opacity = 1;
            document.getElementById('ar-view').classList.remove('visible');
            window.speechSynthesis.cancel();
        };

        function startLoop() {
            let lastH = 0; let lastSpk = 0; let lastK = "";
            window.addEventListener('deviceorientation', e => {
                let h = e.webkitCompassHeading || (360 - e.alpha);
                if (h) {
                    let d = h - lastH;
                    if (d > 180) d -= 360; if (d < -180) d += 360;
                    lastH = (lastH + d * 0.1 + 360) % 360;
                }
            });

            navigator.geolocation.watchPosition(pos => {
                if (!app.route) return;
                const lat = pos.coords.latitude; const lng = pos.coords.longitude;
                // Simple logic: target next step
                const steps = app.route.geometry.coordinates;
                let t = steps[app.step];
                const d = dist(lat, lng, t[1], t[0]);
                if (d < 25 && app.step < steps.length - 1) app.step++;

                // Arrow
                const b = bearing(lat, lng, t[1], t[0]);
                const rel = b - lastH;
                document.getElementById('ar-arrow').style.transform = `rotate(${rel}deg)`;

                // Instr
                document.getElementById('ar-next').innerText = Math.round(d) + " m";
                let k = "s";
                if (rel < -25) k = "l"; if (rel > 25) k = "r";
                if (d < 20 && app.step > steps.length - 3) k = "a";

                const txt = TXT[app.lang].inst[k];
                document.getElementById('ar-instr').innerText = txt;

                // Voice
                const now = Date.now();
                if (app.voice && (now - lastSpk > 8000 || k !== lastK)) {
                    speak(txt);
                    lastSpk = now; lastK = k;
                }
            }, null, { enableHighAccuracy: true });
        }

        function speak(pay) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(pay);
            u.lang = app.lang === 'es' ? 'es-MX' : 'en-US';
            window.speechSynthesis.speak(u);
        }

        function toggleVoice() { app.voice = !app.voice; document.getElementById('btn-voice').innerText = app.voice ? "üîä" : "üîá"; }
        function dist(la1, lo1, la2, lo2) { const R = 6371000; const dLa = (la2 - la1) * Math.PI / 180; const dLo = (lo2 - lo1) * Math.PI / 180; const a = Math.sin(dLa / 2) * Math.sin(dLa / 2) + Math.cos(la1 * Math.PI / 180) * Math.cos(la2 * Math.PI / 180) * Math.sin(dLo / 2) * Math.sin(dLo / 2); return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); }
        function bearing(la1, lo1, la2, lo2) { const y = Math.sin((lo2 - lo1) * Math.PI / 180) * Math.cos(la2 * Math.PI / 180); const x = Math.cos(la1 * Math.PI / 180) * Math.sin(la2 * Math.PI / 180) - Math.sin(la1 * Math.PI / 180) * Math.cos(la2 * Math.PI / 180) * Math.cos((lo2 - lo1) * Math.PI / 180); return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360; }
    </script>
</body>

</html>
