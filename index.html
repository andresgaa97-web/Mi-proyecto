<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>AR Maps Style</title>
    
    <!-- LIBRER√çAS AR -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js'></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
    <!-- Componente para que los letreros te miren a ti -->
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    
    <!-- MAPBOX -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

    <style>
        /* === ESTILOS BASE === */
        * { box-sizing: border-box; font-family: 'Google Sans', Roboto, Arial, sans-serif; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: transparent; }

        /* Colores Google Maps */
        :root {
            --gm-blue: #1a73e8; /* Azul Google */
            --gm-white: #ffffff;
            --gm-grey: #3c4043;
        }

        /* === VISTA MAPA === */
        #map-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 200; display: flex; flex-direction: column; }
        #map { flex-grow: 1; width: 100%; }

        /* Panel Superior Mapa */
        .map-ui-top {
            position: absolute; top: 0; left: 0; width: 100%; padding: 15px; z-index: 10;
            background: linear-gradient(to bottom, rgba(255,255,255,1), rgba(255,255,255,0));
        }
        
        .search-box {
            background: white; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            display: flex; align-items: center; padding: 10px 15px; margin-bottom: 10px;
            border: 1px solid #ddd;
        }
        .search-box.active { border: 2px solid var(--gm-blue); }
        .icon-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; }
        .blue-dot { background: var(--gm-blue); }
        .red-dot { background: #d93025; }
        input { border: none; width: 100%; outline: none; font-size: 16px; color: #202124; }

        /* Botones Mapa */
        .map-ui-bottom {
            position: absolute; bottom: 0; left: 0; width: 100%; padding: 20px; z-index: 10;
            background: white; border-top-left-radius: 20px; border-top-right-radius: 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .btn-confirm {
            width: 100%; padding: 15px; background: var(--gm-blue); color: white;
            border: none; border-radius: 25px; font-size: 18px; font-weight: 500;
            opacity: 0.5; transition: 0.3s;
        }
        .btn-confirm.ready { opacity: 1; cursor: pointer; }

        .settings-bar { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .toggle-pill {
            padding: 8px 16px; border-radius: 20px; border: 1px solid #ddd; background: white;
            font-size: 14px; font-weight: 500; color: #5f6368; cursor: pointer;
        }
        .toggle-pill.active { background: #e8f0fe; color: var(--gm-blue); border-color: var(--gm-blue); }

        /* === VISTA AR (HUD ESTILO GOOGLE) === */
        #ar-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; display: none; }

        /* TARJETA AZUL FLOTANTE (Igual a la foto) */
        .google-card {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            width: 85%; max-width: 400px;
            background: var(--gm-blue);
            color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 2px solid white; /* Borde blanco como en la foto */
            display: flex; flex-direction: column; align-items: center; text-align: center;
        }

        /* Tri√°ngulo debajo de la tarjeta para que parezca un bocadillo */
        .google-card::after {
            content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%);
            border-width: 10px 10px 0; border-style: solid; border-color: var(--gm-blue) transparent transparent transparent;
        }

        .nav-instruction { font-size: 1.4rem; font-weight: 700; line-height: 1.2; margin-bottom: 5px; }
        .nav-distance { font-size: 1rem; opacity: 0.9; font-weight: 400; }
        
        /* Icono de flecha gigante dentro de la tarjeta */
        .card-icon { font-size: 2rem; margin-bottom: 5px; }

        /* Bot√≥n Salir */
        .btn-close {
            position: absolute; top: 20px; left: 20px;
            width: 40px; height: 40px; background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); pointer-events: auto;
            font-size: 20px; border: none; color: #333;
        }

        /* Fix A-Frame */
        a-scene { width: 100%; height: 100%; background: transparent !important; }
    </style>
</head>

<body>

    <!-- VISTA MAPA -->
    <div id="map-view">
        <div class="map-ui-top">
            <div class="search-box active" onclick="setMode('start')">
                <div class="icon-dot blue-dot"></div>
                <input id="in-start" placeholder="Tu ubicaci√≥n..." readonly>
            </div>
            <div class="search-box" onclick="setMode('dest')">
                <div class="icon-dot red-dot"></div>
                <input id="in-dest" placeholder="Elige destino en el mapa" readonly>
            </div>
        </div>

        <div id="map"></div>
        <!-- Pin Central -->
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -100%); z-index: 5; pointer-events: none;">
            <img src="https://cdn-icons-png.flaticon.com/512/684/684908.png" width="40" id="pin-icon">
        </div>

        <div class="map-ui-bottom">
            <div class="settings-bar">
                <button class="toggle-pill active" id="btn-voice" onclick="toggleVoice()">üîä Audio ON</button>
                <div style="display: flex; gap: 5px;">
                    <button class="toggle-pill active" onclick="setLang('es', this)">ES</button>
                    <button class="toggle-pill" onclick="setLang('en', this)">EN</button>
                </div>
            </div>
            <button class="btn-confirm" id="btn-go" disabled>Iniciar Live View</button>
        </div>
    </div>

    <!-- VISTA AR -->
    <div id="ar-ui">
        <button class="btn-close" onclick="location.reload()">‚Üê</button>
        
        <!-- TARJETA ESTILO FOTO -->
        <div class="google-card">
            <div class="card-icon" id="ar-icon">‚¨Ü</div>
            <div class="nav-instruction" id="ar-text">Iniciando...</div>
            <div class="nav-distance" id="ar-dist">Calculando ruta</div>
        </div>
    </div>

    <!-- ESCENA AR -->
    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        renderer="logarithmicDepthBuffer: true; alpha: true;"
        arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;">
        
        <a-camera gps-camera="minDistance: 3; gpsMinDistance: 3;" rotation-reader></a-camera>

        <!-- CONTENEDOR DE LA RUTA -->
        <a-entity id="ar-world"></a-entity>
    </a-scene>

    <script>
        // === CONFIGURACI√ìN ===
        const MAPBOX_TOKEN = 'pk.eyJ1IjoiYW5keWc5NyIsImEiOiJjbWpwN20zcGoyYjFzM2ZveTIzZ2s5Mm56In0.FsNncSP8DrD6zTXpw0MaEg';
        mapboxgl.accessToken = MAPBOX_TOKEN;

        // TEXTOS
        const i18n = {
            es: { 
                start: "Tu ubicaci√≥n", dest: "Destino", btn: "Iniciar Live View", 
                wait: "Elige puntos", arr: "¬°Llegaste!", 
                voiceOn: "üîä Audio ON", voiceOff: "üîá Audio OFF",
                straight: "Sigue recto", turnL: "Gira izquierda", turnR: "Gira derecha"
            },
            en: { 
                start: "Your Location", dest: "Destination", btn: "Start Live View", 
                wait: "Select points", arr: "Arrived!", 
                voiceOn: "üîä Sound ON", voiceOff: "üîá Sound OFF",
                straight: "Go straight", turnL: "Turn left", turnR: "Turn right"
            }
        };

        let state = {
            lang: 'es', voice: true, mode: 'start',
            start: null, dest: null, route: [], steps: [], stepIdx: 0, navigating: false
        };

        // UI REF
        const ui = {
            inStart: document.getElementById('in-start'),
            inDest: document.getElementById('in-dest'),
            btnGo: document.getElementById('btn-go'),
            arText: document.getElementById('ar-text'),
            arDist: document.getElementById('ar-dist'),
            arIcon: document.getElementById('ar-icon'),
            arWorld: document.getElementById('ar-world'),
            mapView: document.getElementById('map-view'),
            arUI: document.getElementById('ar-ui')
        };

        // 1. MAPA
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [-109.72148, 23.10468], zoom: 15, attributionControl: false
        });

        // GPS Inicial
        navigator.geolocation.getCurrentPosition(pos => {
            const c = [pos.coords.longitude, pos.coords.latitude];
            map.setCenter(c);
            state.start = c;
            ui.inStart.value = "üìç " + i18n[state.lang].start;
            checkReady();
        });

        // Selecci√≥n Puntos
        map.on('moveend', async () => {
            const c = map.getCenter();
            const coords = [c.lng, c.lat];
            const text = await getAddr(coords);
            
            if(state.mode === 'start') {
                state.start = coords;
                ui.inStart.value = text;
            } else {
                state.dest = coords;
                ui.inDest.value = text;
            }
            checkReady();
        });

        async function getAddr(c) {
            const u = `https://api.mapbox.com/geocoding/v5/mapbox.places/${c[0]},${c[1]}.json?access_token=${MAPBOX_TOKEN}`;
            const r = await fetch(u); const d = await r.json();
            return d.features[0]?.text || "Punto marcado";
        }

        // 2. CONTROLES
        window.setMode = (m) => { state.mode = m; };
        window.setLang = (l, el) => {
            state.lang = l;
            document.querySelectorAll('.settings-bar button').forEach(b => { 
                if(b.textContent.length === 2) b.classList.remove('active'); 
            });
            el.classList.add('active');
            updateUI();
        };
        window.toggleVoice = () => {
            state.voice = !state.voice;
            updateUI();
        };
        
        function updateUI() {
            const t = i18n[state.lang];
            document.getElementById('btn-voice').innerText = state.voice ? t.voiceOn : t.voiceOff;
            checkReady();
        }

        function checkReady() {
            const t = i18n[state.lang];
            if(state.start && state.dest) {
                ui.btnGo.disabled = false;
                ui.btnGo.classList.add('ready');
                ui.btnGo.innerText = t.btn;
            } else {
                ui.btnGo.disabled = true;
                ui.btnGo.classList.remove('ready');
                ui.btnGo.innerText = t.wait;
            }
        }

        // 3. INICIAR AR
        ui.btnGo.addEventListener('click', async () => {
            const u = `https://api.mapbox.com/directions/v5/mapbox/walking/${state.start[0]},${state.start[1]};${state.dest[0]},${state.dest[1]}?steps=true&geometries=geojson&access_token=${MAPBOX_TOKEN}`;
            const r = await fetch(u); const d = await r.json();
            
            if(!d.routes.length) return alert("Error ruta");
            
            state.route = d.routes[0].geometry.coordinates;
            state.steps = d.routes[0].legs[0].steps;
            state.stepIdx = 0;
            state.navigating = true;

            ui.mapView.style.display = 'none';
            ui.arUI.style.display = 'block';

            renderPath(state.route);
            renderTurnSignals(state.steps); // Nuevas Flechas de Giro Flotantes
            navLoop();
        });

        // 4. RENDERIZAR CAMINO (PUNTOS AZULES)
        function renderPath(path) {
            ui.arWorld.innerHTML = '';
            path.forEach((c, i) => {
                if(i % 2 !== 0) return; // Densidad de puntos

                const el = document.createElement('a-entity');
                el.setAttribute('gps-new-entity-place', `latitude: ${c[1]}; longitude: ${c[0]}`);

                // C√≠rculo Azul Plano (Igual a la foto)
                const dot = document.createElement('a-circle');
                dot.setAttribute('radius', '0.4'); // Tama√±o
                dot.setAttribute('color', '#1a73e8'); // Azul Google
                dot.setAttribute('rotation', '-90 0 0'); // Acostado en suelo
                dot.setAttribute('position', '0 0 0');
                dot.setAttribute('opacity', '0.8');

                el.appendChild(dot);
                ui.arWorld.appendChild(el);
            });
        }

        // 5. RENDERIZAR SE√ëALES DE GIRO (FLECHAS FLOTANTES)
        function renderTurnSignals(steps) {
            steps.forEach(step => {
                const type = step.maneuver.modifier; // left, right, etc.
                if(!type) return;

                const loc = step.maneuver.location;
                
                const el = document.createElement('a-entity');
                el.setAttribute('gps-new-entity-place', `latitude: ${loc[1]}; longitude: ${loc[0]}`);
                // Hace que la flecha siempre mire al usuario
                el.setAttribute('look-at', '[gps-camera]'); 

                // Flecha Gigante Flotante
                const arrow = document.createElement('a-entity');
                arrow.setAttribute('position', '0 2 0'); // Flotando a 2m
                
                // Dibujamos un "Panel" con flecha usando texto o primitivas
                // Usaremos un plano azul con texto blanco simple para simular el letrero
                const sign = document.createElement('a-plane');
                sign.setAttribute('width', '2');
                sign.setAttribute('height', '1');
                sign.setAttribute('color', '#1a73e8');
                sign.setAttribute('opacity', '0.9');
                
                // Texto de flecha
                let symbol = "‚¨Ü";
                if(type.includes('left')) symbol = "‚¨Ö";
                if(type.includes('right')) symbol = "‚û°";

                const txt = document.createElement('a-text');
                txt.setAttribute('value', symbol);
                txt.setAttribute('align', 'center');
                txt.setAttribute('width', '10');
                txt.setAttribute('position', '0 0 0.1'); // Un poco enfrente del plano

                sign.appendChild(txt);
                arrow.appendChild(sign);
                el.appendChild(arrow);
                
                ui.arWorld.appendChild(el);
            });
        }

        // 6. LOOP NAVEGACI√ìN
        function navLoop() {
            setInterval(() => {
                if(!state.navigating) return;
                
                navigator.geolocation.getCurrentPosition(pos => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    
                    // Buscar el paso actual
                    if(state.stepIdx < state.steps.length) {
                        const step = state.steps[state.stepIdx];
                        const target = step.maneuver.location;
                        const dist = getDist(lat, lon, target[1], target[0]);
                        
                        // Actualizar Tarjeta Azul
                        ui.arText.innerText = step.maneuver.instruction;
                        ui.arDist.innerText = Math.round(dist) + " m";
                        
                        // Icono tarjeta
                        const mod = step.maneuver.modifier || '';
                        if(mod.includes('left')) ui.arIcon.innerText = "‚¨Ö";
                        else if(mod.includes('right')) ui.arIcon.innerText = "‚û°";
                        else ui.arIcon.innerText = "‚¨Ü";

                        // Cambio de paso
                        if(dist < 15) {
                            state.stepIdx++;
                            speak(step.maneuver.instruction);
                        }
                    } else {
                        ui.arText.innerText = i18n[state.lang].arr;
                        ui.arDist.innerText = "0 m";
                    }

                }, null, { enableHighAccuracy: true });
            }, 1000);
        }

        // Utils
        function speak(txt) {
            if(!state.voice) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(txt);
            u.lang = state.lang === 'es' ? 'es-MX' : 'en-US';
            window.speechSynthesis.speak(u);
        }

        function getDist(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const dLat = (lat2-lat1) * Math.PI/180;
            const dLon = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

    </script>
</body>
</html>
