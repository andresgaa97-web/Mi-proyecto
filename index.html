<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>AR Nav - Live Path</title>
    
    <!-- A-FRAME & AR.JS -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js'></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
    
    <!-- MAPBOX -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

    <style>
        /* === RESETEO CR칈TICO PARA VER LA C츼MARA === */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: transparent !important; overflow: hidden; }
        
        /* El video de la webcam debe estar al fondo del todo */
        #arjs-video { z-index: -1 !important; }

        /* === VISTA MAPA (Capa Superior) === */
        #map-view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 999; /* Tapa la c치mara al principio */
            display: flex; flex-direction: column;
        }

        /* Mapa */
        #map { flex-grow: 1; width: 100%; }
        
        /* Pin Central */
        #center-pin {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -100%);
            z-index: 1000; pointer-events: none;
        }
        #center-pin img { width: 40px; drop-shadow: 0 4px 5px rgba(0,0,0,0.4); }

        /* Panel Inputs */
        .top-bar {
            background: white; padding: 15px; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 1001;
        }
        .input-wrap {
            display: flex; align-items: center; background: #f0f2f5; padding: 10px; border-radius: 10px; margin-bottom: 10px; border: 2px solid transparent;
        }
        .input-wrap.active { border-color: #222; background: #fff; }
        .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; }
        .dot.blue { background: #007bff; }
        .dot.red { background: #ff0000; }
        input { border: none; background: transparent; width: 100%; outline: none; font-size: 16px; }

        /* Bot칩n Inferior */
        .bottom-bar {
            padding: 20px; background: white; z-index: 1001;
        }
        .btn-action {
            width: 100%; padding: 15px; background: #222; color: white; border: none; border-radius: 15px;
            font-size: 18px; font-weight: bold; opacity: 0.5;
        }
        .btn-action.ready { opacity: 1; background: #00e676; color: black; cursor: pointer; }

        /* === VISTA AR (HUD) === */
        #ar-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 100; display: none;
        }

        /* Tarjeta de Informaci칩n Superior */
        .info-card {
            position: absolute; top: 20px; left: 5%; width: 90%;
            background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px);
            padding: 15px; border-radius: 15px; color: white;
            border-left: 5px solid #00e676;
            display: flex; flex-direction: column; align-items: center;
        }
        .dist-big { font-size: 2rem; font-weight: 800; font-family: monospace; }
        .instr-small { font-size: 1rem; color: #ddd; }

        /* Bot칩n Salir */
        .btn-exit {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #ff4444; color: white; border: none; padding: 10px 25px;
            border-radius: 50px; font-weight: bold; pointer-events: auto;
        }

        /* Correcci칩n Canvas A-Frame */
        a-scene { display: block; width: 100%; height: 100%; }
    </style>
</head>

<body>

    <!-- === 1. INTERFAZ DE MAPA (Se oculta al iniciar ruta) === -->
    <div id="map-view">
        <div class="top-bar">
            <div class="input-wrap active" id="wrap-start" onclick="setMode('start')">
                <div class="dot blue"></div>
                <input id="in-start" placeholder="Punto de inicio (Toca el mapa)" readonly>
            </div>
            <div class="input-wrap" id="wrap-dest" onclick="setMode('dest')">
                <div class="dot red"></div>
                <input id="in-dest" placeholder="Destino (Toca el mapa)" readonly>
            </div>
        </div>

        <div id="map"></div>
        
        <div id="center-pin">
            <img id="pin-img" src="https://cdn-icons-png.flaticon.com/512/684/684908.png">
        </div>

        <div class="bottom-bar">
            <button id="btn-start" class="btn-action" disabled>SELECCIONAR PUNTOS</button>
        </div>
    </div>

    <!-- === 2. INTERFAZ AR HUD (Sobre la c치mara) === -->
    <div id="ar-ui">
        <div class="info-card">
            <div class="dist-big" id="ar-dist">0m</div>
            <div class="instr-small" id="ar-instr">Calculando ruta...</div>
        </div>
        <button class="btn-exit" onclick="location.reload()">SALIR</button>
    </div>

    <!-- === 3. ESCENA AR (C치mara y Objetos 3D) === -->
    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        renderer="logarithmicDepthBuffer: true; alpha: true;"
        arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true; displayWidth: 1280; displayHeight: 720;">
        
        <!-- C츼MARA + FLECHA GU칈A -->
        <!-- La flecha es hija de la c치mara para moverse contigo, 
             pero la rotaremos v칤a JS para que apunte al destino -->
        <a-camera gps-camera="minDistance: 1; gpsMinDistance: 1;" rotation-reader>
            
            <!-- FLECHA 3D FLOTANTE (HUD) -->
            <!-- Esta flecha flota 2 metros delante de ti -->
            <a-entity id="arrow-rig" position="0 -0.5 -2">
                
                <!-- Modelo de la flecha -->
                <a-cone 
                    color="#00e676" 
                    radius-bottom="0.2" radius-top="0.02" height="0.8" 
                    rotation="-90 0 0" 
                    position="0 0 0"
                    opacity="0.9">
                </a-cone>
                
                <!-- Anillo decorativo -->
                <a-ring 
                    color="white" radius-inner="0.25" radius-outer="0.28" 
                    rotation="-90 0 0" position="0 0 0.2" opacity="0.5">
                </a-ring>

            </a-entity>

        </a-camera>

        <!-- Aqu칤 se dibujar치n las bolas en el camino -->
        <a-entity id="scene-objects"></a-entity>

    </a-scene>

    <script>
        // === CONFIGURACI칍N ===
        const MAPBOX_TOKEN = 'pk.eyJ1IjoiYW5keWc5NyIsImEiOiJjbWpwN20zcGoyYjFzM2ZveTIzZ2s5Mm56In0.FsNncSP8DrD6zTXpw0MaEg';
        mapboxgl.accessToken = MAPBOX_TOKEN;

        // ESTADO
        let state = {
            mode: 'start', // 'start' | 'dest'
            start: null,
            dest: null,
            route: [],
            step: 0,
            navigating: false
        };

        // DOM UI
        const ui = {
            mapView: document.getElementById('map-view'),
            arUI: document.getElementById('ar-ui'),
            inStart: document.getElementById('in-start'),
            inDest: document.getElementById('in-dest'),
            wrapStart: document.getElementById('wrap-start'),
            wrapDest: document.getElementById('wrap-dest'),
            pinImg: document.getElementById('pin-img'),
            btnStart: document.getElementById('btn-start'),
            arDist: document.getElementById('ar-dist'),
            arInstr: document.getElementById('ar-instr'),
            arrowRig: document.getElementById('arrow-rig'),
            sceneObjects: document.getElementById('scene-objects')
        };

        // --- 1. MAPA ---
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [-109.72148, 23.10468],
            zoom: 13
        });

        // Geolocalizar usuario al inicio
        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const c = [pos.coords.longitude, pos.coords.latitude];
                map.setCenter(c);
                map.setZoom(15);
                // Auto-set inicio
                state.start = c;
                ui.inStart.value = "游늸 Mi ubicaci칩n actual";
            });
        }

        // Selecci칩n de puntos con el Pin Central
        map.on('moveend', async () => {
            const c = map.getCenter();
            const coords = [c.lng, c.lat];
            
            if(state.mode === 'start') {
                state.start = coords;
                ui.inStart.value = `Inicio: ${coords[1].toFixed(4)}, ${coords[0].toFixed(4)}`;
            } else {
                state.dest = coords;
                ui.inDest.value = `Destino: ${coords[1].toFixed(4)}, ${coords[0].toFixed(4)}`;
            }
            checkReady();
        });

        window.setMode = (m) => {
            state.mode = m;
            if(m === 'start') {
                ui.wrapStart.classList.add('active');
                ui.wrapDest.classList.remove('active');
                ui.pinImg.style.filter = "hue-rotate(200deg)"; // Azul
            } else {
                ui.wrapStart.classList.remove('active');
                ui.wrapDest.classList.add('active');
                ui.pinImg.style.filter = "none"; // Rojo
            }
        };

        function checkReady() {
            if(state.start && state.dest) {
                ui.btnStart.disabled = false;
                ui.btnStart.classList.add('ready');
                ui.btnStart.innerText = "INICIAR RUTA AR";
            }
        }

        // --- 2. INICIAR AR ---
        ui.btnStart.addEventListener('click', async () => {
            ui.btnStart.innerText = "Cargando...";
            
            // Obtener ruta de Mapbox
            const url = `https://api.mapbox.com/directions/v5/mapbox/walking/${state.start[0]},${state.start[1]};${state.dest[0]},${state.dest[1]}?steps=true&geometries=geojson&access_token=${MAPBOX_TOKEN}`;
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                
                if(!data.routes.length) return alert("Ruta no encontrada");

                state.route = data.routes[0].geometry.coordinates;
                state.step = 0;
                
                // OCULTAR MAPA, MOSTRAR AR
                ui.mapView.style.display = 'none';
                ui.arUI.style.display = 'block';
                state.navigating = true;

                // Dibujar bolas en el camino (Checkpoints)
                drawCheckpoints(state.route);
                
                // Iniciar br칰jula
                startCompassLoop();

            } catch(e) {
                alert("Error de red");
                ui.btnStart.innerText = "Error";
            }
        });

        function drawCheckpoints(path) {
            // Dibujar una esfera amarilla cada 10 metros
            path.forEach((c, i) => {
                if(i % 5 !== 0) return; // Saltar algunos puntos
                
                const ent = document.createElement('a-entity');
                ent.setAttribute('gps-new-entity-place', `latitude: ${c[1]}; longitude: ${c[0]}`);
                
                const sphere = document.createElement('a-sphere');
                sphere.setAttribute('color', 'yellow');
                sphere.setAttribute('radius', '0.5');
                sphere.setAttribute('position', '0 1 0'); // Flotando a 1m
                sphere.setAttribute('opacity', '0.8');

                ent.appendChild(sphere);
                ui.sceneObjects.appendChild(ent);
            });
        }

        // --- 3. L칍GICA DE FLECHA 3D (Br칰jula) ---
        function startCompassLoop() {
            // Esta funci칩n rota la flecha 3D para que siempre apunte al siguiente punto
            
            setInterval(() => {
                if(!state.navigating) return;

                navigator.geolocation.getCurrentPosition(pos => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    
                    // Objetivo actual
                    if(state.step >= state.route.length) {
                        ui.arInstr.innerText = "춰Llegaste!";
                        ui.arDist.innerText = "0m";
                        return;
                    }

                    const target = state.route[state.step]; // [lon, lat]
                    
                    // 1. Calcular distancia
                    const dist = getDist(lat, lon, target[1], target[0]);
                    ui.arDist.innerText = Math.round(dist) + "m";

                    // Si estamos cerca (<15m), siguiente punto
                    if(dist < 15) state.step++;

                    // 2. Calcular 치ngulo hacia el destino (Bearing)
                    const bearing = getBearing(lat, lon, target[1], target[0]);

                    // 3. Rotar la flecha
                    // OJO: La flecha es hija de la c치mara.
                    // Si el usuario gira el tel칠fono, la c치mara gira en el mundo 3D.
                    // Necesitamos que la flecha apunte al 'bearing' geogr치fico.
                    // En A-Frame AR, el "Norte" es -Z.
                    
                    // Obtenemos la orientaci칩n del dispositivo (Heading) si es posible
                    // Pero una forma m치s simple visualmente es:
                    // Usar 'look-at' din치mico o calcular rotaci칩n relativa.
                    
                    // Simplificaci칩n Efectiva: 
                    // Rotar la flecha en Y bas치ndonos en el Bearing.
                    // Nota: Esto requiere que los sensores de A-Frame est칠n calibrados.
                    
                    // Truco Visual: Hacemos que la flecha "mire" al checkpoint 3D
                    // Pero como la flecha es hija de la camara, usamos rotaci칩n matem치tica.
                    
                    // Soluci칩n Robustas para WebAR:
                    // Dejamos la flecha fija al frente, pero giramos su geometria
                    // La rotaci칩n debe ser: (Bearing - RumboDispositivo).
                    // AR.js maneja el rumbo dispositivo con la c치mara.
                    // As칤 que solo aplicamos rotaci칩n relativa.
                    
                    // Calculo aproximado para demo funcional:
                    // Convertimos el bearing a rotaci칩n Y de la flecha
                    // A-Frame: Y rotation is counter-clockwise in degrees? No, standard right-hand.
                    // Un bearing de 90 (Este) = rotaci칩n -90.
                    
                    // NOTA: Para que esto sea 100% preciso se necesita deviceorientation.
                    // Aqu칤 usamos una rotaci칩n est치tica del bearing, confiando en que
                    // 'rotation-reader' alinea la escena con el norte.
                    
                    // Si rotation-reader funciona bien, la escena est치 alineada al Norte.
                    // Entonces:
                    const angleRad = (bearing) * (Math.PI / 180);
                    // Ajuste emp칤rico: -bearing
                    ui.arrowRig.object3D.rotation.y = -angleRad; 
                    
                }, null, { enableHighAccuracy: true });

            }, 200);
        }

        // --- MATEM츼TICAS ---
        function getDist(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const dLat = (lat2-lat1) * Math.PI/180;
            const dLon = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function getBearing(lat1, lon1, lat2, lon2) {
            const toRad = d => d * Math.PI / 180;
            const toDeg = r => r * 180 / Math.PI;
            const y = Math.sin(toRad(lon2 - lon1)) * Math.cos(toRad(lat2));
            const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) - Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(toRad(lon2 - lon1));
            return (toDeg(Math.atan2(y, x)) + 360) % 360;
        }

        // Inicializar
        setMode('start');
    </script>
</body>
</html>
