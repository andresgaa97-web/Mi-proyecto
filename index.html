<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>BajaStay Rentals</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">

    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

    <style>
        :root {
            --primary: #000000;
            --accent: #00F3FF;
            --glass: rgba(20, 20, 20, 0.85);
            --glass-border: rgba(255, 255, 255, 0.15);
            --text: #ffffff;
            --font: 'Outfit', sans-serif;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            background: var(--primary);
            font-family: var(--font);
            color: var(--text);
            overflow: hidden;
        }

        /* === LOADERS === */
        #loader {
            position: fixed;
            inset: 0;
            z-index: 3000;
            background: black;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #333;
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* === LANDING === */
        #landing-overlay {
            position: fixed;
            inset: 0;
            z-index: 2000;
            background: linear-gradient(180deg, #1a1a1a 0%, #000000 100%);
            display: flex;
            flex-direction: column;
            padding: 30px;
            transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1);
        }

        #landing-overlay.closed {
            transform: translateY(-100%);
        }

        .landing-header {
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .big-logo {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 20px;
            background-image: url('logo.jpeg');
            background-size: contain !important;
            background-position: center;
            background-repeat: no-repeat;
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.15);
            flex-shrink: 0;
        }

        .landing-title h1 {
            margin: 0;
            font-size: 32px;
            font-weight: 800;
            line-height: 1;
        }

        .landing-title p {
            margin: 5px 0 0;
            font-size: 14px;
            opacity: 0.6;
            letter-spacing: 2px;
            color: var(--accent);
        }

        .route-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 25px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            cursor: pointer;
            transition: 0.3s;
            position: relative;
        }

        .route-card.selected {
            border-color: var(--accent);
            background: rgba(0, 243, 255, 0.05);
        }

        .card-icon {
            font-size: 28px;
            background: rgba(0, 0, 0, 0.3);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        /* === MAP UI === */
        #map-view {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            z-index: 100;
            opacity: 1;
            transition: opacity 0.5s;
        }

        #map-view.hidden {
            pointer-events: none;
        }

        .fixed-header {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            height: 60px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
        }

        .mini-logo-wrapper {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 14px;
            background-image: url('logo.jpeg');
            background-size: contain !important;
            background-position: center;
            background-repeat: no-repeat;
            border: 2px solid white;
            pointer-events: auto;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        /* MINI MAP CONTAINER */
        #mini-map-container {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 220px;
            height: 220px;
            border-radius: 32px;
            border: 4px solid rgba(255, 255, 255, 0.4);
            background: rgba(0, 0, 0, 0.7);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.7);
            overflow: hidden;
            z-index: 200;
            pointer-events: none;
        }

        #mini-map {
            width: 100%;
            height: 100%;
        }

        .controls {
            pointer-events: auto;
            display: flex;
            gap: 10px;
        }

        .ctrl-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            pointer-events: auto;
            /* Garantizar click */
        }

        .bottom-card {
            position: absolute;
            bottom: 30px;
            left: 20px;
            right: 20px;
            background: var(--glass);
            border-radius: 24px;
            padding: 24px;
            border: 1px solid var(--glass-border);
            z-index: 500;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
        }

        .btn-start {
            width: 100%;
            background: white;
            color: black;
            font-weight: 800;
            padding: 16px;
            border-radius: 16px;
            border: none;
            font-size: 16px;
            margin-top: 15px;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-start:disabled {
            opacity: 0.5;
            background: #555;
        }

        .btn-start:active {
            transform: scale(0.98);
        }

        /* === PULSING DOT MARKER (PRO) === */
        .user-marker {
            width: 20px;
            height: 20px;
            background-color: var(--accent);
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.7);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 243, 255, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(0, 243, 255, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(0, 243, 255, 0);
            }
        }

        /* === AR VIEW === */
        #ar-view {
            position: absolute;
            inset: 0;
            z-index: 50;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.5s;
            background: black;
        }

        #ar-view.visible {
            visibility: visible;
            opacity: 1;
            background: transparent;
        }

        .ar-hud {
            position: absolute;
            padding: 20px;
            inset: 0;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }

        .ar-top {
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            pointer-events: auto;
            z-index: 1001;
        }

        .instr-box {
            background: rgba(0, 0, 0, 0.85);
            padding: 15px 20px;
            border-radius: 16px;
            border-left: 4px solid var(--accent);
            backdrop-filter: blur(5px);
        }

        .big-instr {
            font-size: 20px;
            font-weight: 700;
            color: white;
            margin-bottom: 4px;
        }

        .arrow-wrap {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body>

    <div id="loader">
        <div class="spinner"></div>
        <div style="font-size:12px; letter-spacing:2px; color:#888;">CARGANDO RECURSOS...</div>
    </div>

    <div id="landing-overlay">
        <div class="landing-header">
            <div class="big-logo"></div>
            <div class="landing-title">
                <h1>BAJASTAY</h1>
                <p>RENTALS</p>
            </div>
        </div>

        <div style="flex:1;">
            <p style="margin-bottom:20px; font-size:12px; font-weight:700; color:#888;">SELECCIONA TU RUTA</p>

            <div class="route-card selected" id="opt-default" onclick="selectMode('default')">
                <div class="card-icon">‚úàÔ∏è</div>
                <div>
                    <h3 style="margin:0; font-size:18px;">Ruta Rentals</h3>
                    <p style="margin:5px 0 0; font-size:13px; opacity:0.5;">Aeropuerto ‚ûú Chametla ‚ûú BajaStay</p>
                </div>
            </div>

            <div class="route-card" id="opt-manual" onclick="selectMode('manual')">
                <div class="card-icon">üëÜ</div>
                <div>
                    <h3 style="margin:0; font-size:18px;">Ruta Manual</h3>
                    <p style="margin:5px 0 0; font-size:13px; opacity:0.5;">Toca el mapa para crear ruta</p>
                </div>
            </div>
        </div>

        <button class="btn-start" onclick="confirmSelection()">CONTINUAR</button>
    </div>

    <div id="map-view">
        <div class="fixed-header">
            <div class="mini-logo-wrapper" onclick="showLanding()"></div>
            <div class="controls">
                <button class="ctrl-btn" id="btn-lang" onclick="toggleLang()">ES</button>
                <button class="ctrl-btn" onclick="showLanding()">‚öôÔ∏è</button>
            </div>
        </div>

        <div id="map" style="flex:1;"></div>

        <div class="bottom-card">
            <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                <div>
                    <div style="font-size:11px; color:#888; font-weight:700;">DESTINO</div>
                    <div style="font-size:22px; font-weight:700; margin-top:2px;" id="txt-dest-name">...</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:24px; font-weight:800; color:var(--accent);" id="txt-time">--</div>
                    <div style="font-size:12px; color:#888;" id="txt-dist">--</div>
                </div>
            </div>
            <button class="btn-start" id="btn-go" onclick="attemptStartAR()" disabled>INICIAR RUTA</button>
            <p style="font-size:10px; opacity:0.5; text-align:center; margin-top:10px; display:none;" id="manual-tip">
                Toca el mapa para a√±adir puntos</p>
        </div>
    </div>

    <div id="ar-view">
        <a-scene vr-mode-ui="enabled: false" embedded renderer="logarithmicDepthBuffer: true; alpha: true;"
            arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true; displayWidth: 1280; displayHeight: 720;">
            <a-camera gps-camera="minDistance: 1; gpsMinDistance: 1;" rotation-reader></a-camera>
        </a-scene>

        <div class="ar-hud">
            <div class="ar-top">
                <div class="instr-box">
                    <div class="big-instr" id="ar-instr">Iniciando...</div>
                    <div style="font-size:14px; opacity:0.8;" id="ar-next">-- m</div>
                </div>
                <div style="display:flex; gap:15px; padding-right:10px;">
                    <button class="ctrl-btn" id="btn-lang-ar" onmousedown="event.stopPropagation(); toggleLang()"
                        ontouchstart="event.stopPropagation(); event.preventDefault(); toggleLang()">ES</button>
                    <button class="ctrl-btn" id="btn-voice" onmousedown="event.stopPropagation(); toggleVoice()"
                        ontouchstart="event.stopPropagation(); event.preventDefault(); toggleVoice()">üîä</button>
                    <button class="ctrl-btn" style="background:#ff3b30; border-color: #ff3b30;"
                        onmousedown="event.stopPropagation(); stopAR()"
                        ontouchstart="event.stopPropagation(); event.preventDefault(); stopAR()">‚úï</button>
                </div>
            </div>

            <div class="arrow-wrap">
                <svg width="160" height="160" viewBox="0 0 100 100" id="ar-arrow"
                    style="overflow:visible; transition: none;">
                    <defs>
                        <filter id="glow">
                            <feGaussianBlur stdDeviation="4" result="coloredBlur" />
                            <feMerge>
                                <feMergeNode in="coloredBlur" />
                                <feMergeNode in="SourceGraphic" />
                            </feMerge>
                        </filter>
                    </defs>
                    <path d="M50 15 L85 85 L50 70 L15 85 Z" fill="#00F3FF" stroke="white" stroke-width="3"
                        filter="url(#glow)" />
                </svg>
            </div>

            <!-- MINI MAP -->
            <div id="mini-map-container">
                <div id="mini-map"></div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        // ¬°IMPORTANTE! Protege este token en producci√≥n restringiendo la URL en Mapbox Dashboard
        mapboxgl.accessToken = 'pk.eyJ1IjoiYW5keWc5NyIsImEiOiJjbWpwN20zcGoyYjFzM2ZveTIzZ2s5Mm56In0.FsNncSP8DrD6zTXpw0MaEg';

        // USER PROVIDED GEOJSON (STATIC ROUTE)
        const DEFAULT_ROUTE_GEOJSON = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "geometry": { "type": "Point", "coordinates": [-110.3675884755777, 24.07620957367486, 19.59901810551265] },
                    "properties": { "name": "Origen - Aeropuerto la Paz" },
                    "id": "0D11914C703CB4D832C0"
                },
                {
                    "type": "Feature",
                    "geometry": { "type": "Point", "coordinates": [-110.391038445351, 24.09540285146841, 4.487690660529326] },
                    "properties": { "name": "Destino - Airbnb BajaStays Rentals" },
                    "id": "0498022F833CB4D8E454"
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "LineString",
                        "coordinates": [
                            [-110.3676061849273, 24.07622858497015, 0], [-110.3675472830153, 24.07661897630843, 0], [-110.3677690683074, 24.0768711004984, 0],
                            [-110.3688447687849, 24.07702726387739, 0], [-110.3691804052901, 24.07719566737829, 0], [-110.3693387833746, 24.07768299232134, 0],
                            [-110.3693291883587, 24.07792177827368, 0], [-110.3665929537034, 24.10371032330687, 0], [-110.3664918936345, 24.10510869981672, 0],
                            [-110.3664107193627, 24.10556814346124, 0], [-110.3661028090201, 24.10626749746943, 0], [-110.3655477373088, 24.10681103355262, 0],
                            [-110.3651509852586, 24.10704606986485, 0], [-110.3649707532042, 24.10708111685407, 0], [-110.3647205936599, 24.10694809684832, 0],
                            [-110.3646534678784, 24.10671941561371, 0], [-110.3647690908585, 24.10652723707523, 0], [-110.3651616586128, 24.10634409139388, 0],
                            [-110.3667445092549, 24.10563801417024, 0], [-110.3803260784353, 24.0999716297604, 0], [-110.3821653573059, 24.09923618643921, 0],
                            [-110.3930933118167, 24.09772319671085, 0]
                        ]
                    },
                    "properties": { "name": "Ruta 1 Airbnb BajaStays Rentals" },
                    "id": "0424687EEE3CB4DB28B0"
                },
                {
                    "type": "Feature",
                    "geometry": { "type": "Point", "coordinates": [-110.3930924146773, 24.09772014879889, 4.183889859599872] },
                    "properties": { "name": "Desviacion / Cruce" },
                    "id": "0522BE7E153CB4DDD151"
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "LineString",
                        "coordinates": [
                            [-110.3930436743562, 24.09754761703125, 0], [-110.3928194657311, 24.0962260369505, 0], [-110.3926876313522, 24.09618915901778, 0],
                            [-110.3923589171539, 24.09620761028096, 0], [-110.3922991407109, 24.09615135129986, 0], [-110.392173137542, 24.09518587995925, 0],
                            [-110.3910261027907, 24.09532131661534, 0], [-110.3910372199984, 24.09539877384319, 0]
                        ]
                    },
                    "properties": { "name": "Ruta 2 Airbnb" },
                    "id": "0CA3FFA34F3CB4EA002F"
                }
            ]
        };

        const ROUTE_DEF = [
            [-110.367588, 24.076210], // Aeropuerto
            [-110.391038, 24.095403]  // BajaStay
        ];

        // --- STATE ---
        let app = {
            mode: 'default',
            lang: 'es',
            voice: true,
            markers: [],
            points: [],
            route: null,
            step: 0,
            navigating: false,
            watchId: null,
            wakeLock: null,
            currentVisualHeading: 0,
            targetHeading: 0,
            compassOffset: 0,
            miniMap: null
        };

        const TXT = {
            es: { btn: "CONTINUAR", go: "INICIAR RUTA", manualTip: "Toca para a√±adir Waypoint/Destino", dest: "BajaStay Airbnb", welcome: "Bienvenido. Siga la flecha.", inst: { s: "Sigue recto", l: "Gira izquierda", r: "Gira derecha", a: "Has llegado" } },
            en: { btn: "CONTINUE", go: "START ROUTE", manualTip: "Tap to add Waypoint/Dest", dest: "BajaStay Airbnb", welcome: "Welcome. Follow the arrow.", inst: { s: "Go straight", l: "Turn left", r: "Turn right", a: "Arrived" } }
        };

        // --- MAP SETUP ---
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v11',
            center: ROUTE_DEF[0],
            zoom: 12,
            pitch: 45,
            bearing: 0
        });

        // 3D Buildings & Loader
        map.on('load', () => {
            document.getElementById('loader').style.opacity = '0';
            setTimeout(() => document.getElementById('loader').remove(), 500);

            const layers = map.getStyle().layers;
            const labelLayerId = layers.find(l => l.type === 'symbol' && l.layout['text-field']).id;

            map.addLayer({
                'id': 'add-3d-buildings',
                'source': 'composite',
                'source-layer': 'building',
                'filter': ['==', 'extrude', 'true'],
                'type': 'fill-extrusion',
                'minzoom': 14,
                'paint': {
                    'fill-extrusion-color': '#222',
                    'fill-extrusion-height': ['get', 'height'],
                    'fill-extrusion-base': ['get', 'min_height'],
                    'fill-extrusion-opacity': 0.6
                }
            }, labelLayerId);
        });

        // --- UI LOGIC ---
        function selectMode(m) {
            app.mode = m;
            document.getElementById('opt-default').classList.toggle('selected', m === 'default');
            document.getElementById('opt-manual').classList.toggle('selected', m === 'manual');
        }

        function confirmSelection() {
            document.getElementById('landing-overlay').classList.add('closed');
            initMapLogic();
        }

        function showLanding() {
            document.getElementById('landing-overlay').classList.remove('closed');
        }

        function toggleLang() {
            app.lang = app.lang === 'es' ? 'en' : 'es';
            const val = app.lang.toUpperCase();

            // Actualizar botones en ambos modos
            const b1 = document.getElementById('btn-lang');
            const b2 = document.getElementById('btn-lang-ar');
            if (b1) b1.innerText = val;
            if (b2) b2.innerText = val;

            if (app.mode === 'default') {
                const destName = document.getElementById('txt-dest-name');
                if (destName) destName.innerText = TXT[app.lang].dest;
            }
        }

        // --- MAP LOGIC ---
        function initMapLogic() {
            // Limpieza
            app.markers.forEach(m => m.remove());
            app.markers = [];
            app.points = [];

            if (app.mode === 'default') {
                document.getElementById('manual-tip').style.display = 'none';
                document.getElementById('txt-dest-name').innerText = TXT[app.lang].dest;
                plotStaticRoute();
            } else {
                // Modo Manual
                document.getElementById('manual-tip').style.display = 'block';
                document.getElementById('manual-tip').innerText = "Localizando...";
                document.getElementById('btn-go').disabled = true;

                navigator.geolocation.getCurrentPosition(pos => {
                    const c = [pos.coords.longitude, pos.coords.latitude];
                    app.points.push(c);
                    addUserMarker(c);
                    map.flyTo({ center: c, zoom: 15 });
                    document.getElementById('manual-tip').innerText = TXT[app.lang].manualTip;
                }, err => alert("GPS Error: Activa ubicaci√≥n"), { enableHighAccuracy: true });
            }
        }

        function addUserMarker(coords) {
            const el = document.createElement('div');
            el.className = 'user-marker';
            const m = new mapboxgl.Marker(el).setLngLat(coords).addTo(map);
            app.markers.push(m);
        }

        map.on('click', e => {
            if (app.mode !== 'manual') return;
            const c = [e.lngLat.lng, e.lngLat.lat];
            app.points.push(c);

            const el = document.createElement('div');
            el.className = 'ctrl-btn'; el.innerText = app.points.length;
            el.style.width = '24px'; el.style.height = '24px'; el.style.fontSize = '12px';
            el.style.background = 'white'; el.style.color = 'black';

            app.markers.push(new mapboxgl.Marker(el).setLngLat(c).addTo(map));

            if (app.points.length >= 2) plotRoute(app.points);
        });

        // PARSE USER GEOJSON (STATIC)
        function plotStaticRoute() {
            // 1. Extraer LineStrings
            let coordinates = [];
            DEFAULT_ROUTE_GEOJSON.features.forEach(f => {
                if (f.geometry.type === 'LineString') {
                    // mapbox espera solo array de coords, las unimos
                    coordinates.push(...f.geometry.coordinates);
                }
            });

            // 2. Extraer Puntos (Start/End Markers)
            DEFAULT_ROUTE_GEOJSON.features.forEach(f => {
                if (f.geometry.type === 'Point') {
                    addUserMarker(f.geometry.coordinates);
                }
            });

            // 3. Crear Objeto Route Compatible con App
            const totalDist = calcTotalDist(coordinates); // metros
            const totalTime = (totalDist / 11.11); // ~40km/h = 11.11 m/s

            app.route = {
                distance: totalDist,
                duration: totalTime,
                geometry: {
                    type: 'LineString',
                    coordinates: coordinates
                }
            };

            // 4. Render
            renderRouteOnMap(app.route.geometry);
            updateRouteInfo(totalDist, totalTime);
        }

        // HELPER: Distancia total array coords
        function calcTotalDist(coords) {
            let d = 0;
            for (let i = 0; i < coords.length - 1; i++) {
                d += dist(coords[i][1], coords[i][0], coords[i + 1][1], coords[i + 1][0]);
            }
            return d; // dist ya devuelve metros
        }

        // MAPBOX API (Manual Mode)
        async function plotRoute(coords) {
            const str = coords.map(c => c.join(',')).join(';');
            try {
                const res = await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${str}?steps=true&geometries=geojson&access_token=${mapboxgl.accessToken}`);
                const data = await res.json();
                const route = data.routes[0];
                app.route = route;
                renderRouteOnMap(route.geometry);
                updateRouteInfo(route.distance, route.duration);
            } catch (e) { console.error(e); }
        }

        function renderRouteOnMap(geo) {
            if (map.getSource('route')) {
                map.getSource('route').setData(geo);
            } else {
                map.addLayer({
                    id: 'route', type: 'line', source: { type: 'geojson', data: geo },
                    layout: { 'line-join': 'round', 'line-cap': 'round' },
                    paint: { 'line-color': '#00F3FF', 'line-width': 6, 'line-opacity': 0.9 }
                });
            }
            // Fit bounds
            const b = new mapboxgl.LngLatBounds();
            geo.coordinates.forEach(p => b.extend(p));
            map.fitBounds(b, { padding: 80 });
        }

        function updateRouteInfo(distanceMeters, durationSeconds) {
            const min = Math.round(durationSeconds / 60);
            const km = (distanceMeters / 1000).toFixed(1);
            document.getElementById('txt-time').innerText = min + " min";
            document.getElementById('txt-dist').innerText = km + " km";
            document.getElementById('btn-go').disabled = false;
        }

        // --- AR & CORE NAVIGATION ---

        // 1. Permisos y WakeLock (Cr√≠tico para iOS)
        window.attemptStartAR = async () => {
            // iOS 13+ Compass Permission
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission === 'granted') {
                        startAR();
                    } else {
                        alert("Se requiere permiso de orientaci√≥n para la br√∫jula.");
                    }
                } catch (e) { alert(e); }
            } else {
                // Android / Non-iOS
                startAR();
            }
        };

        async function startAR() {
            // Limpieza preventiva
            if (app.watchId) navigator.geolocation.clearWatch(app.watchId);
            window.speechSynthesis.cancel();

            app.navigating = true;

            // Wake Lock (Pantalla encendida)
            try {
                if ('wakeLock' in navigator) {
                    app.wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) { console.log("WakeLock error:", err); }

            // Transici√≥n UI
            document.getElementById('map-view').style.opacity = 0;
            setTimeout(() => document.getElementById('map-view').classList.add('hidden'), 500);
            document.getElementById('ar-view').classList.add('visible');

            speak(TXT[app.lang].welcome);

            // Iniciar Loops
            window.addEventListener('deviceorientation', handleOrientation);
            app.watchId = navigator.geolocation.watchPosition(handleGPS, null, { enableHighAccuracy: true, maximumAge: 1000 });

            // INICIAR MINI MAPA
            initMiniMap();

            // Animaci√≥n Loop (Lerp)
            requestAnimationFrame(renderLoop);
        }

        function initMiniMap() {
            if (app.miniMap) app.miniMap.remove();

            app.miniMap = new mapboxgl.Map({
                container: 'mini-map',
                style: 'mapbox://styles/mapbox/dark-v11',
                center: app.route.geometry.coordinates[app.step] || ROUTE_DEF[0],
                zoom: 14, // Zoom out slightly to see more context
                pitch: 0,
                interactive: false,
                attributionControl: false
            });

            app.miniMap.on('load', () => {
                if (app.route) {
                    // 1. ROUTE LINE
                    app.miniMap.addLayer({
                        id: 'mini-route', type: 'line',
                        source: { type: 'geojson', data: app.route.geometry },
                        layout: { 'line-join': 'round', 'line-cap': 'round' },
                        paint: { 'line-color': '#00F3FF', 'line-width': 6 } // Thicker
                    });

                    // 2. MARKERS EN MINI MAPA (Si es default)
                    if (app.mode === 'default') {
                        DEFAULT_ROUTE_GEOJSON.features.forEach(f => {
                            if (f.geometry.type === 'Point') {
                                const elPoint = document.createElement('div');
                                elPoint.style.width = '8px'; elPoint.style.height = '8px';
                                elPoint.style.backgroundColor = f.properties.name.includes('Destino') ? '#ff3b30' : '#ffffff';
                                elPoint.style.borderRadius = '50%';
                                elPoint.style.border = '1px solid black';
                                new mapboxgl.Marker(elPoint).setLngLat(f.geometry.coordinates).addTo(app.miniMap);
                            }
                        });
                    }

                    // 3. USER MARKER (Fixed Center)
                    const el = document.createElement('div');
                    el.style.width = '16px'; el.style.height = '16px';
                    el.style.backgroundColor = '#00F3FF';
                    el.style.borderRadius = '50%';
                    el.style.border = '3px solid white';
                    el.style.boxShadow = '0 0 15px #00F3FF';
                    new mapboxgl.Marker(el).setLngLat(app.miniMap.getCenter()).addTo(app.miniMap);
                }
            });
        }

        window.stopAR = () => {
            app.navigating = false;

            // 1. Detener Audio Totalmente
            window.speechSynthesis.cancel();

            // 2. Detener GPS y Orientaci√≥n
            if (app.watchId !== null) {
                navigator.geolocation.clearWatch(app.watchId);
                app.watchId = null;
            }
            window.removeEventListener('deviceorientation', handleOrientation);

            // 3. Liberar WakeLock
            if (app.wakeLock) {
                app.wakeLock.release().catch(() => { });
                app.wakeLock = null;
            }

            // 4. Reset de Datos
            app.route = null;
            app.step = 0;
            app.points = [];

            // 5. Limpieza Visual
            app.markers.forEach(m => m.remove());
            app.markers = [];

            if (app.miniMap) {
                app.miniMap.remove();
                app.miniMap = null;
            }

            if (map.getSource('route')) {
                map.getSource('route').setData({ type: 'FeatureCollection', features: [] });
            }

            // 6. Retorno UI
            document.getElementById('ar-view').classList.remove('visible');
            document.getElementById('map-view').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('map-view').style.opacity = 1;
                showLanding();
            }, 100);
        };

        // 2. L√≥gica de Orientaci√≥n y Suavizado
        function handleOrientation(e) {
            // Compatibilidad iOS vs Android
            let heading = e.webkitCompassHeading || (360 - e.alpha);
            if (!heading) heading = 0;

            // Aqu√≠ solo guardamos el offset para usarlo en el loop de render
            app.compassOffset = heading;
        }

        function handleGPS(pos) {
            if (!app.navigating || !app.route) return;

            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const steps = app.route.geometry.coordinates;

            // Verificar si llegamos al paso actual
            let target = steps[app.step];
            const distToTarget = dist(lat, lng, target[1], target[0]);

            // Avanzar paso si estamos cerca (< 30m)
            if (distToTarget < 30 && app.step < steps.length - 1) {
                app.step++;
                target = steps[app.step]; // Actualizar objetivo
            }

            // ACTUALIZAR MINI MAPA
            if (app.miniMap) {
                app.miniMap.setCenter([lng, lat]);
            }

            // --- C√ÅLCULO DE PROGRESO EN TIEMPO REAL ---
            // 1. Distancia desde ubicaci√≥n actual al punto actual
            let remainingDist = dist(lat, lng, steps[app.step][1], steps[app.step][0]);
            // 2. Sumar el resto de los segmentos hasta el final
            for (let i = app.step; i < steps.length - 1; i++) {
                remainingDist += dist(steps[i][1], steps[i][0], steps[i + 1][1], steps[i + 1][0]);
            }
            // 3. Calcular tiempo (Usando 40km/h promedio = 11.11 m/s)
            const remainingTimeSec = remainingDist / 11.11;
            const min = Math.ceil(remainingTimeSec / 60);
            const km = (remainingDist / 1000).toFixed(1);

            // Actualizar UI Texto
            document.getElementById('ar-next').innerText = `${km} km ¬∑ ${min} min`;

            // Calcular hacia d√≥nde debe apuntar la flecha (Bearing Real)
            const targetBearing = bearing(lat, lng, target[1], target[0]);
            app.targetHeading = targetBearing;

            // Instrucciones
            let relativeAngle = targetBearing - app.compassOffset;
            // Normalizar a -180 / 180
            if (relativeAngle > 180) relativeAngle -= 360;
            if (relativeAngle < -180) relativeAngle += 360;

            let k = "s"; // straight
            if (relativeAngle < -45) k = "l"; // left
            if (relativeAngle > 45) k = "r"; // right
            if (distToTarget < 20 && app.step > steps.length - 3) k = "a"; // arrived

            const txt = TXT[app.lang].inst[k];
            if (document.getElementById('ar-instr').innerText !== txt) {
                document.getElementById('ar-instr').innerText = txt;
                if (app.voice) speak(txt);
            }
        }

        // 3. Render Loop (Suavizado / Lerp)
        function renderLoop() {
            if (!app.navigating) return;

            // Calculamos el √°ngulo relativo deseado
            let desiredRel = app.targetHeading - app.compassOffset;

            // Normalizar giro m√°s corto (evita giros locos 360)
            let diff = desiredRel - app.currentVisualHeading;
            while (diff < -180) diff += 360;
            while (diff > 180) diff -= 360;

            // Lerp (Interpolaci√≥n Linear): Factor 0.1 para suavidad
            app.currentVisualHeading += diff * 0.1;

            // Aplicar rotaci√≥n
            const arrow = document.getElementById('ar-arrow');
            if (arrow) arrow.style.transform = `rotate(${app.currentVisualHeading}deg)`;

            // ROTAR MINI MAPA (Head Up)
            if (app.miniMap) {
                // Queremos que el mapa gire opuesto a la br√∫jula para que "arriba" sea el frente
                app.miniMap.setBearing(app.compassOffset);
            }

            requestAnimationFrame(renderLoop);
        }

        // --- UTILS ---
        function speak(text) {
            window.speechSynthesis.cancel();
            if (!app.voice || !app.navigating) return; // Mute check o navegaci√≥n terminada
            const u = new SpeechSynthesisUtterance(text);
            u.lang = app.lang === 'es' ? 'es-MX' : 'en-US';
            window.speechSynthesis.speak(u);
        }

        function toggleVoice() {
            app.voice = !app.voice;
            if (!app.voice) window.speechSynthesis.cancel();

            const btn = document.getElementById('btn-voice');
            if (btn) {
                btn.innerText = app.voice ? "üîä" : "üîá";
                btn.style.opacity = app.voice ? "1" : "0.5";
            }
        }

        // Mate Geogr√°fica
        function dist(la1, lo1, la2, lo2) {
            const R = 6371000;
            const dLa = toRad(la2 - la1);
            const dLo = toRad(lo2 - lo1);
            const a = Math.sin(dLa / 2) * Math.sin(dLa / 2) + Math.cos(toRad(la1)) * Math.cos(toRad(la2)) * Math.sin(dLo / 2) * Math.sin(dLo / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }
        function bearing(la1, lo1, la2, lo2) {
            const y = Math.sin(toRad(lo2 - lo1)) * Math.cos(toRad(la2));
            const x = Math.cos(toRad(la1)) * Math.sin(toRad(la2)) - Math.sin(toRad(la1)) * Math.cos(toRad(la2)) * Math.cos(toRad(lo2 - lo1));
            return (toDeg(Math.atan2(y, x)) + 360) % 360;
        }
        function toRad(d) { return d * Math.PI / 180; }
        function toDeg(r) { return r * 180 / Math.PI; }

    </script>
</body>

</html>
