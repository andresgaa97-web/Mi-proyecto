<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>AR Nav Premium</title>
    
    <!-- LIBRERAS AR (A-Frame + AR.js) -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js'></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
    
    <!-- MAPBOX -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

    <style>
        /* === RESETEO Y ESTILOS BASE === */
        * { box-sizing: border-box; font-family: 'Segoe UI', Roboto, Helvetica, sans-serif; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: transparent; overflow: hidden; }
        
        /* Colores del Tema */
        :root {
            --primary: #007bff;
            --accent: #00ffcc; /* Verde Ne贸n */
            --path-color: #00BFFF; /* Azul Ruta */
            --dark-glass: rgba(15, 15, 15, 0.85);
            --light-glass: rgba(255, 255, 255, 0.95);
        }

        /* === VISTA DE MAPA (Pantalla completa) === */
        #map-view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 200; display: flex; flex-direction: column;
        }

        #map { flex-grow: 1; width: 100%; position: relative; }

        /* Controles Superiores del Mapa */
        .top-controls {
            position: absolute; top: 0; left: 0; width: 100%;
            background: var(--light-glass);
            border-bottom-left-radius: 25px; border-bottom-right-radius: 25px;
            padding: 15px 20px; z-index: 10;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .header-row {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
        }
        .app-title { font-weight: 800; font-size: 1.2rem; color: #333; }

        /* Toggle Idioma y Voz */
        .settings-row { display: flex; gap: 10px; }
        .toggle-btn {
            background: #eee; border: none; padding: 8px 12px; border-radius: 20px;
            font-size: 0.8rem; font-weight: bold; color: #555; cursor: pointer; transition: 0.3s;
        }
        .toggle-btn.active { background: #222; color: white; }
        .voice-btn { width: 35px; height: 35px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 1.1rem;}

        /* Inputs Mapa */
        .input-card {
            background: #f4f6f8; border-radius: 15px; padding: 12px; margin-bottom: 10px;
            display: flex; align-items: center; border: 2px solid transparent; transition: 0.3s;
        }
        .input-card.active { background: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(0,123,255,0.1); }
        .dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 12px; flex-shrink: 0; }
        .dot.blue { background: var(--primary); }
        .dot.red { background: #ff3b30; }
        input { border: none; background: transparent; width: 100%; font-size: 1rem; outline: none; }

        /* Pin Central */
        #center-pin {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -100%);
            z-index: 5; pointer-events: none; transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #center-pin img { width: 48px; filter: drop-shadow(0 8px 10px rgba(0,0,0,0.3)); }
        .pin-hover { transform: translate(-50%, -130%) scale(1.15) !important; }

        /* Bot贸n Inferior Mapa */
        .bottom-bar {
            position: absolute; bottom: 0; left: 0; width: 100%; padding: 25px;
            background: linear-gradient(to top, rgba(255,255,255,1), rgba(255,255,255,0)); pointer-events: none;
            display: flex; flex-direction: column; gap: 15px; z-index: 10;
        }
        .btn-gps {
            width: 50px; height: 50px; border-radius: 50%; background: white; border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); align-self: flex-end; pointer-events: auto;
            font-size: 1.5rem; display: flex; align-items: center; justify-content: center;
        }
        .btn-start {
            width: 100%; padding: 18px; border-radius: 18px; border: none;
            background: #111; color: white; font-size: 1.1rem; font-weight: 800;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); pointer-events: auto; opacity: 0.5; transition: 0.3s;
        }
        .btn-start.ready { background: var(--accent); color: black; opacity: 1; transform: scale(1.02); }

        /* === VISTA AR (HUD) === */
        #ar-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 100; display: none;
        }

        /* Tarjeta de Informaci贸n AR (Responsive) */
        .ar-info-card {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 450px; /* Evita que sea gigante en tablets */
            background: var(--dark-glass);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            padding: 20px; border-radius: 20px; color: white;
            border-left: 6px solid var(--accent);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; align-items: flex-start;
        }
        
        .ar-distance { font-size: 2.5rem; font-weight: 800; line-height: 1; margin-bottom: 5px; color: var(--accent); }
        .ar-instruction { font-size: 1.1rem; color: #ddd; line-height: 1.4; font-weight: 500; }
        .ar-subtext { font-size: 0.8rem; color: #888; margin-top: 5px; text-transform: uppercase; letter-spacing: 1px; }

        /* Bot贸n Salir AR */
        .btn-exit {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            background: #ff3b30; color: white; border: none; padding: 12px 35px;
            border-radius: 50px; font-weight: bold; font-size: 1rem;
            box-shadow: 0 5px 15px rgba(255, 59, 48, 0.4); pointer-events: auto;
        }

        /* Fix Video Background */
        a-scene { width: 100%; height: 100%; background: transparent !important; }
        video { z-index: -1 !important; }
    </style>
</head>

<body>

    <!-- === 1. VISTA DE MAPA === -->
    <div id="map-view">
        <div class="top-controls">
            <div class="header-row">
                <span class="app-title">AR Explorer</span>
                
                <div class="settings-row">
                    <!-- Voz -->
                    <button class="toggle-btn voice-btn active" id="btn-voice" onclick="toggleVoice()"></button>
                    <!-- Idioma -->
                    <button class="toggle-btn active" id="lang-es" onclick="setLang('es')">ES</button>
                    <button class="toggle-btn" id="lang-en" onclick="setLang('en')">EN</button>
                </div>
            </div>

            <div class="input-card active" id="wrap-start" onclick="setMode('start')">
                <div class="dot blue"></div>
                <input id="in-start" placeholder="Punto de inicio..." readonly>
            </div>
            <div class="input-card" id="wrap-dest" onclick="setMode('dest')">
                <div class="dot red"></div>
                <input id="in-dest" placeholder="Selecciona destino en mapa..." readonly>
            </div>
        </div>

        <div id="map"></div>
        
        <div id="center-pin">
            <img id="pin-img" src="https://cdn-icons-png.flaticon.com/512/684/684908.png">
        </div>

        <div class="bottom-bar">
            <button class="btn-gps" onclick="geoLocate()"></button>
            <button id="btn-start" class="btn-start" disabled>SELECCIONAR PUNTOS</button>
        </div>
    </div>

    <!-- === 2. VISTA AR (HUD) === -->
    <div id="ar-ui">
        <div class="ar-info-card">
            <div class="ar-distance" id="ar-dist">0m</div>
            <div class="ar-instruction" id="ar-instr">Iniciando sistema...</div>
            <div class="ar-subtext" id="ar-next">Sigue la flecha</div>
        </div>
        <button class="btn-exit" onclick="location.reload()">SALIR / EXIT</button>
    </div>

    <!-- === 3. ESCENA AR 3D === -->
    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        renderer="logarithmicDepthBuffer: true; alpha: true; precision: medium;"
        arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true; displayWidth: 1280; displayHeight: 720;">
        
        <!-- CMARA + HUD FLOTANTE -->
        <a-camera gps-camera="minDistance: 2; gpsMinDistance: 2;" rotation-reader>
            
            <!-- FLECHA 3D MEJORADA (Flota frente a ti) -->
            <a-entity id="arrow-rig" position="0 -0.5 -1.5" rotation="0 0 0">
                <!-- Cuerpo de la flecha -->
                <a-cylinder color="#00ffcc" height="0.4" radius="0.04" rotation="90 0 0" position="0 0 0.15" opacity="0.9"></a-cylinder>
                <!-- Punta de la flecha -->
                <a-cone color="#00ffcc" height="0.3" radius-bottom="0.12" radius-top="0.01" rotation="-90 0 0" position="0 0 -0.15" opacity="0.9"></a-cone>
                <!-- Anillo de brillo -->
                <a-ring color="white" radius-inner="0.18" radius-outer="0.20" rotation="-90 0 0" position="0 0 0" opacity="0.4"
                    animation="property: scale; to: 1.2 1.2 1.2; dir: alternate; dur: 1000; loop: true"></a-ring>
            </a-entity>

        </a-camera>

        <!-- Contenedor para los Puntos Azules en el suelo -->
        <a-entity id="path-container"></a-entity>

    </a-scene>

    <script>
        // === CONFIGURACIN ===
        const MAPBOX_TOKEN = 'pk.eyJ1IjoiYW5keWc5NyIsImEiOiJjbWpwN20zcGoyYjFzM2ZveTIzZ2s5Mm56In0.FsNncSP8DrD6zTXpw0MaEg';
        mapboxgl.accessToken = MAPBOX_TOKEN;

        // TEXTOS Y TRADUCCIONES
        const i18n = {
            es: {
                phStart: "Punto de inicio", phDest: "Destino",
                btnWait: "Selecciona ambos puntos", btnGo: "INICIAR RUTA",
                calc: "Calculando ruta...", arr: "隆Has llegado!", 
                follow: "Sigue la flecha", next: "Siguiente punto",
                voiceOn: "Voz Activada", voiceOff: "Voz Silenciada"
            },
            en: {
                phStart: "Start Point", phDest: "Destination",
                btnWait: "Select both points", btnGo: "START ROUTE",
                calc: "Calculating route...", arr: "You arrived!", 
                follow: "Follow the arrow", next: "Next point",
                voiceOn: "Voice On", voiceOff: "Voice Muted"
            }
        };

        // ESTADO GLOBAL
        let state = {
            lang: 'es',
            voice: true,
            mode: 'start',
            start: null,
            dest: null,
            route: [],
            step: 0,
            navigating: false
        };

        // UI REFERENCES
        const ui = {
            mapView: document.getElementById('map-view'),
            arUI: document.getElementById('ar-ui'),
            inStart: document.getElementById('in-start'),
            inDest: document.getElementById('in-dest'),
            wrapStart: document.getElementById('wrap-start'),
            wrapDest: document.getElementById('wrap-dest'),
            pinImg: document.getElementById('pin-img'),
            btnStart: document.getElementById('btn-start'),
            arDist: document.getElementById('ar-dist'),
            arInstr: document.getElementById('ar-instr'),
            arNext: document.getElementById('ar-next'),
            arrowRig: document.getElementById('arrow-rig'),
            pathCont: document.getElementById('path-container'),
            btnVoice: document.getElementById('btn-voice')
        };

        // --- 1. INICIALIZAR MAPA ---
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [-109.72148, 23.10468],
            zoom: 14,
            attributionControl: false
        });

        // Geolocalizaci贸n inicial
        function geoLocate() {
            if(!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition(pos => {
                const c = [pos.coords.longitude, pos.coords.latitude];
                map.flyTo({ center: c, zoom: 16 });
                if(state.mode === 'start') {
                    state.start = c;
                    ui.inStart.value = " Mi GPS";
                    checkReady();
                }
            });
        }
        geoLocate(); // Ejecutar al inicio

        // Interacci贸n del Pin
        map.on('movestart', () => document.getElementById('center-pin').classList.add('pin-hover'));
        map.on('moveend', async () => {
            document.getElementById('center-pin').classList.remove('pin-hover');
            const c = map.getCenter();
            const coords = [c.lng, c.lat];
            const address = await getAddress(coords);

            if(state.mode === 'start') {
                state.start = coords;
                ui.inStart.value = address;
            } else {
                state.dest = coords;
                ui.inDest.value = address;
            }
            checkReady();
        });

        async function getAddress(coords) {
            try {
                const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${coords[0]},${coords[1]}.json?types=address,poi&access_token=${MAPBOX_TOKEN}`;
                const res = await fetch(url);
                const data = await res.json();
                return data.features[0]?.text || `${coords[1].toFixed(4)}, ${coords[0].toFixed(4)}`;
            } catch { return "Coordenadas seleccionadas"; }
        }

        // --- 2. CONTROLES DE UI (Idioma, Voz, Modo) ---
        window.setMode = (m) => {
            state.mode = m;
            if(m === 'start') {
                ui.wrapStart.classList.add('active');
                ui.wrapDest.classList.remove('active');
                ui.pinImg.style.filter = "hue-rotate(200deg)"; // Azul
            } else {
                ui.wrapStart.classList.remove('active');
                ui.wrapDest.classList.add('active');
                ui.pinImg.style.filter = "none"; // Rojo
            }
        };

        window.setLang = (l) => {
            state.lang = l;
            document.getElementById('lang-es').classList.toggle('active', l==='es');
            document.getElementById('lang-en').classList.toggle('active', l==='en');
            
            // Actualizar textos visibles
            ui.inStart.placeholder = i18n[l].phStart;
            ui.inDest.placeholder = i18n[l].phDest;
            ui.arNext.innerText = i18n[l].next;
            checkReady();
        };

        window.toggleVoice = () => {
            state.voice = !state.voice;
            ui.btnVoice.classList.toggle('active', state.voice);
            ui.btnVoice.innerText = state.voice ? "" : "";
            const msg = state.voice ? i18n[state.lang].voiceOn : i18n[state.lang].voiceOff;
            // Feedback visual breve (opcional) o sonoro
            if(state.voice) speak(msg);
            else window.speechSynthesis.cancel();
        };

        function checkReady() {
            const txt = i18n[state.lang];
            if(state.start && state.dest) {
                ui.btnStart.disabled = false;
                ui.btnStart.classList.add('ready');
                ui.btnStart.innerText = txt.btnGo;
            } else {
                ui.btnStart.disabled = true;
                ui.btnStart.classList.remove('ready');
                ui.btnStart.innerText = txt.btnWait;
            }
        }

        // --- 3. INICIAR RUTA Y AR ---
        ui.btnStart.addEventListener('click', async () => {
            ui.btnStart.innerText = i18n[state.lang].calc;
            
            const url = `https://api.mapbox.com/directions/v5/mapbox/walking/${state.start[0]},${state.start[1]};${state.dest[0]},${state.dest[1]}?steps=true&geometries=geojson&access_token=${MAPBOX_TOKEN}`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                if(!data.routes.length) return alert("Ruta no encontrada");

                state.route = data.routes[0].geometry.coordinates;
                state.step = 0;
                
                // CAMBIO DE VISTA
                ui.mapView.style.display = 'none';
                ui.arUI.style.display = 'block';
                state.navigating = true;

                // Renderizar AR
                renderPath(state.route);
                
                // Mensaje inicial
                speak(i18n[state.lang].calc);
                
                // Iniciar Loop
                startNavigationLoop();

            } catch(e) {
                console.error(e);
                alert("Error de conexi贸n");
                checkReady();
            }
        });

        // --- 4. RENDERIZADO VISUAL (FLECHA + PUNTOS AZULES) ---
        function renderPath(path) {
            ui.pathCont.innerHTML = ''; // Limpiar

            path.forEach((c, i) => {
                // Dibujar puntos azules cada 3 metros aprox (para no saturar)
                if(i % 3 !== 0) return;

                const ent = document.createElement('a-entity');
                ent.setAttribute('gps-new-entity-place', `latitude: ${c[1]}; longitude: ${c[0]}`);

                // Disco Azul en el suelo
                const disc = document.createElement('a-cylinder');
                disc.setAttribute('radius', '0.3');
                disc.setAttribute('height', '0.1');
                disc.setAttribute('color', '#00BFFF'); // Azul Ruta
                disc.setAttribute('opacity', '0.8');
                disc.setAttribute('position', '0 0 0'); // Suelo

                ent.appendChild(disc);
                ui.pathCont.appendChild(ent);
            });
        }

        // --- 5. LGICA DE NAVEGACIN ---
        function startNavigationLoop() {
            setInterval(() => {
                if(!state.navigating) return;

                navigator.geolocation.getCurrentPosition(pos => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    
                    if(state.step >= state.route.length) {
                        endNavigation();
                        return;
                    }

                    const target = state.route[state.step];
                    
                    // 1. Distancia
                    const dist = getDist(lat, lon, target[1], target[0]);
                    ui.arDist.innerText = Math.round(dist) + "m";
                    ui.arInstr.innerText = i18n[state.lang].follow;

                    // 2. Rotaci贸n Flecha (Bearing)
                    const bearing = getBearing(lat, lon, target[1], target[0]);
                    // Truco visual para la flecha 3D: rotar en Y negativo
                    const rad = bearing * (Math.PI / 180);
                    ui.arrowRig.object3D.rotation.y = -rad;

                    // 3. Avanzar paso
                    if(dist < 10) {
                        state.step++;
                        // Sonido leve de checkpoint (opcional)
                    }

                }, null, { enableHighAccuracy: true });
            }, 500);
        }

        function endNavigation() {
            ui.arDist.innerText = "0m";
            ui.arInstr.innerText = i18n[state.lang].arr;
            speak(i18n[state.lang].arr);
            state.navigating = false;
        }

        // --- UTILIDADES ---
        function speak(text) {
            if(!state.voice) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = state.lang === 'es' ? 'es-MX' : 'en-US';
            window.speechSynthesis.speak(u);
        }

        function getDist(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const dLat = (lat2-lat1) * Math.PI/180;
            const dLon = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function getBearing(lat1, lon1, lat2, lon2) {
            const toRad = d => d * Math.PI / 180;
            const toDeg = r => r * 180 / Math.PI;
            const y = Math.sin(toRad(lon2 - lon1)) * Math.cos(toRad(lat2));
            const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) - Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(toRad(lon2 - lon1));
            return (toDeg(Math.atan2(y, x)) + 360) % 360;
        }
        
        // Init
        setMode('start');

    </script>
</body>
</html>
