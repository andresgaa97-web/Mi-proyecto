<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Navigation Pro - Map Picker</title>
    
    <!-- LIBRER√çAS A-FRAME y AR.JS -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js'></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>

    <!-- MAPBOX GL JS (MAPA INTERACTIVO) -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; font-family: sans-serif; height: 100%; }
        
        /* Contenedores de vistas */
        #ar-view, #map-view {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
        }
        #map-view { display: none; background-color: #eee; } /* Inicialmente oculto */

        /* UI SUPERIOR (Compartido entre vistas o adaptado) */
        .ui-container-top {
            position: absolute;
            top: 0; left: 0; width: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            padding: 15px 0 10px 0;
            z-index: 999;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .row { display: flex; gap: 10px; justify-content: center; width: 95%; }
        input {
            padding: 12px; border-radius: 8px; border: none; width: 65%; font-size: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); outline: none;
        }
        select {
            padding: 10px; border-radius: 8px; border: none; background: white; font-weight: bold;
        }
        #gps-status {
            font-size: 11px; color: #00ff00; text-shadow: 1px 1px 2px black;
        }

        /* HUD DE INSTRUCCIONES (Solo en vista AR) */
        #instruction-panel {
            position: absolute;
            top: 100px; /* Ajustado por la UI superior m√°s grande */
            left: 5%; width: 90%;
            background: rgba(20, 20, 20, 0.9);
            color: #fff; padding: 15px; border-radius: 12px; text-align: center;
            display: none; z-index: 998; border-left: 6px solid #ffee00;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        #instruction-text { font-size: 1.3rem; font-weight: 800; text-transform: uppercase; }
        #distance-text { font-size: 1rem; color: #ffee00; margin-top: 5px; font-weight: bold; }

        /* UI INFERIOR (Compartido entre vistas o adaptado) */
        .ui-container-bottom {
            position: absolute;
            bottom: 30px; width: 100%;
            display: flex; justify-content: center; gap: 20px;
            z-index: 999;
        }
        .btn {
            border: none; border-radius: 50px; color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); cursor: pointer;
            transition: transform 0.1s; font-weight: bold;
        }
        .btn:active { transform: scale(0.90); }
        .btn-main { 
            padding: 15px 40px; font-size: 18px; 
            background: linear-gradient(45deg, #28a745, #218838);
        }
        .btn-voice { 
            width: 60px; height: 60px; font-size: 24px; 
            background: #333; display: flex; align-items: center; justify-content: center;
        }

        /* ESTILOS ESPEC√çFICOS DEL MAPA */
        #map {
            position: absolute;
            top: 0; bottom: 0; width: 100%;
        }
        #map-controls {
            position: absolute;
            top: 10px; left: 0; width: 100%;
            z-index: 1000;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            padding: 10px 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }
        #map-actions {
            position: absolute;
            bottom: 20px; width: 100%;
            z-index: 1000;
            display: flex; justify-content: center; gap: 10px;
        }
        #map-actions .btn {
            background-color: #007bff; /* Azul Mapbox */
            padding: 12px 25px;
            font-size: 16px;
        }
        #map-actions .btn.disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        #map-selector-label {
            color: white; font-weight: bold; font-size: 1.1em;
            text-shadow: 1px 1px 2px black;
        }

        a-scene { display: block; width: 100%; height: 100%; }
    </style>
</head>

<body>

    <!-- VISTA AR -->
    <div id="ar-view">
        <div class="ui-container-top">
            <div class="row" style="justify-content: space-between; align-items: center;">
                <div id="gps-status">GPS: Esperando se√±al...</div>
                <select id="lang-select-ar">
                    <option value="es">üá™üá∏ Espa√±ol</option>
                    <option value="en">üá∫üá∏ English</option>
                </select>
            </div>
        </div>

        <div id="instruction-panel">
            <div id="instruction-text">--</div>
            <div id="distance-text">-- m</div>
        </div>

        <div class="ui-container-bottom">
            <button id="btn-open-map" class="btn btn-main">üó∫Ô∏è Seleccionar Ruta</button>
            <button id="btn-voice-ar" class="btn btn-voice">üîä</button>
        </div>

        <a-scene
            vr-mode-ui="enabled: false"
            renderer="logarithmicDepthBuffer: true; alpha: true;" 
            embedded
            arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;">
            
            <a-camera gps-camera="minDistance: 3; gpsMinDistance: 3;" rotation-reader></a-camera>
            <a-entity id="route-container"></a-entity>
        </a-scene>
    </div>

    <!-- VISTA MAPA -->
    <div id="map-view">
        <div id="map"></div>
        <div id="map-controls">
            <div class="row">
                <input type="text" id="start-input" placeholder="Ubicaci√≥n de inicio (ej: Mi casa)">
                <button id="btn-use-current-loc" class="btn" style="background-color: #6f42c1; padding: 10px 15px;">üìç Mi GPS</button>
            </div>
            <div class="row">
                <input type="text" id="destination-input-map" placeholder="Ubicaci√≥n de destino (ej: Oxxo)">
            </div>
            <div class="row" style="margin-top: 10px;">
                <div id="map-selector-label">Haga clic en el mapa para seleccionar</div>
            </div>
        </div>

        <div id="map-actions">
            <button id="btn-set-start" class="btn">Establecer Inicio</button>
            <button id="btn-set-destination" class="btn">Establecer Destino</button>
            <button id="btn-confirm-route" class="btn disabled">Confirmar Ruta</button>
            <button id="btn-back-to-ar" class="btn" style="background-color: #dc3545;">Volver</button>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN ---
        const MAPBOX_TOKEN = 'pk.eyJ1IjoiYW5keWc5NyIsImEiOiJjbWpwN20zcGoyYjFzM2ZveTIzZ2s5Mm56In0.FsNncSP8DrD6zTXpw0MaEg';
        mapboxgl.accessToken = MAPBOX_TOKEN; // ¬°Importante para Mapbox GL JS!
        
        let state = {
            lang: 'es',
            voice: true,
            currentGpsLoc: null, // [lon, lat] del GPS del dispositivo
            startCoords: null,   // [lon, lat] seleccionado en el mapa
            destCoords: null,    // [lon, lat] seleccionado en el mapa
            startAddress: '',
            destAddress: '',
            navigating: false,
            steps: [],
            mapViewActive: false,
            mapMode: 'none' // 'none', 'selecting-start', 'selecting-dest'
        };

        const texts = {
            es: {
                wait: "Esperando GPS (Sal afuera)...",
                calc: "Calculando ruta...",
                errorGeo: "Lugar no encontrado.",
                startNav: "INICIAR",
                arrived: "¬°Has llegado!",
                voiceOn: "üîä", voiceOff: "üîá",
                placeholderStart: "Ubicaci√≥n de inicio (ej: Mi casa)",
                placeholderDest: "Ubicaci√≥n de destino (ej: Oxxo)",
                openMap: "üó∫Ô∏è Seleccionar Ruta",
                useCurrentLoc: "üìç Mi GPS",
                setStart: "Establecer Inicio",
                setDest: "Establecer Destino",
                confirmRoute: "Confirmar Ruta",
                back: "Volver",
                selectStartMap: "Haga clic en el mapa para seleccionar el INICIO",
                selectDestMap: "Haga clic en el mapa para seleccionar el DESTINO",
                mapInstruction: "Haga clic en el mapa o escriba la direcci√≥n"
            },
            en: {
                wait: "Waiting for GPS...",
                calc: "Calculating route...",
                errorGeo: "Location not found.",
                startNav: "START",
                arrived: "You arrived!",
                voiceOn: "üîä", voiceOff: "üîá",
                placeholderStart: "Start location (e.g., My home)",
                placeholderDest: "Destination (e.g., Starbucks)",
                openMap: "üó∫Ô∏è Select Route",
                useCurrentLoc: "üìç My GPS",
                setStart: "Set Start",
                setDest: "Set Destination",
                confirmRoute: "Confirm Route",
                back: "Back",
                selectStartMap: "Click on map to select START",
                selectDestMap: "Click on map to select DESTINATION",
                mapInstruction: "Click on map or type address"
            }
        };

        const ui = {
            // AR View
            arView: document.getElementById('ar-view'),
            gpsStatus: document.getElementById('gps-status'),
            langSelectAr: document.getElementById('lang-select-ar'),
            instructionPanel: document.getElementById('instruction-panel'),
            instructionText: document.getElementById('instruction-text'),
            distanceText: document.getElementById('distance-text'),
            btnOpenMap: document.getElementById('btn-open-map'),
            btnVoiceAr: document.getElementById('btn-voice-ar'),
            routeContainer: document.getElementById('route-container'),

            // Map View
            mapView: document.getElementById('map-view'),
            mapDiv: document.getElementById('map'),
            startInput: document.getElementById('start-input'),
            destinationInputMap: document.getElementById('destination-input-map'),
            btnUseCurrentLoc: document.getElementById('btn-use-current-loc'),
            btnSetStart: document.getElementById('btn-set-start'),
            btnSetDestination: document.getElementById('btn-set-destination'),
            btnConfirmRoute: document.getElementById('btn-confirm-route'),
            btnBackToAr: document.getElementById('btn-back-to-ar'),
            mapSelectorLabel: document.getElementById('map-selector-label')
        };

        // --- MAPBOX MAP INSTANCE & MARKERS ---
        let map;
        let startMarker;
        let destMarker;

        function initMap() {
            map = new mapboxgl.Map({
                container: ui.mapDiv,
                style: 'mapbox://styles/mapbox/streets-v11',
                center: [-109.72148, 23.10468], // Default center (Mexico/Baja California)
                zoom: 12
            });

            map.addControl(new mapboxgl.NavigationControl(), 'top-left');

            startMarker = new mapboxgl.Marker({ color: 'red', draggable: true })
                .setLngLat([0,0]) // default to 0,0
                .addTo(map)
                .on('dragend', onMarkerDragEnd.bind(null, 'start'));

            destMarker = new mapboxgl.Marker({ color: 'blue', draggable: true })
                .setLngLat([0,0])
                .addTo(map)
                .on('dragend', onMarkerDragEnd.bind(null, 'dest'));
            
            // Ocultar marcadores inicialmente
            startMarker.getElement().style.display = 'none';
            destMarker.getElement().style.display = 'none';


            map.on('click', onMapClick);
        }

        async function onMarkerDragEnd(type) {
            const marker = (type === 'start') ? startMarker : destMarker;
            const lngLat = marker.getLngLat();
            const coords = [lngLat.lng, lngLat.lat];
            await reverseGeocode(coords, type);
            updateMapUI();
        }

        async function onMapClick(e) {
            const coords = [e.lngLat.lng, e.lngLat.lat];
            if (state.mapMode === 'selecting-start') {
                state.startCoords = coords;
                startMarker.setLngLat(coords).getElement().style.display = 'block';
                await reverseGeocode(coords, 'start');
                state.mapMode = 'none';
            } else if (state.mapMode === 'selecting-dest') {
                state.destCoords = coords;
                destMarker.setLngLat(coords).getElement().style.display = 'block';
                await reverseGeocode(coords, 'dest');
                state.mapMode = 'none';
            }
            updateMapUI();
        }

        // --- GEOCODING (Direcci√≥n -> Coordenadas) ---
        async function geocodeAddress(query, type) {
            const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${MAPBOX_TOKEN}`;
            const res = await fetch(url);
            const data = await res.json();
            if (data.features && data.features.length) {
                const coords = data.features[0].center; // [lon, lat]
                if (type === 'start') {
                    state.startCoords = coords;
                    state.startAddress = data.features[0].place_name;
                    startMarker.setLngLat(coords).getElement().style.display = 'block';
                } else {
                    state.destCoords = coords;
                    state.destAddress = data.features[0].place_name;
                    destMarker.setLngLat(coords).getElement().style.display = 'block';
                }
                map.flyTo({ center: coords, zoom: 14 });
            } else {
                alert(texts[state.lang].errorGeo);
            }
            updateMapUI();
        }

        // --- REVERSE GEOCODING (Coordenadas -> Direcci√≥n) ---
        async function reverseGeocode(coords, type) {
            const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${coords[0]},${coords[1]}.json?access_token=${MAPBOX_TOKEN}`;
            const res = await fetch(url);
            const data = await res.json();
            if (data.features && data.features.length) {
                if (type === 'start') {
                    state.startAddress = data.features[0].place_name;
                    ui.startInput.value = state.startAddress;
                } else {
                    state.destAddress = data.features[0].place_name;
                    ui.destinationInputMap.value = state.destAddress;
                }
            } else {
                if (type === 'start') ui.startInput.value = `(${coords[1].toFixed(4)}, ${coords[0].toFixed(4)})`;
                else ui.destinationInputMap.value = `(${coords[1].toFixed(4)}, ${coords[0].toFixed(4)})`;
            }
        }

        // --- IDIOMA ---
        ui.langSelectAr.addEventListener('change', (e) => {
            state.lang = e.target.value;
            updateUI();
        });

        function updateTexts() {
            const t = texts[state.lang];
            ui.btnOpenMap.innerText = t.openMap;
            ui.btnVoiceAr.innerText = state.voice ? t.voiceOn : t.voiceOff;
            ui.startInput.placeholder = t.placeholderStart;
            ui.destinationInputMap.placeholder = t.placeholderDest;
            ui.btnUseCurrentLoc.innerText = t.useCurrentLoc;
            ui.btnSetStart.innerText = t.setStart;
            ui.btnSetDestination.innerText = t.setDest;
            ui.btnConfirmRoute.innerText = t.confirmRoute;
            ui.btnBackToAr.innerText = t.back;
            ui.mapSelectorLabel.innerText = t.mapInstruction;
        }

        // --- GESTI√ìN DE VISTAS (AR vs MAPA) y UI ---
        function updateUI() {
            updateTexts(); // Actualizar textos por idioma

            ui.arView.style.display = state.mapViewActive ? 'none' : 'block';
            ui.mapView.style.display = state.mapViewActive ? 'block' : 'none';

            if (state.mapViewActive) {
                map.resize(); // Refrescar mapa si se redimensiona
                // Actualizar label de instrucci√≥n del mapa
                if (state.mapMode === 'selecting-start') ui.mapSelectorLabel.innerText = texts[state.lang].selectStartMap;
                else if (state.mapMode === 'selecting-dest') ui.mapSelectorLabel.innerText = texts[state.lang].selectDestMap;
                else ui.mapSelectorLabel.innerText = texts[state.lang].mapInstruction;

                // Habilitar/deshabilitar bot√≥n Confirmar Ruta
                ui.btnConfirmRoute.classList.toggle('disabled', !(state.startCoords && state.destCoords));
            } else {
                // En vista AR, actualizar estado de voz
                ui.btnVoiceAr.innerText = state.voice ? texts[state.lang].voiceOn : texts[state.lang].voiceOff;
                // Si ya hay una ruta, el bot√≥n principal en AR deber√≠a ser "Reiniciar" o similar
                if (state.navigating) {
                    ui.btnOpenMap.innerText = "üîÑ " + texts[state.lang].startNav; // O un texto de reiniciar
                    ui.instructionPanel.style.display = 'block';
                } else {
                    ui.btnOpenMap.innerText = texts[state.lang].openMap;
                    ui.instructionPanel.style.display = 'none';
                }
            }
        }

        // --- GPS (General para el dispositivo) ---
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(pos => {
                state.currentGpsLoc = [pos.coords.longitude, pos.coords.latitude];
                ui.gpsStatus.innerText = `GPS: ${state.currentGpsLoc[1].toFixed(5)}, ${state.currentGpsLoc[0].toFixed(5)}`;
                ui.gpsStatus.style.color = '#00ff00';

                // Centrar mapa si es la primera vez que se obtiene el GPS
                if (!map.isMoving() && !startMarker.getElement().style.display && !destMarker.getElement().style.display) {
                    map.flyTo({ center: state.currentGpsLoc, zoom: 14 });
                }
            }, err => {
                ui.gpsStatus.innerText = "Error GPS: " + err.message;
                ui.gpsStatus.style.color = 'red';
            }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
        } else {
            alert("Navegador no compatible.");
        }

        // --- EVENT LISTENERS MAPA ---
        ui.btnOpenMap.addEventListener('click', () => {
            state.mapViewActive = true;
            if (!map) initMap(); // Inicializar mapa la primera vez que se abre
            updateUI();
        });
        ui.btnBackToAr.addEventListener('click', () => {
            state.mapViewActive = false;
            updateUI();
        });

        ui.startInput.addEventListener('change', () => geocodeAddress(ui.startInput.value, 'start'));
        ui.destinationInputMap.addEventListener('change', () => geocodeAddress(ui.destinationInputMap.value, 'dest'));

        ui.btnUseCurrentLoc.addEventListener('click', async () => {
            if (!state.currentGpsLoc) { alert(texts[state.lang].wait); return; }
            state.startCoords = state.currentGpsLoc;
            startMarker.setLngLat(state.currentGpsLoc).getElement().style.display = 'block';
            await reverseGeocode(state.currentGpsLoc, 'start');
            map.flyTo({ center: state.currentGpsLoc, zoom: 15 });
            updateMapUI();
        });

        ui.btnSetStart.addEventListener('click', () => {
            state.mapMode = 'selecting-start';
            updateMapUI();
            ui.mapSelectorLabel.innerText = texts[state.lang].selectStartMap;
        });
        ui.btnSetDestination.addEventListener('click', () => {
            state.mapMode = 'selecting-dest';
            updateMapUI();
            ui.mapSelectorLabel.innerText = texts[state.lang].selectDestMap;
        });

        ui.btnConfirmRoute.addEventListener('click', () => {
            if (state.startCoords && state.destCoords) {
                getRoute(state.startCoords, state.destCoords);
                state.mapViewActive = false; // Volver a vista AR
                state.navigating = true;
                updateUI();
            } else {
                alert(texts[state.lang].mapInstruction); // Pedir seleccionar ambos
            }
        });


        // --- OBTENER RUTA (DESDE MAPBOX) ---
        async function getRoute(start, end) {
            const url = `https://api.mapbox.com/directions/v5/mapbox/walking/${start[0]},${start[1]};${end[0]},${end[1]}?steps=true&geometries=geojson&overview=full&access_token=${MAPBOX_TOKEN}`;
            const res = await fetch(url);
            const data = await res.json();
            
            if (data.routes && data.routes[0]) {
                const route = data.routes[0];
                state.steps = route.legs[0].steps;
                
                ui.routeContainer.innerHTML = ''; // Limpiar AR antiguo
                
                drawContinuousPath(route.geometry.coordinates);
                drawTurnSignals(state.steps);

                ui.instructionPanel.style.display = 'block';
                
                monitorProgress();
                speak(`${texts[state.lang].startNav}. ${Math.round(route.distance)} meters.`);
            } else {
                alert(texts[state.lang].errorGeo);
                state.navigating = false;
                updateUI();
            }
        }

        // --- DIBUJO DE FLECHAS CONTINUAS ---
        function drawContinuousPath(coords) {
            for (let i = 0; i < coords.length - 1; i++) {
                if (i % 2 !== 0) continue; 

                const curr = coords[i];
                const next = coords[i+1];

                const angle = calculateBearing(curr[1], curr[0], next[1], next[0]);

                const entity = document.createElement('a-entity');
                entity.setAttribute('gps-new-entity-place', `latitude: ${curr[1]}; longitude: ${curr[0]}`);

                const arrow = document.createElement('a-cone');
                arrow.setAttribute('radius-bottom', '0.2');  
                arrow.setAttribute('radius-top', '0.01');    
                arrow.setAttribute('height', '0.8');         
                arrow.setAttribute('material', 'color: #ffee00; opacity: 0.9;'); 
                
                entity.setAttribute('rotation', `0 ${angle} 0`); 
                arrow.setAttribute('rotation', '-90 0 0'); 
                arrow.setAttribute('position', '0 -1.5 0'); 

                entity.appendChild(arrow);
                ui.routeContainer.appendChild(entity);
            }
        }

        // --- MATEM√ÅTICAS: CALCULAR RUMBO (BEARING) ---
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const toRad = (deg) => deg * Math.PI / 180;
            const toDeg = (rad) => rad * 180 / Math.PI;

            const œÜ1 = toRad(lat1);
            const œÜ2 = toRad(lat2);
            const ŒîŒª = toRad(lon2 - lon1);

            const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
            const x = Math.cos(œÜ1) * Math.sin(œÜ2) -
                      Math.sin(œÜ1) * Math.cos(œÜ2) * Math.cos(ŒîŒª);
            
            let Œ∏ = Math.atan2(y, x);
            let bearing = (toDeg(Œ∏) + 360) % 360;
            
            return -bearing; 
        }

        // --- DIBUJO DE SE√ëALES DE GIRO (HUD FLOTANTE) ---
        function drawTurnSignals(steps) {
            steps.forEach(step => {
                const lat = step.maneuver.location[1];
                const lon = step.maneuver.location[0];
                const instr = step.maneuver.instruction;

                if (step.maneuver.type === 'turn' || step.maneuver.type === 'arrive') {
                    const entity = document.createElement('a-entity');
                    entity.setAttribute('gps-new-entity-place', `latitude: ${lat}; longitude: ${lon}`);

                    const text = document.createElement('a-text');
                    text.setAttribute('value', instr);
                    text.setAttribute('color', '#fff');
                    text.setAttribute('align', 'center');
                    text.setAttribute('scale', '4 4 4');
                    text.setAttribute('position', '0 3 0'); 
                    text.setAttribute('look-at', '[gps-camera]'); 
                    text.setAttribute('background', 'color: black; opacity: 0.6');

                    const post = document.createElement('a-cylinder');
                    post.setAttribute('height', '3');
                    post.setAttribute('radius', '0.1');
                    post.setAttribute('color', 'white');
                    post.setAttribute('position', '0 1.5 0');

                    entity.appendChild(post);
                    entity.appendChild(text);
                    ui.routeContainer.appendChild(entity);
                }
            });
        }

        // --- MONITORIZAR PROGRESO ---
        function monitorProgress() {
            if (!state.navigating || !state.currentGpsLoc) return; // Aseg√∫rate de tener GPS y estar navegando

            const check = setInterval(() => {
                if (!state.navigating || !state.steps.length) { 
                    clearInterval(check); 
                    if (!state.navigating) ui.instructionPanel.style.display = 'none'; // Ocultar panel si no navega
                    return; 
                }
                
                const nextStep = state.steps[0];
                const stepLoc = nextStep.maneuver.location;
                const dist = getDistance(state.currentGpsLoc[1], state.currentGpsLoc[0], stepLoc[1], stepLoc[0]);
                
                ui.instructionText.innerText = nextStep.maneuver.instruction;
                ui.distanceText.innerText = Math.round(dist) + " m";

                if (dist < 10) { // Si estamos a menos de 10 metros del punto de giro
                    speak(nextStep.maneuver.instruction);
                    state.steps.shift(); // Eliminar el paso actual
                    if (state.steps.length === 0) {
                        ui.instructionText.innerText = texts[state.lang].arrived;
                        speak(texts[state.lang].arrived);
                        state.navigating = false;
                        // Opcional: limpiar las flechas AR
                        ui.routeContainer.innerHTML = ''; 
                    }
                }
            }, 2500);
        }

        // Haversine
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const dLat = (lat2-lat1) * Math.PI/180;
            const dLon = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // --- VOZ ---
        ui.btnVoiceAr.addEventListener('click', () => {
            state.voice = !state.voice;
            updateUI(); // Para actualizar el icono
            if(!state.voice) window.speechSynthesis.cancel();
        });

        function speak(txt) {
            if (!state.voice) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(txt);
            u.lang = state.lang === 'es' ? 'es-MX' : 'en-US';
            window.speechSynthesis.speak(u);
        }
        
        // --- INICIALIZACI√ìN ---
        updateUI(); // Llama una vez para configurar el estado inicial de la UI
    </script>
</body>
</html>
