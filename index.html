<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Navegaci칩n WebAR</title>
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <!-- AR.js para geolocalizaci칩n -->
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js'></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
    <style>
        /* Estilos b치sicos para la UI */
        #ui-container {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            z-index: 10;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 5px;
            border-radius: 5px;
            border: none;
            background-color: #333;
            color: white;
        }
        #status {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 5px;
            z-index: 10;
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">

    <!-- UI -->
    <div id="status">Esperando GPS...</div>
    <div id="ui-container">
        <button id="btn-start">Iniciar Ruta</button>
        <button id="btn-voice">游댉 Voz: ON</button>
    </div>

    <!-- Escena AR -->
    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;">
        
        <!-- C치mara con simulaci칩n de GPS -->
        <a-camera gps-camera rotation-reader></a-camera>

        <!-- Aqu칤 inyectaremos las flechas din치micamente -->
        <a-entity id="route-container"></a-entity>

    </a-scene>

    <!-- L칍GICA JAVASCRIPT INTEGRADA -->
    <script>
        // CONFIGURACI칍N
        // IMPORTANTE: He a침adido comillas simples '' al token para evitar errores de sintaxis
        const MAPBOX_TOKEN = 'pk.eyJ1IjoiYW5keWc5NyIsImEiOiJjbWpwN20zcGoyYjFzM2ZveTIzZ2s5Mm56In0.FsNncSP8DrD6zTXpw0MaEg'; 
        
        let vozActiva = true;
        let destino = null; 
        let ubicacionActual = null;

        // ELEMENTOS DOM
        const statusDiv = document.getElementById('status');
        const btnVoice = document.getElementById('btn-voice');
        const btnStart = document.getElementById('btn-start');
        const scene = document.querySelector('a-scene');

        // 1. OBTENER UBICACI칍N ACTUAL (CON MEJORA DE ERRORES)
        if (navigator.geolocation) {
            statusDiv.innerText = "Solicitando permiso GPS...";
            
            const options = {
                enableHighAccuracy: true, // Trata de usar GPS
                timeout: 10000,           // Espera m치ximo 10 seg
                maximumAge: 0
            };

            const success = (position) => {
                ubicacionActual = [position.coords.longitude, position.coords.latitude];
                // Actualizamos el texto con coordenadas reales
                statusDiv.innerText = `GPS: ${ubicacionActual[1].toFixed(5)}, ${ubicacionActual[0].toFixed(5)}`;
                // Habilitamos visualmente el bot칩n
                btnStart.style.backgroundColor = "green"; 
            };

            const error = (err) => {
                console.warn('ERROR(' + err.code + '): ' + err.message);
                let mensaje = "Error GPS: ";
                if (err.code === 1) mensaje += "Permiso denegado. Act칤valo en el navegador.";
                if (err.code === 2) mensaje += "Ubicaci칩n no disponible (Mala se침al).";
                if (err.code === 3) mensaje += "Tiempo de espera agotado.";
                
                statusDiv.innerText = mensaje;
                alert(mensaje); 
            };

            // Primero intentamos obtener la posici칩n una vez r치pido
            navigator.geolocation.getCurrentPosition(success, error, options);
            
            // Luego seguimos rastreando
            navigator.geolocation.watchPosition(success, error, options);

        } else {
            alert("Tu navegador no soporta geolocalizaci칩n.");
        }

        // 2. CONFIGURAR VOZ (Web Speech API)
        btnVoice.addEventListener('click', () => {
            vozActiva = !vozActiva;
            btnVoice.innerText = vozActiva ? "游댉 Voz: ON" : "游댆 Voz: OFF";
            if (!vozActiva) window.speechSynthesis.cancel();
        });

        function hablar(texto) {
            if (!vozActiva) return;
            const utterance = new SpeechSynthesisUtterance(texto);
            utterance.lang = 'es-ES'; // Espa침ol
            window.speechSynthesis.speak(utterance);
        }

        // 3. INICIAR RUTA
        btnStart.addEventListener('click', () => {
            if (!ubicacionActual) {
                alert("Esperando se침al GPS...");
                return;
            }

            // Ejemplo: Destino fijo (PUNTO DE PRUEBA: Plaza Mayor, Madrid)
            // CAMBIA ESTAS COORDENADAS POR UN LUGAR CERCA DE TI PARA PROBAR
            const destinoFicticio = [-3.703790, 40.416775]; 
            
            obtenerRuta(ubicacionActual, destinoFicticio);
        });

        // 4. OBTENER RUTA DE MAPBOX
        async function obtenerRuta(inicio, fin) {
            statusDiv.innerText = "Calculando ruta...";
            hablar("Calculando la ruta hacia tu destino.");

            const url = `https://api.mapbox.com/directions/v5/mapbox/walking/${inicio[0]},${inicio[1]};${fin[0]},${fin[1]}?steps=true&geometries=geojson&access_token=${MAPBOX_TOKEN}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.routes && data.routes.length > 0) {
                    const ruta = data.routes[0];
                    const pasos = ruta.legs[0].steps;
                    const coordenadas = ruta.geometry.coordinates;

                    renderizarCaminoAR(coordenadas);
                    monitorizarPasos(pasos);
                    
                    hablar(`Ruta encontrada. La distancia es de ${Math.round(ruta.distance)} metros.`);
                } else {
                    alert("No se encontr칩 ruta.");
                }
            } catch (e) {
                console.error(e);
                alert("Error conectando con Mapbox. Revisa la consola.");
            }
        }

        // 5. RENDERIZAR OBJETOS EN AR
        function renderizarCaminoAR(coordenadas) {
            const container = document.getElementById('route-container');
            container.innerHTML = ''; // Limpiar anterior

            // Dibujamos una flecha roja cada 3 puntos de la geometr칤a
            coordenadas.forEach((coord, index) => {
                if (index % 3 !== 0) return; 

                const latitude = coord[1];
                const longitude = coord[0];

                // Crear elemento A-Frame
                const flecha = document.createElement('a-entity');
                
                // Atributo clave de AR.js
                flecha.setAttribute('gps-new-entity-place', `latitude: ${latitude}; longitude: ${longitude}`);
                
                // Geometr칤a visual
                flecha.setAttribute('geometry', 'primitive: cone; radiusBottom: 0.5; height: 2');
                flecha.setAttribute('material', 'color: red');
                flecha.setAttribute('position', '0 0 0'); 
                flecha.setAttribute('scale', '1 1 1');

                container.appendChild(flecha);
            });
        }

        // 6. MONITORIZAR PASOS
        function monitorizarPasos(pasos) {
            let pasoActual = 0;
            
            const intervaloCheck = setInterval(() => {
                if (pasoActual >= pasos.length) {
                    clearInterval(intervaloCheck);
                    hablar("Has llegado a tu destino.");
                    return;
                }

                const paso = pasos[pasoActual];
                const destinoPaso = paso.maneuver.location; // [lon, lat]
                
                const dist = distanciaEnMetros(ubicacionActual[1], ubicacionActual[0], destinoPaso[1], destinoPaso[0]);

                statusDiv.innerText = `Siguiente: ${paso.maneuver.instruction} (${Math.round(dist)}m)`;

                // Si estamos cerca del punto de maniobra (15 metros)
                if (dist < 15) {
                    hablar(paso.maneuver.instruction);
                    pasoActual++;
                }
            }, 3000); 
        }

        // Utilidad para calcular distancia
        function distanciaEnMetros(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Radio tierra metros
            const 픥1 = lat1 * Math.PI/180;
            const 픥2 = lat2 * Math.PI/180;
            const 풊픥 = (lat2-lat1) * Math.PI/180;
            const 풊풭 = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(풊픥/2) * Math.sin(풊픥/2) +
                      Math.cos(픥1) * Math.cos(픥2) *
                      Math.sin(풊풭/2) * Math.sin(풊풭/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }
    </script>
</body>
</html>
